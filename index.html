<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lift Tracker Pro - Progressive Web App</title>

    <!-- PWA Meta Tags -->
    <meta name="description" content="Track your powerlifting progress with StrongLifts 5x5 program. Progressive Web App with offline support.">
    <meta name="theme-color" content="#5D5CDE">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Lift Tracker">

    <!-- Manifest -->
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkxpZnQgVHJhY2tlciBQcm8iLAogICJzaG9ydF9uYW1lIjogIkxpZnQgVHJhY2tlciIsCiAgImRlc2NyaXB0aW9uIjogIlRyYWNrIHlvdXIgcG93ZXJsaWZ0aW5nIHByb2dyZXNzIHdpdGggU3Ryb25nTGlmdHMgNXg1IHByb2dyYW0iLAogICJzdGFydF91cmwiOiAiLiIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiI2ZmZmZmZiIsCiAgInRoZW1lX2NvbG9yIjogIiM1RDVDREUiLAogICJvcmllbnRhdGlvbiI6ICJwb3J0cmFpdCIsCiAgImljb25zIjogWwogICAgewogICAgICAic3JjIjogImRhdGE6aW1hZ2Uvc3ZnK3htbCwlM0Nzdmcgd2lkdGg9JzE5MicgaGVpZ2h0PScxOTInIHhtbG5zPSdodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyclM0UlM0NyZWN0IHdpZHRoPScxOTInIGhlaWdodD0nMTkyJyBmaWxsPSclMjM1RDVDREUnLyUzRSUzQ3RleHQgeD0nNTAlMjUnIHk9JzUwJTI1JyBmb250LXNpemU9JzEwMCcgdGV4dC1hbmNob3I9J21pZGRsZScgZG9taW5hbnQtYmFzZWxpbmU9J21pZGRsZSclM0UlRjAlOUYlOEYlOEIlRjAlOUYlOEYlQkIlM0MvdGV4dCUzRSUzQy9zdmclM0UiLAogICAgICAic2l6ZXMiOiAiMTkyeDE5MiIsCiAgICAgICJ0eXBlIjogImltYWdlL3N2Zyt4bWwiLAogICAgICAicHVycG9zZSI6ICJhbnkgbWFza2FibGUiCiAgICB9LAogICAgewogICAgICAic3JjIjogImRhdGE6aW1hZ2Uvc3ZnK3htbCwlM0Nzdmcgd2lkdGg9JzUxMicgaGVpZ2h0PSc1MTInIHhtbG5zPSdodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyclM0UlM0NyZWN0IHdpZHRoPSc1MTInIGhlaWdodD0nNTEyJyBmaWxsPSclMjM1RDVDREUnLyUzRSUzQ3RleHQgeD0nNTAlMjUnIHk9JzUwJTI1JyBmb250LXNpemU9JzI4MCcgdGV4dC1hbmNob3I9J21pZGRsZScgZG9taW5hbnQtYmFzZWxpbmU9J21pZGRsZSclM0UlRjAlOUYlOEYlOEIlRjAlOUYlOEYlQkIlM0MvdGV4dCUzRSUzQy9zdmclM0UiLAogICAgICAic2l6ZXMiOiAiNTEyeDUxMiIsCiAgICAgICJ0eXBlIjogImltYWdlL3N2Zyt4bWwiLAogICAgICAicHVycG9zZSI6ICJhbnkgbWFza2FibGUiCiAgICB9CiAgXQp9">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                    },
                    animation: {
                        'bounce-in': 'bounceIn 0.6s ease-out',
                        'slide-up': 'slideUp 0.4s ease-out',
                        'pulse-soft': 'pulseSoft 2s infinite',
                    }
                }
            }
        }
    </script>
    <style>
        /* Enhanced Animations & Transitions */
        button, input, select, .workout-card {
            transition: all 0.2s ease-in-out;
        }

        .timer-circle {
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
            transition: stroke-dashoffset 1s ease-in-out;
        }
        
        /* Smooth hover animations */
        .workout-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateY(0);
        }
        
        .workout-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        /* Loading spinner animation */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .loading-spinner {
            animation: spin 1s linear infinite;
        }
        
        /* Success animation */
        @keyframes bounceIn {
            0% { transform: scale(0.3) rotate(-30deg); opacity: 0; }
            50% { transform: scale(1.05) rotate(-15deg); }
            70% { transform: scale(0.9) rotate(0deg); }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }
        
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes slideDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .animate-slide-down {
            animation: slideDown 0.5s ease-out;
        }

        @keyframes pulseSoft {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.02); }
        }
        
        /* Progress bar animation */
        @keyframes progressGrow {
            from { width: 0%; }
            to { width: var(--progress-width); }
        }
        
        .progress-bar {
            animation: progressGrow 1s ease-out;
        }
        
        /* Enhanced gradients */
        .gradient-primary {
            background: linear-gradient(135deg, #5D5CDE 0%, #8B5CF6 50%, #A855F7 100%);
        }
        
        .gradient-success {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
        }
        
        .gradient-warning {
            background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
        }
        
        /* Glass morphism effect */
        .glass-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .dark .glass-card {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* Full screen layout for iframe embedding */
        html, body {
            height: 100vh;
            width: 100vw;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            scroll-behavior: smooth;
            /* Prevent pull-to-refresh on mobile devices */
            overscroll-behavior-y: contain;
        }
        
        .full-screen-container {
            width: 100%;
            min-height: 100vh;
        }
        
        /* Remove max-width constraints for full screen */
        .container {
            max-width: none !important;
            width: 100% !important;
            padding-left: 1rem !important;
            padding-right: 1rem !important;
        }
        
        /* Enhanced mobile touch targets - minimum 44x44px for accessibility */
        @media (max-width: 768px) {
            button, .btn, input, select, a.button, [role="button"] {
                min-height: 44px;
                min-width: 44px;
                font-size: 16px;
                padding: 12px 16px;
            }
            
            .grid {
                grid-template-columns: 1fr !important;
            }
            
            .max-w-2xl, .max-w-4xl {
                max-width: 100% !important;
            }
            
            .gap-8 {
                gap: 1rem !important;
            }
            
            /* Better mobile timer */
            .timer-display-mobile {
                font-size: 3rem;
                font-weight: 800;
            }
            
            /* Mobile-optimized set buttons */
            .mobile-set-button {
                width: 3rem !important;
                height: 3rem !important;
                font-size: 0.75rem !important;
            }
            
            .mobile-set-button .font-bold {
                font-size: 1rem !important;
            }
            
            /* Compact mobile spacing */
            .mobile-compact-spacing {
                margin-bottom: 1rem !important;
            }
            
            .mobile-compact-padding {
                padding: 1rem !important;
            }
            
            /* Smaller mobile text */
            .mobile-small-text {
                font-size: 0.875rem !important;
            }
        }
        
        /* Responsive adjustments for small iframes */
        @media (max-height: 600px) {
            .py-8 {
                padding-top: 1rem !important;
                padding-bottom: 1rem !important;
            }
            
            .mb-12 {
                margin-bottom: 1.5rem !important;
            }
            
            .text-4xl {
                font-size: 2rem !important;
            }
            
            .text-3xl {
                font-size: 1.875rem !important;
            }
            
            .space-y-8 > * + * {
                margin-top: 1rem !important;
            }
        }
        
        /* Enhanced modal animations */
        .modal-enter {
            opacity: 0;
            transform: scale(0.9) translateY(-10px);
        }
        
        .modal-enter-active {
            opacity: 1;
            transform: scale(1) translateY(0);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* Enhanced focus states for accessibility */
        .focus-ring:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(93, 92, 222, 0.3);
            border-color: #5D5CDE;
        }
        
        /* Better scrollbars */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        /* Dark mode scrollbars */
        .dark .custom-scrollbar::-webkit-scrollbar-track {
            background: #374151;
        }
        
        .dark .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #6B7280;
        }
        
        .dark .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #9CA3AF;
        }
        
        /* Toast notification styles */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            max-width: 400px;
            padding: 16px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 9999;
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .toast-success {
            background: linear-gradient(135deg, #10B981, #059669);
        }
        
        .toast-error {
            background: linear-gradient(135deg, #EF4444, #DC2626);
        }
        
        .toast-info {
            background: linear-gradient(135deg, #3B82F6, #2563EB);
        }
        
        /* Motivational quote styles */
        .quote-card {
            background: linear-gradient(135deg, rgba(93, 92, 222, 0.1), rgba(139, 92, 246, 0.1));
            border-left: 4px solid #5D5CDE;
        }
        
        /* Achievement badge styles */
        .achievement-badge {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            border: 2px solid #FFD700;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: #8B4513;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(255, 215, 0, 0.3);
        }
    </style>
</head>
<body class="min-h-screen bg-white dark:bg-gray-900 text-gray-900 dark:text-white transition-colors">
    <div class="full-screen-container relative">
        <!-- Data Management Screen (Initial) -->
        <div id="dataScreen" class="absolute top-0 left-0 right-0 px-4 pb-4 text-center">
            <header class="mb-4">
                <!-- Title removed to save space -->
            </header>

            <!-- Motivational Quote Section -->
            <div id="motivationalQuote" class="mb-8 max-w-lg mx-auto quote-card rounded-xl p-4">
                <div class="flex items-center gap-3">
                    <span class="text-2xl">üí°</span>
                    <div class="text-left">
                        <p id="quoteText" class="text-sm font-medium text-gray-700 dark:text-gray-300 italic"></p>
                        <p id="quoteAuthor" class="text-xs text-gray-500 dark:text-gray-400 mt-1"></p>
                    </div>
                </div>
            </div>

            <!-- Primary Action - Start Workout with enhanced design -->
            <div class="mb-8">
                <div class="max-w-lg mx-auto gradient-primary rounded-2xl p-8 text-white shadow-2xl workout-card">
                    <div class="text-5xl mb-4 animate-bounce-in">üèãÔ∏è</div>
                    <h2 class="text-3xl font-bold mb-6">StrongApp 5x5</h2>
                    <button onclick="goToWorkoutSelection()" class="w-full bg-white text-primary py-4 rounded-xl font-bold text-lg hover:bg-gray-100 transition-all duration-300 transform hover:scale-105 shadow-lg">
                        Start Training Session
                    </button>
                    
                    <!-- Quick Stats if available -->
                    <div id="quickStats" class="mt-6 grid grid-cols-3 gap-4 text-center hidden">
                        <div class="bg-white/20 rounded-lg p-3 backdrop-blur-sm">
                            <div id="totalSessions" class="text-xl font-bold">0</div>
                            <div class="text-xs text-purple-100">Sessions</div>
                        </div>
                        <div class="bg-white/20 rounded-lg p-3 backdrop-blur-sm">
                            <div id="currentStreak" class="text-xl font-bold">0</div>
                            <div class="text-xs text-purple-100">Day Streak</div>
                        </div>
                        <div class="bg-white/20 rounded-lg p-3 backdrop-blur-sm">
                            <div id="totalVolume" class="text-xl font-bold">0kg</div>
                            <div class="text-xs text-purple-100">Total Volume</div>
                        </div>
                    </div>
                    
                    <!-- Training Summary Button -->
                    <div id="trainingSummaryButton" class="mt-6">
                        <button onclick="showTrainingSummaryModal()" class="w-full bg-white/20 backdrop-blur-sm text-white py-3 rounded-xl font-semibold hover:bg-white/30 transition-all duration-300 border border-white/30 flex items-center justify-center gap-2">
                            üìä View Training Summary
                        </button>
                    </div>

                    <!-- Progress Charts Button -->
                    <div id="progressChartsButton" class="mt-3">
                        <button onclick="analyzeWorkoutData()" class="w-full bg-white/20 backdrop-blur-sm text-white py-3 rounded-xl font-semibold hover:bg-white/30 transition-all duration-300 border border-white/30 flex items-center justify-center gap-2">
                            üìà View Progress Charts
                        </button>
                    </div>
                </div>
            </div>

            <!-- Latest Workout Display with enhanced design -->
            <div id="latestWorkoutDisplay" class="mb-8 max-w-4xl mx-auto hidden">
                <div class="glass-card rounded-xl p-6 border-2 border-primary/30 backdrop-blur-sm">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-2xl font-bold text-primary flex items-center gap-2">
                            üèÜ Latest Workout
                            <span id="completionBadge" class="achievement-badge text-xs hidden">üíØ</span>
                        </h2>
                        <button onclick="showWorkoutHistoryModal()" class="px-4 py-2 gradient-primary text-white rounded-lg hover:shadow-lg transition-all duration-300 text-sm">
                            View All History
                        </button>
                    </div>
                    <div id="latestWorkoutContent">
                        <!-- Latest workout content will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Clean Navigation Buttons -->
            <div class="max-w-4xl mx-auto mb-8">
                <div class="space-y-4">
                    <!-- Data Management Button -->
                    <button onclick="goToDataManagement()" class="w-full p-6 bg-gradient-to-br from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20 rounded-xl border-2 border-green-200 dark:border-green-700 hover:shadow-xl transition-all duration-300 transform hover:scale-105">
                        <div class="flex items-center justify-between">
                            <div class="text-left">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="text-3xl">üìä</span>
                                    <h3 class="text-lg font-bold text-green-800 dark:text-green-200">Data Management</h3>
                                </div>
                                <p class="text-sm text-green-700 dark:text-green-300">Export, import & backup</p>
                            </div>
                            <svg class="w-6 h-6 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                            </svg>
                        </div>
                    </button>

                    <!-- Settings Button -->
                    <button onclick="goToSettings()" class="w-full p-6 bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 rounded-xl border-2 border-blue-200 dark:border-blue-700 hover:shadow-xl transition-all duration-300 transform hover:scale-105">
                        <div class="flex items-center justify-between">
                            <div class="text-left">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="text-3xl">‚öôÔ∏è</span>
                                    <h3 class="text-lg font-bold text-blue-800 dark:text-blue-200">Settings</h3>
                                </div>
                                <p class="text-sm text-blue-700 dark:text-blue-300">Preferences & options</p>
                            </div>
                            <svg class="w-6 h-6 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                            </svg>
                        </div>
                    </button>
                </div>
            </div>
        </div>

        <!-- Data Management Page (Separate Screen) -->
        <div id="dataManagementPage" class="hidden absolute top-0 left-0 right-0 px-4 pb-4">
            <!-- Header with Back Button -->
            <div class="bg-gradient-to-r from-green-500 to-emerald-600 p-4 mb-6">
                <div class="flex items-center gap-3">
                    <button onclick="goBackToHome()" class="text-white hover:bg-white/20 rounded-lg p-2 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                    </button>
                    <div>
                        <h2 class="text-2xl font-bold text-white">üìä Data Management</h2>
                        <p class="text-sm text-green-100">Manage your workout data</p>
                    </div>
                </div>
            </div>

            <div class="max-w-4xl mx-auto px-4 space-y-6">
                    <div class="grid md:grid-cols-2 gap-6">
                        <!-- Export Options with progress indicators -->
                        <div class="bg-gradient-to-br from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20 rounded-xl p-6 border-2 border-green-200 dark:border-green-700">
                            <h4 class="font-bold text-green-800 dark:text-green-200 mb-4 flex items-center gap-2">
                                üì• Export Options
                                <span class="text-xs bg-green-200 dark:bg-green-800 px-2 py-1 rounded-full">Secure</span>
                            </h4>
                            <div class="space-y-3">
                                <button onclick="exportWorkoutData('json')" class="w-full text-left px-4 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-all duration-300 transform hover:scale-105 text-sm shadow-lg">
                                    üì¶ JSON Backup (Full Data)
                                </button>
                                <button onclick="exportWorkoutData('csv')" class="w-full text-left px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-all duration-300 transform hover:scale-105 text-sm shadow-lg">
                                    üìä CSV Spreadsheet
                                </button>
                            </div>
                            <div class="mt-4 p-3 bg-green-100 dark:bg-green-900/30 rounded-lg">
                                <p id="exportStatusDetailed" class="text-xs text-green-700 dark:text-green-300 flex items-center gap-2">
                                    <span class="w-2 h-2 bg-green-500 rounded-full"></span>
                                    No data to export
                                </p>
                            </div>
                        </div>

                        <!-- Analysis & Tools with enhanced styling -->
                        <div class="bg-gradient-to-br from-orange-50 to-amber-50 dark:from-orange-900/20 dark:to-amber-900/20 rounded-xl p-6 border-2 border-orange-200 dark:border-orange-700">
                            <h4 class="font-bold text-orange-800 dark:text-orange-200 mb-4 flex items-center gap-2">
                                üõ†Ô∏è Tools & Analysis
                                <span class="text-xs bg-orange-200 dark:bg-orange-800 px-2 py-1 rounded-full">Pro</span>
                            </h4>
                            <div class="space-y-3">
                                <button id="analyzeDataBtn" onclick="analyzeWorkoutData()" class="w-full text-left px-4 py-3 gradient-warning text-white rounded-lg hover:shadow-lg transition-all duration-300 transform hover:scale-105 text-sm">
                                    üìä View Progress Charts
                                </button>
                                <button id="personalBestsBtn" onclick="showPersonalBestsModal()" class="w-full text-left px-4 py-3 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition-all duration-300 transform hover:scale-105 text-sm shadow-lg">
                                    üèÜ Personal Records
                                </button>
                                <button onclick="openWorkoutCreator()" class="w-full text-left px-4 py-3 bg-pink-500 text-white rounded-lg hover:bg-pink-600 transition-all duration-300 transform hover:scale-105 text-sm shadow-lg">
                                    üìù Create Workout History
                                </button>
                                <button onclick="importWorkoutData()" class="w-full text-left px-4 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-all duration-300 transform hover:scale-105 text-sm shadow-lg">
                                    üì§ Import Backup File
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Clear All Data Section -->
                    <div class="bg-gradient-to-br from-red-50 to-pink-50 dark:from-red-900/20 dark:to-pink-900/20 rounded-xl p-6 border-2 border-red-200 dark:border-red-700">
                        <h4 class="font-bold text-red-800 dark:text-red-200 mb-4 flex items-center gap-2">
                            üîß Advanced Actions
                            <span class="text-xs bg-red-200 dark:bg-red-800 px-2 py-1 rounded-full">Caution</span>
                        </h4>
                        <div class="space-y-3">
                            <button onclick="checkStorageDiagnostic()" class="w-full text-left px-4 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-all duration-300 text-sm shadow-lg">
                                üîç Check Storage Status
                            </button>
                            <button onclick="clearAllHistory()" class="w-full text-left px-4 py-3 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-all duration-300 text-sm shadow-lg">
                                üóëÔ∏è Clear All Data
                            </button>
                        </div>
                        <div class="mt-4 p-3 bg-red-100 dark:bg-red-900/30 rounded-lg">
                            <p class="text-xs text-red-700 dark:text-red-300 flex items-center gap-2">
                                <span class="text-red-500">‚ö†Ô∏è</span>
                                Actions here are permanent
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Page (Separate Screen) -->
        <div id="settingsPage" class="hidden absolute top-0 left-0 right-0 px-4 pb-4">
            <!-- Header with Back Button -->
            <div class="bg-gradient-to-r from-blue-500 to-indigo-600 p-4 mb-6">
                <div class="flex items-center gap-3">
                    <button onclick="goBackToHome()" class="text-white hover:bg-white/20 rounded-lg p-2 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                    </button>
                    <div>
                        <h2 class="text-2xl font-bold text-white">‚öôÔ∏è Settings</h2>
                        <p class="text-sm text-blue-100">Customize your preferences</p>
                    </div>
                </div>
            </div>

            <div class="max-w-4xl mx-auto px-4 space-y-6">
                <!-- App Settings -->
                <div class="bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 rounded-xl p-6 border-2 border-blue-200 dark:border-blue-700">
                    <h4 class="font-bold text-blue-800 dark:text-blue-200 mb-4 flex items-center gap-2">
                        ‚öôÔ∏è App Settings
                    </h4>
                    <div class="space-y-4">
                        <!-- Weight Units -->
                        <div class="p-4 bg-white dark:bg-gray-700 rounded-lg border-2 border-blue-200 dark:border-blue-600 hover:border-blue-400 transition-colors">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <span class="text-2xl">‚öñÔ∏è</span>
                                    <div>
                                        <span class="font-medium">Weight Units</span>
                                        <p class="text-xs text-gray-500 dark:text-gray-400">Choose your preferred measurement</p>
                                    </div>
                                </div>
                                <div>
                                    <select id="weightUnitsSelect" onchange="changeWeightUnits()" class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-sm focus-ring">
                                        <option value="kg">Kilograms (kg)</option>
                                        <option value="lbs">Pounds (lbs)</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Rest Timer Sound -->
                        <div class="p-4 bg-white dark:bg-gray-700 rounded-lg border-2 border-blue-200 dark:border-blue-600 hover:border-blue-400 transition-colors">
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center gap-3">
                                    <span class="text-2xl">üîî</span>
                                    <div>
                                        <span class="font-medium">Rest Timer Sound</span>
                                        <p class="text-xs text-gray-500 dark:text-gray-400">Play notification when rest time ends</p>
                                    </div>
                                </div>
                                <div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="restTimerSoundToggle" onchange="toggleRestTimerSound()" class="sr-only peer">
                                        <div class="w-11 h-6 bg-gray-300 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-600 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                                    </label>
                                </div>
                            </div>
                            <button onclick="testRestTimerSound()" class="w-full mt-2 px-3 py-2 text-sm bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                                üîä Test Sound
                            </button>
                        </div>

                        <!-- Default Rest Time -->
                        <div class="p-4 bg-white dark:bg-gray-700 rounded-lg border-2 border-blue-200 dark:border-blue-600 hover:border-blue-400 transition-colors">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <span class="text-2xl">‚è±Ô∏è</span>
                                    <div>
                                        <span class="font-medium">Default Rest Time</span>
                                        <p class="text-xs text-gray-500 dark:text-gray-400">Rest between sets</p>
                                    </div>
                                </div>
                                <div>
                                    <select id="globalRestTime" onchange="saveWorkoutSettings()" class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-sm focus-ring">
                                        <option value="120">2 minutes</option>
                                        <option value="180" selected>3 minutes</option>
                                        <option value="240">4 minutes</option>
                                        <option value="300">5 minutes</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Default Sets Per Exercise -->
                        <div class="p-4 bg-white dark:bg-gray-700 rounded-lg border-2 border-blue-200 dark:border-blue-600 hover:border-blue-400 transition-colors">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <span class="text-2xl">üí™</span>
                                    <div>
                                        <span class="font-medium">Default Sets Per Exercise</span>
                                        <p class="text-xs text-gray-500 dark:text-gray-400">Number of sets for each exercise</p>
                                    </div>
                                </div>
                                <div>
                                    <input id="globalSets" type="number" value="5" min="1" max="10" onchange="saveWorkoutSettings()" class="w-20 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-sm text-center focus-ring">
                                </div>
                            </div>
                        </div>

                        <!-- Progressive Overload Increment -->
                        <div id="globalIncrementSetting" class="p-4 bg-white dark:bg-gray-700 rounded-lg border-2 border-blue-200 dark:border-blue-600 hover:border-blue-400 transition-colors hidden">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <span class="text-2xl">üìà</span>
                                    <div>
                                        <span class="font-medium">Progressive Overload</span>
                                        <p class="text-xs text-gray-500 dark:text-gray-400">Auto weight increment</p>
                                    </div>
                                </div>
                                <div>
                                    <select id="globalIncrement" onchange="saveWorkoutSettings()" class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-sm focus-ring">
                                        <option value="0">No increment (0kg)</option>
                                        <option value="2.5">Standard (+2.5kg)</option>
                                        <option value="5">Heavy (+5kg)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <input type="file" id="importFileInput" accept=".json" class="hidden">
        <input type="file" id="analyzeFileInput" accept=".json" class="hidden">

        <!-- Workout Selection Screen - Mobile Optimized -->
        <div id="workoutSelectionScreen" class="absolute top-0 left-0 right-0 text-center hidden h-screen flex flex-col">
            <!-- Header with Back Button -->
            <div class="bg-gradient-to-r from-purple-500 to-pink-600 p-4 mb-6">
                <div class="flex items-center gap-3">
                    <button onclick="goBackToHome()" class="text-white hover:bg-white/20 rounded-lg p-2 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                    </button>
                    <div>
                        <h2 class="text-2xl font-bold text-white">üí™ Choose Your Workout</h2>
                        <p class="text-sm text-purple-100">Select a workout to begin training</p>
                    </div>
                </div>
            </div>

            <!-- Workout Cards Container - Takes remaining space -->
            <div class="flex-1 flex flex-col justify-center px-4 pb-4">
                <div class="space-y-4 max-w-sm mx-auto w-full">
                    <!-- Workout A - Compact Design -->
                    <div class="workout-card bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl p-4 text-white cursor-pointer transform transition-all duration-300 hover:scale-105 active:scale-95" onclick="selectWorkout('A')">
                        <div class="flex items-center gap-4 mb-3">
                            <div class="bg-white/20 rounded-full w-12 h-12 flex items-center justify-center">
                                <span class="text-xl">üèãÔ∏è</span>
                            </div>
                            <div class="text-left flex-1">
                                <h2 class="text-xl font-bold">Workout A</h2>
                                <p class="text-blue-100 text-sm">Upper & Lower Power</p>
                            </div>
                        </div>
                        
                        <div class="flex justify-between text-center mb-4">
                            <div class="flex-1">
                                <div class="text-sm opacity-90">üèãÔ∏è Squats</div>
                            </div>
                            <div class="flex-1">
                                <div class="text-sm opacity-90">üí™ OH Press</div>
                            </div>
                            <div class="flex-1">
                                <div class="text-sm opacity-90">‚ö° Deadlift</div>
                            </div>
                        </div>
                        
                        <div class="bg-white/20 rounded-lg py-2 px-4 text-center">
                            <span class="font-semibold">Start Workout A</span>
                        </div>
                    </div>

                    <!-- Workout B - Compact Design -->
                    <div class="workout-card bg-gradient-to-br from-green-500 to-green-600 rounded-xl p-4 text-white cursor-pointer transform transition-all duration-300 hover:scale-105 active:scale-95" onclick="selectWorkout('B')">
                        <div class="flex items-center gap-4 mb-3">
                            <div class="bg-white/20 rounded-full w-12 h-12 flex items-center justify-center">
                                <span class="text-xl">üî•</span>
                            </div>
                            <div class="text-left flex-1">
                                <h2 class="text-xl font-bold">Workout B</h2>
                                <p class="text-green-100 text-sm">Push & Pull Focus</p>
                            </div>
                        </div>
                        
                        <div class="flex justify-between text-center mb-4">
                            <div class="flex-1">
                                <div class="text-sm opacity-90">üèãÔ∏è Squats</div>
                            </div>
                            <div class="flex-1">
                                <div class="text-sm opacity-90">üî• Bench</div>
                            </div>
                            <div class="flex-1">
                                <div class="text-sm opacity-90">üö£ Rows</div>
                            </div>
                        </div>
                        
                        <div class="bg-white/20 rounded-lg py-2 px-4 text-center">
                            <span class="font-semibold">Start Workout B</span>
                        </div>
                    </div>
                </div>

                <!-- Quick Stats Footer -->
                <div class="mt-6 text-center">
                    <p class="text-sm text-gray-500 dark:text-gray-400">
                        üí° Both workouts follow 5x5 progressive strength training
                    </p>
                </div>
            </div>

            <!-- Workout History Display (on selection screen) -->
            <div id="selectionHistoryDisplay" class="mt-12 hidden">
                <h2 class="text-2xl font-bold text-center mb-6">Workout History</h2>
                <div class="max-w-4xl mx-auto">
                    <div id="selectionHistoryFilters" class="flex justify-center gap-4 mb-6">
                        <button onclick="filterHistory('all')" class="filter-btn active px-4 py-2 rounded-lg bg-primary text-white transition-colors">All</button>
                        <button onclick="filterHistory('A')" class="filter-btn px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-primary hover:text-white transition-colors">Workout A</button>
                        <button onclick="filterHistory('B')" class="filter-btn px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-primary hover:text-white transition-colors">Workout B</button>
                    </div>
                    <div id="selectionHistoryContent" class="space-y-6 max-h-96 overflow-y-auto custom-scrollbar"></div>
                    <div class="text-center mt-4">
                        <button onclick="clearAllHistory()" class="text-sm text-red-500 hover:text-red-600 transition-colors">Clear All History</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Rest of the original code remains the same from setup screen onwards -->
        <!-- Workout Setup Screen -->
        <div id="setupScreen" class="hidden absolute top-0 left-0 right-0 bottom-0 overflow-y-auto">
            <!-- Header with Back Button -->
            <div class="bg-gradient-to-r from-orange-500 to-red-600 p-4 mb-6">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <button onclick="goToWorkoutSelection()" class="text-white hover:bg-white/20 rounded-lg p-2 transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                            </svg>
                        </button>
                        <div>
                            <h2 id="workoutTitle" class="text-2xl font-bold text-white"></h2>
                            <p class="text-sm text-orange-100">Configure your exercises</p>
                        </div>
                    </div>
                    <button onclick="exitWorkout()" class="text-white hover:bg-white/20 rounded-lg px-4 py-2 transition-colors text-sm font-semibold">
                        Exit
                    </button>
                </div>
            </div>

            <div class="px-4 pb-4">

            <!-- Workout Setup Phase -->
            <div id="workoutSetupPhase">
                <div class="max-w-4xl mx-auto">
                    <h3 class="text-2xl font-semibold text-center mb-6">Plan Your Workout</h3>
                    <p class="text-center text-gray-600 dark:text-gray-400 mb-8">Configure each exercise with your target weights and reps</p>

                    <!-- Exercise Tabs Navigation -->
                    <div class="mb-6">
                        <div id="exerciseTabs" class="flex gap-2 overflow-x-auto pb-2">
                            <!-- Tabs will be populated here -->
                        </div>
                    </div>

                    <!-- Exercise Configuration Panels -->
                    <div id="exerciseConfigPanels">
                        <!-- Exercise config panels will be populated here -->
                    </div>

                    <!-- Start Workout Button -->
                    <div class="text-center mt-8">
                        <button onclick="startEntireWorkout()" class="px-8 py-4 gradient-primary text-white text-lg font-semibold rounded-lg hover:shadow-lg transition-all duration-300 transform hover:scale-105">
                            üèãÔ∏è Start Workout
                        </button>
                    </div>
                </div>
            </div>

            <!-- Workout Execution Phase - All Exercises View -->
            <div id="workoutExecutionPhase" class="hidden">
                <!-- Rest Timer - Always visible during workout -->
                <div id="restTimerSection" class="mb-4 p-3 bg-gradient-to-r from-amber-50 to-orange-50 dark:from-amber-900/30 dark:to-orange-900/30 rounded-lg border-2 border-amber-400 dark:border-amber-600 shadow-lg">
                    <div class="flex flex-col items-center justify-center gap-2">
                        <div class="text-xs font-semibold text-gray-700 dark:text-gray-300">‚è±Ô∏è Rest Time</div>
                        <div class="relative inline-block">
                            <svg class="transform -rotate-90" width="80" height="80">
                                <circle cx="40" cy="40" r="35" stroke="#e5e7eb" stroke-width="5" fill="none" class="dark:stroke-gray-700"/>
                                <circle id="restTimerCircle" cx="40" cy="40" r="35" stroke="#f59e0b" stroke-width="5" fill="none"
                                        stroke-linecap="round" style="stroke-dasharray: 219.91; stroke-dashoffset: 0; transition: stroke-dashoffset 1s linear"/>
                            </svg>
                            <div class="absolute inset-0 flex items-center justify-center">
                                <div id="restCountdown" class="text-xl font-bold text-amber-600 dark:text-amber-400">--:--</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab Navigation -->
                <div class="mb-3">
                    <div class="flex bg-gray-200 dark:bg-gray-700 rounded-lg p-1">
                        <button id="execTab" onclick="switchTab('execution')" class="flex-1 px-3 py-2 text-sm font-medium rounded-md transition-colors bg-primary text-white">
                            üèãÔ∏è Execute
                        </button>
                        <button id="detailsTab" onclick="switchTab('details')" class="flex-1 px-3 py-2 text-sm font-medium rounded-md transition-colors text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200">
                            üìã Details
                        </button>
                        <button id="progressTab" onclick="switchTab('progress')" class="flex-1 px-3 py-2 text-sm font-medium rounded-md transition-colors text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200">
                            üìä Progress
                        </button>
                    </div>
                </div>

                <!-- Tab Content -->
                <div id="tabContent">
                    <!-- Exercise Execution Tab -->
                    <div id="executionTabContent" class="tab-panel">
                        <!-- All Exercises with Sets -->
                        <div id="allExercisesContainer" class="space-y-4">
                            <!-- Exercises will be populated here -->
                        </div>

                        <!-- Complete Workout Button -->
                        <div id="completeWorkoutSection" class="hidden text-center mt-6">
                            <button onclick="completeWorkout()" class="px-8 py-3 gradient-primary text-white rounded-lg hover:shadow-lg transition-all duration-300 text-base font-semibold">
                                Complete Workout ‚úì
                            </button>
                        </div>
                    </div>

                    <!-- Exercise Details Tab -->
                    <div id="detailsTabContent" class="tab-panel hidden">
                        <div id="allExercisesDetailsContainer" class="space-y-4">
                            <!-- All exercises with plate loading will be populated here -->
                        </div>
                    </div>

                    <!-- Progress Tab - Full Analytics -->
                    <div id="progressTabContent" class="tab-panel hidden">
                        <!-- Today's Session Summary -->
                        <div class="bg-gradient-to-r from-blue-50 to-purple-50 dark:from-blue-900/20 dark:to-purple-900/20 rounded-lg p-3 mb-4 border-2 border-primary/30">
                            <h5 class="text-sm font-bold text-primary mb-2">üìä Today's Session</h5>
                            <div id="workoutHistory" class="space-y-2 max-h-40 overflow-y-auto custom-scrollbar">
                                <p class="text-xs text-gray-500 dark:text-gray-400 text-center">No completed sets yet</p>
                            </div>
                        </div>

                        <!-- Progress Charts -->
                        <div class="bg-gray-50 dark:bg-gray-900 rounded-xl p-3 mb-3">
                            <div id="workoutTabChartContainer" style="position: relative; height: 250px; width: 100%;">
                                <canvas id="workoutTabProgressChart" style="max-height: 250px;"></canvas>
                            </div>
                        </div>

                        <!-- Chart Controls -->
                        <div class="flex flex-wrap gap-2 justify-center mb-3">
                            <button id="workoutTabWeightBtn" onclick="showWorkoutTabWeightChart()" class="px-3 py-1.5 bg-primary text-white rounded-lg hover:bg-primary/80 transition-colors text-xs font-medium">üìà Weight</button>
                            <button id="workoutTabVolumeBtn" onclick="showWorkoutTabVolumeChart()" class="px-3 py-1.5 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors text-xs font-medium">üìä Volume</button>
                            <button id="workoutTabFrequencyBtn" onclick="showWorkoutTabFrequencyChart()" class="px-3 py-1.5 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors text-xs font-medium">üî¢ Frequency</button>
                            <button id="workoutTabStrengthBtn" onclick="showWorkoutTabStrengthChart()" class="px-3 py-1.5 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors text-xs font-medium">üí™ Strength</button>
                        </div>

                        <!-- Stats Summary -->
                        <div id="workoutTabChartStats" class="grid grid-cols-2 gap-2">
                            <!-- Stats will be populated dynamically -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Workout History -->
        <div id="workoutHistorySection" class="mt-8 bg-gray-50 dark:bg-gray-800 rounded-xl p-6 hidden">
            <h2 class="text-xl font-semibold mb-4">Today's Progress</h2>
            <div id="workoutHistoryMain" class="space-y-4 custom-scrollbar">
                <p class="text-gray-500 dark:text-gray-400 text-center">No completed sets yet</p>
            </div>
        </div>
    </div>
    </div> <!-- Close px-4 pb-4 wrapper -->
    </div> <!-- Close setupScreen -->

    <!-- All the original modals remain the same -->
    <!-- Exercise Complete Modal -->
    <div id="exerciseCompleteModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4 modal-enter-active">
            <div class="text-center">
                <div class="text-4xl mb-4 animate-bounce-in">‚úÖ</div>
                <h3 class="text-lg font-semibold mb-2">Exercise Complete!</h3>
                <p id="exerciseCompleteMessage" class="text-gray-600 dark:text-gray-400 mb-4"></p>
                <button id="continueBtn" class="px-6 py-2 gradient-primary text-white rounded-lg hover:shadow-lg transition-all duration-300">Continue</button>
            </div>
        </div>
    </div>

    <!-- Rest of the modals remain exactly the same as in the original -->
    <!-- ... (all other modals) ... -->

    <script>
        // Enhanced global variables with new features
        let motivationalQuotes = [
            { text: "The only bad workout is the one that didn't happen.", author: "Unknown" },
            { text: "Strength doesn't come from what you can do. It comes from overcoming what you thought you couldn't.", author: "Rikki Rogers" },
            { text: "Success isn't given. It's earned in the gym.", author: "Unknown" },
            { text: "Your body can stand almost anything. It's your mind you have to convince.", author: "Unknown" },
            { text: "Champions train, losers complain.", author: "Unknown" },
            { text: "Don't limit your challenges, challenge your limits.", author: "Unknown" },
            { text: "The iron never lies to you.", author: "Henry Rollins" },
            { text: "Fall seven times, get up eight.", author: "Japanese Proverb" },
            { text: "The barbell is my therapist.", author: "Henry Rollins" },
            { text: "Strength does not come from winning. Your struggles develop your strengths.", author: "Arnold Schwarzenegger" },
            { text: "If something stands between you and your success, move it. Never be denied.", author: "Dwayne \"The Rock\" Johnson" },
            { text: "Discipline is doing what you hate to do, but do it like you love it.", author: "Mike Tyson" },
            { text: "There are no shortcuts--everything is reps, everything is time, everything is effort.", author: "Ray Lewis" },
            { text: "The last three or four reps is what makes the muscle grow. This area of pain divides a champion from someone who is not a champion.", author: "Arnold Schwarzenegger" },
            { text: "The successful warrior is the average man, with laser-like focus.", author: "Bruce Lee" },
            { text: "Don't measure yourself by what you have accomplished, but by what you should have accomplished with your ability.", author: "John Wooden" },
            { text: "Most people give up right before the big break comes. Don't let that person be you.", author: "Michael Boyle" },
            { text: "Strong people are harder to kill than weak people and more useful in general.", author: "Mark Rippetoe" },
            { text: "Champions keep playing until they get it right.", author: "Billie Jean King" },
            { text: "Some people want it to happen, some wish it would happen, others make it happen.", author: "Michael Jordan" },
            { text: "It's not whether you get knocked down; it's whether you get up.", author: "Vince Lombardi" },
            { text: "Fall in love with the process and the results will come.", author: "Eric Thomas" },
            { text: "Strong people are made by opposition like kites that go up against the wind.", author: "Franklin P. Jones" }
        ];

        // Enhanced notification system
        function showToast(message, type = 'info', duration = 3000) {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <div class="flex items-center gap-2">
                    <span class="text-lg">${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è'}</span>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            // Trigger animation
            setTimeout(() => toast.classList.add('show'), 100);
            
            // Remove toast
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => document.body.removeChild(toast), 300);
            }, duration);
        }

        // Enhanced showCustomAlert to use toast system
        function showCustomAlert(message, type = 'info') {
            showToast(message, type);
        }

        // Modal cleanup helper - ensures modals are properly removed from DOM
        function closeModal(modalElement) {
            try {
                if (!modalElement) return;

                // Add exit animation
                modalElement.style.opacity = '0';
                modalElement.style.transition = 'opacity 0.2s ease-out';

                // Remove from DOM after animation
                setTimeout(() => {
                    if (modalElement && modalElement.parentNode) {
                        modalElement.parentNode.removeChild(modalElement);
                        console.log('‚úÖ Modal properly removed from DOM');
                    }
                }, 200);
            } catch (error) {
                console.error('Error closing modal:', error);
                // Fallback: force remove
                if (modalElement && modalElement.parentNode) {
                    modalElement.parentNode.removeChild(modalElement);
                }
            }
        }

        // Clean up all modals (useful for navigation)
        function closeAllModals() {
            try {
                const modals = document.querySelectorAll('.fixed.inset-0.bg-black.bg-opacity-50');
                modals.forEach(modal => closeModal(modal));
                console.log(`‚úÖ Closed ${modals.length} modal(s)`);
            } catch (error) {
                console.error('Error closing all modals:', error);
            }
        }

        // Display random motivational quote
        function displayMotivationalQuote() {
            const quote = motivationalQuotes[Math.floor(Math.random() * motivationalQuotes.length)];
            const quoteText = document.getElementById('quoteText');
            const quoteAuthor = document.getElementById('quoteAuthor');
            if (quoteText) quoteText.textContent = quote.text;
            if (quoteAuthor) quoteAuthor.textContent = `‚Äî ${quote.author}`;
        }

        // Enhanced updateQuickStats function with null checks
        function updateQuickStats() {
            const quickStats = document.getElementById('quickStats');
            const totalSessionsEl = document.getElementById('totalSessions');
            const currentStreakEl = document.getElementById('currentStreak');
            const totalVolumeEl = document.getElementById('totalVolume');
            
            // Exit early if required elements don't exist
            if (!quickStats || !totalSessionsEl || !currentStreakEl || !totalVolumeEl) {
                return;
            }
            
            try {
                if (workoutSessions.length > 0) {
                    quickStats.classList.remove('hidden');
                    
                    // Calculate total volume
                    const totalVolume = workoutSessions.reduce((sum, session) => 
                        sum + session.exercises.reduce((sessionSum, ex) => sessionSum + (ex.weight * ex.reps), 0), 0
                    );
                    
                    // Calculate current streak
                    const streak = calculateCurrentStreak();
                    
                    totalSessionsEl.textContent = workoutSessions.length;
                    currentStreakEl.textContent = streak;
                    totalVolumeEl.textContent = formatWeight(totalVolume, true);
                    
                    // Add animation to stats
                    [totalSessionsEl, currentStreakEl, totalVolumeEl].forEach(el => {
                        if (el) el.classList.add('animate-bounce-in');
                    });
                } else {
                    quickStats.classList.add('hidden');
                }
            } catch (error) {
                console.error('Error in updateQuickStats:', error);
            }
        }

        // Training Summary Modal
        function showTrainingSummaryModal() {
            if (workoutSessions.length === 0) {
                showNoDataSummaryModal();
                return;
            }
            
            const summaryData = calculateTrainingSummary();
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-gradient-to-br from-blue-800 to-blue-900 text-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden border-2 border-blue-400">
                    <div class="p-6 border-b border-blue-600">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <span class="text-3xl">üìà</span>
                                <h2 class="text-2xl font-bold">Training Summary</h2>
                            </div>
                            <button onclick="this.closest('.fixed').remove()" class="text-white/80 hover:text-white text-2xl">√ó</button>
                        </div>
                    </div>
                    
                    <div class="overflow-y-auto max-h-[calc(90vh-120px)] p-6 space-y-6">
                        <!-- Journey Overview -->
                        <div class="flex items-center gap-3 mb-4">
                            <span class="text-2xl">üéØ</span>
                            <div>
                                <h3 class="text-lg font-bold">${summaryData.journeyText}</h3>
                            </div>
                        </div>
                        
                        <!-- Training Metrics -->
                        <div class="space-y-6">
                            <!-- Training Frequency -->
                            <div class="flex items-start gap-4">
                                <span class="text-2xl flex-shrink-0">üí™</span>
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-start justify-between">
                                        <div class="flex-1">
                                            <strong class="text-white block mb-1">Training Frequency:</strong>
                                            <span class="text-blue-100">You've averaged <strong>${summaryData.avgFrequency} workouts per week</strong> - ${summaryData.frequencyMessage}</span>
                                        </div>
                                        <span class="text-2xl text-orange-300 ml-3 flex-shrink-0">${summaryData.frequencyIcon}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Workout Completion -->
                            <div class="flex items-start gap-4">
                                <span class="text-2xl flex-shrink-0">‚úÖ</span>
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-start justify-between">
                                        <div class="flex-1">
                                            <strong class="text-white block mb-1">Workout Completion:</strong>
                                            <span class="text-blue-100"><strong>${summaryData.completionRate}%</strong> of your workouts were completed - ${summaryData.completionMessage}</span>
                                        </div>
                                        <span class="text-2xl text-yellow-300 ml-3 flex-shrink-0">${summaryData.completionIcon}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Most Trained Exercise -->
                            <div class="flex items-start gap-4">
                                <span class="text-2xl flex-shrink-0">üèãÔ∏è</span>
                                <div class="flex-1 min-w-0">
                                    <strong class="text-white block mb-1">Most Trained:</strong>
                                    <span class="text-blue-100"><strong>${summaryData.mostTrainedExercise}</strong> appears in <strong>${summaryData.mostTrainedCount} sessions</strong> - clearly a favorite!</span>
                                </div>
                            </div>
                            
                            <!-- Highest Intensity -->
                            <div class="flex items-start gap-4">
                                <span class="text-2xl flex-shrink-0">üî•</span>
                                <div class="flex-1 min-w-0">
                                    <strong class="text-white block mb-1">Highest Intensity:</strong>
                                    <span class="text-blue-100">Your most intense session was on <strong>${summaryData.highestIntensityDate}</strong> with <strong>${summaryData.highestIntensityVolume}</strong> total volume!</span>
                                </div>
                            </div>
                            
                            <!-- Biggest Progress -->
                            <div class="flex items-start gap-4">
                                <span class="text-2xl flex-shrink-0">üìà</span>
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-start justify-between">
                                        <div class="flex-1">
                                            <strong class="text-white block mb-1">Biggest Progress:</strong>
                                            <span class="text-blue-100"><strong>${summaryData.biggestProgressExercise}</strong> improved by <strong>+${summaryData.biggestProgressGain}</strong> - fantastic strength gains!</span>
                                        </div>
                                        <span class="text-2xl text-green-300 ml-3 flex-shrink-0">üöÄ</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Rest Patterns -->
                            ${summaryData.longestBreak > 0 ? `
                            <div class="flex items-start gap-4">
                                <span class="text-2xl flex-shrink-0">‚è∏Ô∏è</span>
                                <div class="flex-1 min-w-0">
                                    <strong class="text-white block mb-1">Rest Patterns:</strong>
                                    <span class="text-blue-100">Your longest break was <strong>${summaryData.longestBreak} days</strong> ${summaryData.breakMessage}</span>
                                </div>
                            </div>
                            ` : ''}
                            
                            <!-- Keep Going Message -->
                            <div class="flex items-start gap-4">
                                <span class="text-2xl flex-shrink-0">üéØ</span>
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-start justify-between">
                                        <div class="flex-1">
                                            <strong class="text-white block mb-1">Keep Going:</strong>
                                            <span class="text-blue-100">${summaryData.motivationalMessage}</span>
                                        </div>
                                        <span class="text-2xl text-green-300 ml-3 flex-shrink-0">üöÄ</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Progress Phase -->
                        <div class="bg-green-700/30 rounded-lg p-6 border border-green-500">
                            <div class="flex items-center gap-2 mb-3">
                                <span class="text-2xl">üöÄ</span>
                                <h3 class="text-lg font-bold text-green-200">${summaryData.phaseTitle}</h3>
                            </div>
                            <p class="text-green-100 text-sm leading-relaxed">${summaryData.phaseDescription}</p>
                        </div>
                        
                        <!-- Total Sessions Display -->
                        <div class="text-center">
                            <div class="text-6xl font-bold text-blue-200">${workoutSessions.length}</div>
                            <div class="text-blue-300 text-lg">Total Sessions</div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function showNoDataSummaryModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-gradient-to-br from-blue-800 to-blue-900 text-white rounded-xl shadow-2xl w-full max-w-md max-h-[90vh] overflow-hidden border-2 border-blue-400">
                    <div class="p-6 border-b border-blue-600">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <span class="text-3xl">üìä</span>
                                <h2 class="text-2xl font-bold">Training Summary</h2>
                            </div>
                            <button onclick="this.closest('.fixed').remove()" class="text-white/80 hover:text-white text-2xl">√ó</button>
                        </div>
                    </div>
                    
                    <div class="p-8 text-center">
                        <div class="text-6xl mb-6">üèãÔ∏è</div>
                        <h3 class="text-xl font-bold mb-4">Ready to Start Your Journey?</h3>
                        <p class="text-blue-100 mb-6 leading-relaxed">Your training summary will appear here once you complete some workouts. Start your first workout to see detailed insights about your progress!</p>
                        
                        <div class="space-y-3">
                            <button onclick="this.closest('.fixed').remove(); goToWorkoutSelection()" class="w-full px-6 py-3 bg-white text-blue-800 rounded-lg font-semibold hover:bg-blue-50 transition-colors">
                                Start First Workout
                            </button>
                            <button onclick="this.closest('.fixed').remove(); openWorkoutCreator()" class="w-full px-6 py-3 bg-white/20 text-white rounded-lg font-semibold hover:bg-white/30 transition-colors border border-white/30">
                                Add Past Workouts
                            </button>
                        </div>
                        
                        <div class="mt-6 p-4 bg-blue-700/30 rounded-lg border border-blue-500">
                            <p class="text-sm text-blue-100">
                                üí° <strong>What you'll see:</strong> Progress tracking, strength gains, workout frequency, personal records, and motivational insights!
                            </p>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function calculateTrainingSummary() {
            if (workoutSessions.length === 0) return {};
            
            // Calculate time span
            const sortedSessions = [...workoutSessions].sort((a, b) => new Date(a.date) - new Date(b.date));
            const firstSession = new Date(sortedSessions[0].date);
            const lastSession = new Date(sortedSessions[sortedSessions.length - 1].date);
            const daysDiff = Math.ceil((lastSession - firstSession) / (1000 * 60 * 60 * 24)) + 1;
            
            // Journey text
            const journeyText = `Your lifting journey spans ${daysDiff} days with ${workoutSessions.length} total workouts!`;
            
            // Training frequency
            const weeksDiff = Math.max(1, Math.ceil(daysDiff / 7));
            const avgFrequency = (workoutSessions.length / weeksDiff).toFixed(1);
            let frequencyMessage = '';
            let frequencyIcon = '';
            
            if (avgFrequency >= 4) {
                frequencyMessage = 'excellent consistency!';
                frequencyIcon = 'üî•';
            } else if (avgFrequency >= 3) {
                frequencyMessage = 'great routine!';
                frequencyIcon = 'üí™';
            } else if (avgFrequency >= 2) {
                frequencyMessage = 'good progress!';
                frequencyIcon = 'üëç';
            } else {
                frequencyMessage = 'room for improvement!';
                frequencyIcon = 'üìà';
            }
            
            // Completion rate
            const completedSessions = workoutSessions.filter(s => s.isComplete).length;
            const completionRate = Math.round((completedSessions / workoutSessions.length) * 100);
            let completionMessage = '';
            let completionIcon = '';
            
            if (completionRate === 100) {
                completionMessage = 'amazing dedication!';
                completionIcon = 'üèÜ';
            } else if (completionRate >= 90) {
                completionMessage = 'excellent commitment!';
                completionIcon = 'üåü';
            } else if (completionRate >= 80) {
                completionMessage = 'great consistency!';
                completionIcon = 'üí™';
            } else {
                completionMessage = 'keep pushing!';
                completionIcon = 'üìà';
            }
            
            // Most trained exercise
            const exerciseCounts = {};
            workoutSessions.forEach(session => {
                session.exercises.forEach(ex => {
                    exerciseCounts[ex.exercise] = (exerciseCounts[ex.exercise] || 0) + 1;
                });
            });
            
            const mostTrainedExercise = Object.keys(exerciseCounts).reduce((a, b) => 
                exerciseCounts[a] > exerciseCounts[b] ? a : b
            );
            const mostTrainedCount = Math.ceil(exerciseCounts[mostTrainedExercise] / 5); // Assuming ~5 sets per session
            
            // Highest intensity session
            let highestIntensitySession = workoutSessions[0];
            let highestVolume = 0;
            
            workoutSessions.forEach(session => {
                const volume = session.exercises.reduce((sum, ex) => sum + (ex.weight * ex.reps), 0);
                if (volume > highestVolume) {
                    highestVolume = volume;
                    highestIntensitySession = session;
                }
            });
            
            const highestIntensityDate = new Date(highestIntensitySession.date).toLocaleDateString();
            const highestIntensityVolume = `${Math.round(highestVolume)}kg`;
            
            // Biggest progress
            const progressData = {};
            workoutSessions.forEach(session => {
                session.exercises.forEach(ex => {
                    if (!progressData[ex.exercise]) {
                        progressData[ex.exercise] = { min: ex.weight, max: ex.weight };
                    }
                    progressData[ex.exercise].min = Math.min(progressData[ex.exercise].min, ex.weight);
                    progressData[ex.exercise].max = Math.max(progressData[ex.exercise].max, ex.weight);
                });
            });
            
            let biggestProgressExercise = '';
            let biggestProgressGain = 0;
            
            Object.keys(progressData).forEach(exercise => {
                const gain = progressData[exercise].max - progressData[exercise].min;
                if (gain > biggestProgressGain) {
                    biggestProgressGain = gain;
                    biggestProgressExercise = exercise;
                }
            });
            
            // Longest break between sessions
            let longestBreak = 0;
            for (let i = 1; i < sortedSessions.length; i++) {
                const prevDate = new Date(sortedSessions[i - 1].date);
                const currDate = new Date(sortedSessions[i].date);
                const daysBetween = Math.ceil((currDate - prevDate) / (1000 * 60 * 60 * 24)) - 1;
                longestBreak = Math.max(longestBreak, daysBetween);
            }
            
            let breakMessage = '';
            if (longestBreak <= 3) {
                breakMessage = '- excellent consistency!';
            } else if (longestBreak <= 7) {
                breakMessage = '- good recovery balance!';
            } else {
                breakMessage = '- but you came back stronger!';
            }
            
            // Motivational message based on progress
            let motivationalMessage = '';
            if (workoutSessions.length < 5) {
                motivationalMessage = "You're just getting started - consistency is key for the first month!";
            } else if (workoutSessions.length < 15) {
                motivationalMessage = "Building solid foundations - keep up the momentum!";
            } else if (workoutSessions.length < 30) {
                motivationalMessage = "Developing serious strength - you're in the groove!";
            } else {
                motivationalMessage = "You're a strength training veteran - inspiration to others!";
            }
            
            // Progress phase
            let phaseTitle = '';
            let phaseDescription = '';
            
            if (workoutSessions.length < 10) {
                phaseTitle = 'üöÄ Building Foundations';
                phaseDescription = "You're in the foundation-building phase! Focus on consistency, proper form, and gradual progression. Every workout is building strength and establishing healthy habits!";
            } else if (workoutSessions.length < 25) {
                phaseTitle = 'üí™ Developing Strength';
                phaseDescription = "You're developing serious strength! Your consistency is paying off with noticeable gains. Focus on progressive overload and challenging yourself with each session.";
            } else {
                phaseTitle = 'üèÜ Strength Athlete';
                phaseDescription = "You're now a dedicated strength athlete! Your commitment and consistency are exceptional. Continue pushing boundaries while listening to your body for optimal recovery.";
            }
            
            return {
                journeyText,
                avgFrequency,
                frequencyMessage,
                frequencyIcon,
                completionRate,
                completionMessage,
                completionIcon,
                mostTrainedExercise,
                mostTrainedCount,
                highestIntensityDate,
                highestIntensityVolume,
                biggestProgressExercise,
                biggestProgressGain: `${biggestProgressGain}kg`,
                longestBreak,
                breakMessage,
                motivationalMessage,
                phaseTitle,
                phaseDescription
            };
        }

        // Calculate current workout streak
        function calculateCurrentStreak() {
            if (workoutSessions.length === 0) return 0;
            
            let streak = 1;
            const today = new Date();
            let checkDate = new Date(today);
            checkDate.setDate(checkDate.getDate() - 1); // Start from yesterday
            
            for (let i = 1; i < Math.min(workoutSessions.length, 30); i++) { // Max 30 days back
                const sessionDate = new Date(workoutSessions[i].date);
                const sessionDay = sessionDate.toDateString();
                const checkDay = checkDate.toDateString();
                
                if (sessionDay === checkDay) {
                    streak++;
                    checkDate.setDate(checkDate.getDate() - 1);
                } else {
                    break;
                }
            }
            
            return streak;
        }

        // Enhanced updateAllDataRelatedUI with error handling
        function updateAllDataRelatedUI() {
            try {
                updateQuickActions();
                updateExportStatus();
                updateLatestWorkoutDisplay();
                updateWorkoutHistoryDisplay();
                updateQuickStats();
                updateDataHealthIndicator();
            } catch (error) {
                console.error('Error updating UI:', error);
                // Continue execution even if some UI updates fail
            }
        }

        // Data health indicator
        function updateDataHealthIndicator() {
            const indicator = document.getElementById('dataHealthIndicator');
            if (!indicator) return;
            
            if (workoutSessions.length === 0) {
                indicator.className = 'w-3 h-3 rounded-full bg-gray-400';
            } else if (workoutSessions.length < 3) {
                indicator.className = 'w-3 h-3 rounded-full bg-yellow-500 pulse-animation';
            } else {
                indicator.className = 'w-3 h-3 rounded-full bg-green-500 pulse-animation';
            }
        }

        // All the original JavaScript code continues here...
        // (Include all the existing functions from the original code)

        // Workout definitions
        const workouts = {
            A: {
                name: 'Workout A',
                exercises: ['Squats', 'Overhead Press', 'Deadlift']
            },
            B: {
                name: 'Workout B', 
                exercises: ['Squats', 'Bench Press', 'Barbell Rows']
            }
        };

        // State management with proper initialization
        let currentWorkoutType = null;
        let currentExercise = null;
        let currentExerciseIndex = 0;
        let timer = null;
        let timeRemaining = 0;
        let isTimerRunning = false;
        let workoutHistory = []; // Always initialize as empty array
        let workoutSessions = []; // Always initialize as empty array
        let currentFilter = 'all';
        let workoutPlan = [];
        let deloadSuggestions = {};
        let currentTimePeriod = 'week';
        let currentChartType = 'progress';
        
        // Global state protection
        let isUpdatingHistory = false; // Prevent concurrent updates
        
        // Weight units setting - default is kg
        let currentWeightUnit = 'kg';
        
        // Workout Duration Timer
        let workoutTimer = null;
        let workoutStartTime = null;
        let workoutElapsedSeconds = 0;
        let isWorkoutTimerRunning = false;
        let isWorkoutTimerPaused = false;

        // Include all the original functions here...
        // (All the existing function code remains the same)

        // Weight Units Functions
        function changeWeightUnits() {
            const weightUnitsSelect = document.getElementById('weightUnitsSelect');
            const newUnit = weightUnitsSelect.value;

            if (newUnit === currentWeightUnit) return;

            // Save preference
            currentWeightUnit = newUnit;
            SafeStorage.setItem('preferredWeightUnit', newUnit);

            // Show conversion message
            const unitDisplay = newUnit === 'kg' ? 'Kilograms (kg)' : 'Pounds (lbs)';
            showToast(`Weight units changed to ${unitDisplay}`, 'success');

            console.log('‚öñÔ∏è Weight units changed to:', newUnit);
        }

        function saveWorkoutSettings() {
            const settings = {
                restTime: parseInt(document.getElementById('globalRestTime')?.value || 180),
                sets: parseInt(document.getElementById('globalSets')?.value || 5),
                increment: parseFloat(document.getElementById('globalIncrement')?.value || 0)
            };

            SafeStorage.setItem('workoutSettings', JSON.stringify(settings));
            showToast('Workout settings saved!', 'success');
            console.log('üíæ Workout settings saved:', settings);
        }

        async function loadWorkoutSettings() {
            try {
                const savedSettings = await SafeStorage.getItem('workoutSettings');
                if (savedSettings) {
                    const settings = JSON.parse(savedSettings);

                    const restTimeEl = document.getElementById('globalRestTime');
                    const setsEl = document.getElementById('globalSets');
                    const incrementEl = document.getElementById('globalIncrement');

                    if (restTimeEl) restTimeEl.value = settings.restTime || 180;
                    if (setsEl) setsEl.value = settings.sets || 5;
                    if (incrementEl) incrementEl.value = settings.increment || 0;

                    console.log('‚úÖ Workout settings loaded:', settings);
                }
            } catch (error) {
                console.warn('Failed to load workout settings:', error);
            }
        }
        
        async function initializeWeightUnits() {
            // Load saved preference
            const savedUnit = await SafeStorage.getItem('preferredWeightUnit') || 'kg';
            currentWeightUnit = savedUnit;

            const weightUnitsSelect = document.getElementById('weightUnitsSelect');
            if (weightUnitsSelect) {
                weightUnitsSelect.value = currentWeightUnit;
            }
        }

        // Rest Timer Sound Functions
        async function toggleRestTimerSound() {
            const toggle = document.getElementById('restTimerSoundToggle');
            const isEnabled = toggle.checked;

            // Save preference
            await SafeStorage.setItem('restTimerSoundEnabled', isEnabled ? 'true' : 'false');

            // Show feedback
            if (isEnabled) {
                showToast('üîî Rest timer sound enabled', 'success');
            } else {
                showToast('üîá Rest timer sound disabled', 'info');
            }

            console.log('üîî Rest timer sound:', isEnabled ? 'enabled' : 'disabled');
        }

        async function testRestTimerSound() {
            console.log('üîä Test sound button clicked');
            await playRestTimerSound();
        }

        async function initializeRestTimerSound() {
            // Load saved preference (default to enabled)
            const savedPref = await SafeStorage.getItem('restTimerSoundEnabled');
            const isEnabled = savedPref !== 'false'; // Default to true if not set

            const toggle = document.getElementById('restTimerSoundToggle');
            if (toggle) {
                toggle.checked = isEnabled;
            }

            console.log('üîî Rest timer sound initialized:', isEnabled ? 'enabled' : 'disabled');
        }
        
        function formatWeight(weight, includeUnit = true) {
            if (currentWeightUnit === 'lbs') {
                const lbsWeight = (weight * 2.20462).toFixed(1);
                return includeUnit ? `${lbsWeight}lbs` : lbsWeight;
            } else {
                return includeUnit ? `${weight}kg` : weight;
            }
        }
        
        function getWeightUnit() {
            return currentWeightUnit === 'lbs' ? 'lbs' : 'kg';
        }

        // Enhanced navigation functions
        // Navigation functions for new separate pages
        function goToDataManagement() {
            console.log('üìä Navigating to Data Management page...');
            document.getElementById('dataScreen').classList.add('hidden');
            document.getElementById('dataManagementPage').classList.remove('hidden');
            document.getElementById('settingsPage').classList.add('hidden');
            document.getElementById('workoutSelectionScreen').classList.add('hidden');
            document.getElementById('setupScreen').classList.add('hidden');
            window.scrollTo(0, 0);
        }

        function goToSettings() {
            console.log('‚öôÔ∏è Navigating to Settings page...');
            document.getElementById('dataScreen').classList.add('hidden');
            document.getElementById('dataManagementPage').classList.add('hidden');
            document.getElementById('settingsPage').classList.remove('hidden');
            document.getElementById('workoutSelectionScreen').classList.add('hidden');
            document.getElementById('setupScreen').classList.add('hidden');
            window.scrollTo(0, 0);
        }

        function goBackToHome() {
            console.log('üè† Navigating back to home...');

            // Hide all screens
            document.getElementById('dataManagementPage').classList.add('hidden');
            document.getElementById('settingsPage').classList.add('hidden');
            document.getElementById('workoutSelectionScreen').classList.add('hidden');
            document.getElementById('setupScreen').classList.add('hidden');

            // Also hide workout phases
            const workoutSetupPhase = document.getElementById('workoutSetupPhase');
            const workoutExecutionPhase = document.getElementById('workoutExecutionPhase');
            if (workoutSetupPhase) workoutSetupPhase.classList.add('hidden');
            if (workoutExecutionPhase) workoutExecutionPhase.classList.add('hidden');

            // Show home screen
            document.getElementById('dataScreen').classList.remove('hidden');

            // Update UI
            updateLatestWorkoutDisplay();
            updateExportStatus();

            window.scrollTo(0, 0);
        }

        function goToDataManagementFromWorkout() {
            console.log('üè† Navigating back to data management from workout...');

            // Save current workout session if there's any progress
            if (workoutHistory.length > 0) {
                console.log('üíæ Saving workout session...');
                saveWorkoutSession();
            }

            // Stop workout timer and rest timer
            stopWorkoutTimer();
            hideRestTimer();
            
            // Get fresh DOM references
            const dataScreen = document.getElementById('dataScreen');
            const workoutSelectionScreen = document.getElementById('workoutSelectionScreen');
            const setupScreen = document.getElementById('setupScreen');
            const workoutHistorySection = document.getElementById('workoutHistorySection');
            
            console.log('üîç Found screens:', {
                dataScreen: !!dataScreen,
                workoutSelectionScreen: !!workoutSelectionScreen,
                setupScreen: !!setupScreen,
                workoutHistorySection: !!workoutHistorySection
            });
            
            // Hide all screens and modals
            if (dataScreen) {
                dataScreen.classList.remove('hidden');
                console.log('‚úÖ Showed data screen');
            }
            if (workoutSelectionScreen) workoutSelectionScreen.classList.add('hidden');
            if (setupScreen) setupScreen.classList.add('hidden');
            if (workoutHistorySection) workoutHistorySection.classList.add('hidden');
            
            // Close any open modals using the helper function
            closeAllModals();
            
            // Scroll to top
            setTimeout(() => {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }, 50);
            
            // CRITICAL: Use comprehensive reset function
            resetWorkoutState();
            currentWorkoutType = null;
            
            // Safely update UI components
            try {
                updateAllDataRelatedUI();
                console.log('‚úÖ Updated UI components');
            } catch (error) {
                console.warn('‚ö†Ô∏è Error updating UI:', error);
                // Continue execution even if UI update fails
            }
            
            console.log('üéâ Successfully navigated to home');
        }

        function goToWorkoutSelection() {
            // Check if workout is in progress (either in setup or execution phase)
            const workoutExecutionPhase = document.getElementById('workoutExecutionPhase');
            const isWorkoutActive = workoutExecutionPhase && !workoutExecutionPhase.classList.contains('hidden');

            // If workout is active, show confirmation dialog
            if (isWorkoutActive || workoutHistory.length > 0) {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4 modal-enter-active">
                        <div class="text-center">
                            <div class="text-4xl mb-4">‚ö†Ô∏è</div>
                            <h3 class="text-lg font-semibold mb-2 text-gray-800 dark:text-gray-200">Stop Current Workout?</h3>
                            <p class="text-gray-600 dark:text-gray-400 mb-4">
                                ${workoutHistory.length > 0
                                    ? `You have completed ${workoutHistory.length} sets. Your progress will be saved as an incomplete workout.`
                                    : 'Your workout session will be cancelled.'}
                            </p>
                            <div class="space-y-3">
                                <button onclick="confirmGoToWorkoutSelection(); this.closest('.fixed').remove();" class="w-full px-6 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">
                                    Yes, Stop Workout
                                </button>
                                <button onclick="this.closest('.fixed').remove()" class="w-full px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                return;
            }

            // No active workout, proceed directly
            proceedToWorkoutSelection();
        }

        function confirmGoToWorkoutSelection() {
            // Stop the rest timer immediately
            stopRestTimer();

            // Save incomplete workout if user has made progress
            if (workoutHistory.length > 0) {
                saveWorkoutSession(false); // Save as incomplete workout
            }

            // Reset workout state
            resetWorkoutState();

            // Go back to home screen instead of workout selection
            goBackToHome();
        }

        function proceedToWorkoutSelection() {
            // Hide all other screens
            const dataScreen = document.getElementById('dataScreen');
            const workoutSelectionScreen = document.getElementById('workoutSelectionScreen');
            const workoutSetupPhase = document.getElementById('workoutSetupPhase');
            const workoutExecutionPhase = document.getElementById('workoutExecutionPhase');

            if (dataScreen) dataScreen.classList.add('hidden');
            if (workoutSetupPhase) workoutSetupPhase.classList.add('hidden');
            if (workoutExecutionPhase) workoutExecutionPhase.classList.add('hidden');
            if (workoutSelectionScreen) workoutSelectionScreen.classList.remove('hidden');

            setTimeout(() => {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }, 50);

            updateWorkoutHistoryDisplay();
        }

        function resetWorkoutState() {
            console.log('üîÑ Resetting workout state...');

            // Reset workout data
            workoutHistory = [];
            currentExerciseIndex = 0;
            currentExercise = null;
            currentSetData = [];
            lastCompletedSetIndex = -1;

            // Reset timers
            workoutElapsedSeconds = 0;
            workoutStartTime = null;
            isWorkoutTimerRunning = false;
            isWorkoutTimerPaused = false;

            // Clear workout timer interval
            if (workoutTimer) {
                clearInterval(workoutTimer);
                workoutTimer = null;
            }

            // Clear rest timer interval
            if (timer) {
                clearInterval(timer);
                timer = null;
            }
            isTimerRunning = false;
            timeRemaining = 180;

            // Reset workout timer display
            const workoutDurationDisplay = document.getElementById('workoutDurationDisplay');
            if (workoutDurationDisplay) {
                workoutDurationDisplay.textContent = '00:00:00';
            }

            // Reset workout timer toggle button
            const workoutTimerToggle = document.getElementById('workoutTimerToggle');
            if (workoutTimerToggle) {
                workoutTimerToggle.textContent = 'Pause';
            }

            // CRITICAL: Reset screen visibility - hide execution phase, show setup phase
            const workoutSetupPhase = document.getElementById('workoutSetupPhase');
            const workoutExecutionPhase = document.getElementById('workoutExecutionPhase');

            if (workoutSetupPhase) {
                workoutSetupPhase.classList.remove('hidden');
                console.log('‚úÖ Showed workout setup phase');
            }

            if (workoutExecutionPhase) {
                workoutExecutionPhase.classList.add('hidden');
                console.log('‚úÖ Hidden workout execution phase');
            }

            // Clear set button states
            const setButtonsContainer = document.getElementById('setButtonsContainer');
            if (setButtonsContainer) {
                setButtonsContainer.innerHTML = '';
                console.log('‚úÖ Cleared set buttons');
            }

            // Reset rest timer display (but keep it visible)
            const restCountdown = document.getElementById('restCountdown');
            if (restCountdown) {
                restCountdown.textContent = '--:--';
            }
            const restTimerCircle = document.getElementById('restTimerCircle');
            if (restTimerCircle) {
                restTimerCircle.style.strokeDashoffset = 0;
            }

            console.log('‚úÖ Workout state reset complete');
        }

        function selectWorkout(type) {
            // CRITICAL: Reset all workout state before starting a new workout
            resetWorkoutState();

            currentWorkoutType = type;
            currentExerciseIndex = 0;

            const workoutSelectionScreen = document.getElementById('workoutSelectionScreen');
            const setupScreen = document.getElementById('setupScreen');
            const workoutHistorySection = document.getElementById('workoutHistorySection');
            const workoutTitle = document.getElementById('workoutTitle');

            if (workoutSelectionScreen) workoutSelectionScreen.classList.add('hidden');
            if (setupScreen) setupScreen.classList.remove('hidden');
            if (workoutHistorySection) workoutHistorySection.classList.add('hidden'); // Keep this hidden since we have Progress tab
            if (workoutTitle) workoutTitle.textContent = workouts[type].name;

            window.scrollTo({ top: 0, behavior: 'smooth' });

            // Check for deload before setting up workout
            const deloadInfo = checkForDeload();
            if (deloadInfo) {
                setupWorkoutConfiguration();
                showDeloadModal(deloadInfo);
            } else {
                setupWorkoutConfiguration();
            }
        }

        function updateExportStatus() {
            const exportStatus = document.getElementById('exportStatus');
            const exportStatusDetailed = document.getElementById('exportStatusDetailed');
            
            if (workoutSessions.length > 0) {
                const message = `${workoutSessions.length} workout sessions ready to export`;
                if (exportStatus) {
                    exportStatus.textContent = message;
                    exportStatus.classList.remove('text-gray-500');
                    exportStatus.classList.add('text-green-600');
                }
                if (exportStatusDetailed) {
                    exportStatusDetailed.innerHTML = `<span class="w-2 h-2 bg-green-500 rounded-full"></span> ${message}`;
                    exportStatusDetailed.classList.remove('text-gray-500');
                    exportStatusDetailed.classList.add('text-green-600');
                }
                
                updateLatestWorkoutDisplay();
            } else {
                const message = 'No workout data yet';
                if (exportStatus) {
                    exportStatus.textContent = message;
                    exportStatus.classList.remove('text-green-600');
                    exportStatus.classList.add('text-gray-500');
                }
                if (exportStatusDetailed) {
                    exportStatusDetailed.innerHTML = `<span class="w-2 h-2 bg-gray-400 rounded-full"></span> ${message}`;
                    exportStatusDetailed.classList.remove('text-green-600');
                    exportStatusDetailed.classList.add('text-gray-500');
                }
                
                const latestWorkoutDisplay = document.getElementById('latestWorkoutDisplay');
                if (latestWorkoutDisplay) latestWorkoutDisplay.classList.add('hidden');
            }
        }

        function updateLatestWorkoutDisplay() {
            const latestWorkoutDisplay = document.getElementById('latestWorkoutDisplay');
            const latestWorkoutContent = document.getElementById('latestWorkoutContent');
            
            if (workoutSessions.length === 0 || !latestWorkoutDisplay) {
                if (latestWorkoutDisplay) latestWorkoutDisplay.classList.add('hidden');
                return;
            }

            const latestSession = workoutSessions[0];
            latestWorkoutDisplay.classList.remove('hidden');
            
            const workoutName = latestSession.workoutType === 'A' ? 'Workout A' : 
                               latestSession.workoutType === 'B' ? 'Workout B' : 'Custom Workout';
            
            const exerciseGroups = {};
            latestSession.exercises.forEach(entry => {
                if (!exerciseGroups[entry.exercise]) {
                    exerciseGroups[entry.exercise] = [];
                }
                exerciseGroups[entry.exercise].push(entry);
            });

            let exercisesHTML = '';
            Object.keys(exerciseGroups).forEach(exerciseName => {
                const sets = exerciseGroups[exerciseName];
                const maxWeight = Math.max(...sets.map(s => s.weight));
                const avgReps = Math.round(sets.reduce((sum, s) => sum + s.reps, 0) / sets.length);
                
                exercisesHTML += `
                    <div class="flex items-center justify-between p-3 bg-white dark:bg-gray-800 rounded-lg">
                        <div>
                            <h5 class="font-semibold text-sm">${exerciseName}</h5>
                            <p class="text-xs text-gray-600 dark:text-gray-400">${sets.length} sets completed</p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm font-bold text-primary">${maxWeight}kg</p>
                            <p class="text-xs text-gray-600 dark:text-gray-400">avg ${avgReps} reps</p>
                        </div>
                    </div>
                `;
            });

            const borderColor = latestSession.isComplete ? 'border-green-400 dark:border-green-600' : 'border-red-400 dark:border-red-600';
            const statusBadge = latestSession.isComplete ? 
                '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300">‚úÖ Complete</span>' : 
                '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-300">‚ö† Incomplete</span>';

            const timeSinceWorkout = getTimeSince(latestSession.date);

            if (latestWorkoutContent) {
                latestWorkoutContent.innerHTML = `
                    <div class="flex flex-col lg:flex-row gap-6">
                        <div class="flex-1">
                            <div class="flex items-center justify-between mb-4">
                                <div>
                                    <div class="flex items-center gap-2 mb-1">
                                        <h3 class="text-xl font-bold text-primary">${workoutName}</h3>
                                        ${statusBadge}
                                    </div>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">${latestSession.date.toLocaleDateString()} at ${latestSession.date.toLocaleTimeString()} ‚Ä¢ ${timeSinceWorkout}</p>
                                    ${!latestSession.isComplete ? '<p class="text-xs text-red-600 dark:text-red-400 mt-1">‚ö† Workout stopped early</p>' : ''}
                                </div>
                            </div>
                            <div class="space-y-3">
                                ${exercisesHTML}
                            </div>
                        </div>
                        <div class="lg:w-64">
                            <div class="bg-white dark:bg-gray-800 rounded-lg p-4 border ${borderColor}">
                                <h4 class="font-semibold mb-3 text-center">Workout Stats</h4>
                                <div class="grid grid-cols-2 gap-4 text-center">
                                    <div>
                                        <div class="text-2xl font-bold text-primary">${latestSession.statistics.totalSets}</div>
                                        <div class="text-xs text-gray-600 dark:text-gray-400">Total Sets</div>
                                    </div>
                                    <div>
                                        <div class="text-2xl font-bold text-green-600">${latestSession.statistics.completedTargets}</div>
                                        <div class="text-xs text-gray-600 dark:text-gray-400">Targets Hit</div>
                                    </div>
                                    <div>
                                        <div class="text-lg font-bold text-blue-600">${latestSession.statistics.duration}min</div>
                                        <div class="text-xs text-gray-600 dark:text-gray-400">Duration</div>
                                    </div>
                                    <div>
                                        <div class="text-lg font-bold text-purple-600">${Math.round(latestSession.exercises.reduce((sum, ex) => sum + (ex.weight * ex.reps), 0))}kg</div>
                                        <div class="text-xs text-gray-600 dark:text-gray-400">Volume</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        function getTimeSince(date) {
            const now = new Date();
            const diffInHours = Math.floor((now - new Date(date)) / (1000 * 60 * 60));
            
            if (diffInHours < 1) {
                const diffInMinutes = Math.floor((now - new Date(date)) / (1000 * 60));
                return diffInMinutes <= 1 ? 'Just now' : `${diffInMinutes} minutes ago`;
            } else if (diffInHours < 24) {
                return diffInHours === 1 ? '1 hour ago' : `${diffInHours} hours ago`;
            } else {
                const diffInDays = Math.floor(diffInHours / 24);
                if (diffInDays === 1) return '1 day ago';
                if (diffInDays < 7) return `${diffInDays} days ago`;
                if (diffInDays < 30) return `${Math.floor(diffInDays / 7)} week${Math.floor(diffInDays / 7) !== 1 ? 's' : ''} ago`;
                return `${Math.floor(diffInDays / 30)} month${Math.floor(diffInDays / 30) !== 1 ? 's' : ''} ago`;
            }
        }

        // Enhanced updateQuickActions function with null checks
        function updateQuickActions() {
            const quickActionsRow = document.getElementById('quickActionsRow');
            if (!quickActionsRow) return;
            
            try {
                const hasData = workoutSessions.length > 0;
                const actions = [];
                
                // Always show Export Data
                actions.push(`
                    <button onclick="showExportFormatSelection()" class="flex flex-col items-center p-4 bg-green-50 dark:bg-green-900/20 rounded-lg border border-green-200 dark:border-green-700 hover:bg-green-100 dark:hover:bg-green-900/30 transition-all duration-300 transform hover:scale-105">
                        <span class="text-2xl mb-2">üì¶</span>
                        <span class="text-sm font-medium text-green-700 dark:text-green-300">Export Data</span>
                        <span id="exportStatus" class="text-xs text-gray-500 dark:text-gray-400">Ready to export</span>
                    </button>
                `);
                
                // Show Import Data only when there's no data
                if (!hasData) {
                    actions.push(`
                        <button onclick="importWorkoutData()" class="flex flex-col items-center p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-700 hover:bg-blue-100 dark:hover:bg-blue-900/30 transition-all duration-300 transform hover:scale-105">
                            <span class="text-2xl mb-2">üì§</span>
                            <span class="text-sm font-medium text-blue-700 dark:text-blue-300">Import Data</span>
                            <span class="text-xs text-gray-500 dark:text-gray-400">Restore backup</span>
                        </button>
                    `);
                }
                
                // Always show Create History
                actions.push(`
                    <button onclick="openWorkoutCreator()" class="flex flex-col items-center p-4 bg-pink-50 dark:bg-pink-900/20 rounded-lg border border-pink-200 dark:border-pink-700 hover:bg-pink-100 dark:hover:bg-pink-900/30 transition-all duration-300 transform hover:scale-105">
                        <span class="text-2xl mb-2">üìù</span>
                        <span class="text-sm font-medium text-pink-700 dark:text-pink-300">Create History</span>
                        <span class="text-xs text-gray-500 dark:text-gray-400">Manual entry</span>
                    </button>
                `);
                
                // Update grid columns based on number of actions
                const gridCols = hasData ? 'grid-cols-2 md:grid-cols-2' : 'grid-cols-2 md:grid-cols-3';
                quickActionsRow.className = `grid ${gridCols} gap-4 mb-6`;
                quickActionsRow.innerHTML = actions.join('');
            } catch (error) {
                console.error('Error in updateQuickActions:', error);
            }
        }

        // Data Management Toggle Function
        function toggleDataManagement() {
            const detailedOptions = document.getElementById('detailedDataOptions');
            const toggleBtn = document.getElementById('toggleDataOptions');
            
            if (detailedOptions.classList.contains('hidden')) {
                detailedOptions.classList.remove('hidden');
                toggleBtn.textContent = 'Hide Options';
            } else {
                detailedOptions.classList.add('hidden');
                toggleBtn.textContent = 'Show Options';
            }
        }

        // Export/Import Functions
        function showExportFormatSelection() {
            if (workoutSessions.length === 0) {
                showToast('No workout data to export. Complete some workouts first!', 'error');
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-md w-full mx-4 modal-enter-active">
                    <div class="text-center mb-6">
                        <div class="text-4xl mb-4 animate-bounce-in">üì¶</div>
                        <h3 class="text-lg font-semibold mb-2">Export Workout Data</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400">Choose your export format:</p>
                        <p class="text-xs text-green-600 dark:text-green-400 mt-1">${workoutSessions.length} workout sessions ready to export</p>
                    </div>
                    
                    <div class="space-y-3">
                        <button onclick="exportWorkoutData('json'); this.closest('.fixed').remove()" class="w-full flex items-center gap-3 p-4 border border-gray-200 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                            <span class="text-2xl">üì¶</span>
                            <div class="text-left flex-1">
                                <div class="font-medium">JSON File</div>
                                <div class="text-xs text-gray-500 dark:text-gray-400">Full backup with all features and metadata</div>
                            </div>
                            <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">Recommended</span>
                        </button>
                        
                        <button onclick="exportWorkoutData('csv'); this.closest('.fixed').remove()" class="w-full flex items-center gap-3 p-4 border border-gray-200 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                            <span class="text-2xl">üìä</span>
                            <div class="text-left flex-1">
                                <div class="font-medium">CSV File</div>
                                <div class="text-xs text-gray-500 dark:text-gray-400">Spreadsheet format for external analysis</div>
                            </div>
                        </button>
                    </div>
                    
                    <button onclick="this.closest('.fixed').remove()" class="w-full mt-4 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                        Cancel
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function exportWorkoutData(format = 'json') {
            if (workoutSessions.length === 0) {
                showToast('No workout data to export. Complete some workouts first!', 'error');
                return;
            }

            try {
                if (format === 'csv') {
                    exportAsCSV();
                } else {
                    exportAsJSON();
                }
            } catch (error) {
                showToast(`Export failed: ${error.message}`, 'error');
            }
        }
        
        function exportAsJSON() {
            const exportData = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                totalSessions: workoutSessions.length,
                workoutSessions: workoutSessions
            };

            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `lift-tracker-backup-${new Date().toISOString().split('T')[0]}.json`;
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            URL.revokeObjectURL(link.href);
            
            showToast(`Successfully exported ${workoutSessions.length} workout sessions as JSON!`, 'success');
        }
        
        function exportAsCSV() {
            // CSV export logic
            const csvRows = [];
            csvRows.push('date,workout_type,exercise_name,set_number,reps,weight,target_reps,session_complete');
            
            workoutSessions.forEach(session => {
                const sessionDate = new Date(session.date).toISOString().split('T')[0];
                const isComplete = session.isComplete ? 'true' : 'false';
                
                session.exercises.forEach(exercise => {
                    const row = [
                        sessionDate,
                        session.workoutType,
                        escapeCSVField(exercise.exercise),
                        exercise.setNumber,
                        exercise.reps,
                        exercise.weight,
                        exercise.targetReps,
                        isComplete
                    ];
                    csvRows.push(row.join(','));
                });
            });
            
            const csvContent = csvRows.join('\n');
            const dataBlob = new Blob([csvContent], { type: 'text/csv' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `lift-tracker-data-${new Date().toISOString().split('T')[0]}.csv`;
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            URL.revokeObjectURL(link.href);
            
            const totalRows = csvRows.length - 1;
            showToast(`Successfully exported ${totalRows} exercise sets as CSV!`, 'success');
        }
        
        function escapeCSVField(field) {
            const stringField = String(field);
            if (stringField.includes(',') || stringField.includes('"') || stringField.includes('\n')) {
                return `"${stringField.replace(/"/g, '""')}"`;
            }
            return stringField;
        }

        function importWorkoutData() {
            showImportFormatSelectionModal();
        }
        
        function showImportFormatSelectionModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-md w-full mx-4 modal-enter-active">
                    <div class="text-center mb-6">
                        <div class="text-4xl mb-4 animate-bounce-in">üì§</div>
                        <h3 class="text-lg font-semibold mb-2">Import Workout Data</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400">Choose your file format:</p>
                    </div>
                    
                    <div class="space-y-3">
                        <button onclick="selectImportFile('json'); this.closest('.fixed').remove()" class="w-full flex items-center gap-3 p-4 border border-gray-200 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                            <span class="text-2xl">üì¶</span>
                            <div class="text-left flex-1">
                                <div class="font-medium">JSON File</div>
                                <div class="text-xs text-gray-500 dark:text-gray-400">Full backup with all data and features</div>
                            </div>
                        </button>
                        
                        <button onclick="selectImportFile('csv'); this.closest('.fixed').remove()" class="w-full flex items-center gap-3 p-4 border border-gray-200 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                            <span class="text-2xl">üìä</span>
                            <div class="text-left flex-1">
                                <div class="font-medium">CSV File</div>
                                <div class="text-xs text-gray-500 dark:text-gray-400">Spreadsheet format (simplified data)</div>
                            </div>
                        </button>
                    </div>
                    
                    <button onclick="this.closest('.fixed').remove()" class="w-full mt-4 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                        Cancel
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function selectImportFile(format) {
            console.log('üîç Selecting import file for format:', format);
            const fileInput = getOrCreateFileInput(format);
            
            // Clear any previous value
            fileInput.value = '';
            
            // Set up the event handler
            fileInput.onchange = function(event) {
                console.log('üìÅ File selected:', event.target.files[0]?.name);
                if (format === 'csv') {
                    handleCSVImport(event);
                } else {
                    handleFileImport(event);
                }
            };
            
            // Trigger file selection
            try {
                fileInput.click();
                console.log('‚úÖ File input clicked successfully');
            } catch (error) {
                console.error('‚ùå Error clicking file input:', error);
                showToast('Error opening file selector. Please try again.', 'error');
            }
        }
        
        function getOrCreateFileInput(format) {
            const inputId = format === 'csv' ? 'csvImportFileInput' : 'importFileInput';
            let fileInput = document.getElementById(inputId);
            
            if (!fileInput) {
                console.log('üîß Creating new file input for format:', format);
                fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.id = inputId;
                fileInput.accept = format === 'csv' ? '.csv' : '.json';
                fileInput.className = 'hidden';
                fileInput.style.display = 'none';
                document.body.appendChild(fileInput);
                console.log('‚úÖ File input created:', inputId);
            }
            
            return fileInput;
        }

        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (!importedData.workoutSessions || !Array.isArray(importedData.workoutSessions)) {
                        throw new Error('Invalid data format - missing workoutSessions array');
                    }

                    const validSessions = importedData.workoutSessions.filter(session => {
                        return session.id && 
                               session.workoutType && 
                               session.date && 
                               Array.isArray(session.exercises) &&
                               session.statistics;
                    });

                    if (validSessions.length === 0) {
                        throw new Error('No valid workout sessions found');
                    }

                    // Convert date strings back to Date objects
                    validSessions.forEach(session => {
                        session.date = new Date(session.date);
                        session.exercises.forEach(exercise => {
                            exercise.timestamp = new Date(exercise.timestamp);
                        });
                    });

                    showImportConfirmDialog(validSessions, importedData);

                } catch (error) {
                    showToast(`Import failed: ${error.message}. Please check your file format.`, 'error');
                }
            };
            
            reader.readAsText(file);
            event.target.value = '';
        }

        function handleCSVImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csvSessions = parseCSVToWorkoutSessions(e.target.result);
                    
                    if (csvSessions.length === 0) {
                        throw new Error('No valid workout sessions found in CSV');
                    }
                    
                    showCSVImportConfirmDialog(csvSessions);
                    
                } catch (error) {
                    showToast(`CSV Import failed: ${error.message}`, 'error');
                }
            };
            
            reader.readAsText(file);
            event.target.value = '';
        }

        function parseCSVToWorkoutSessions(csvText) {
            const lines = csvText.trim().split('\n');
            if (lines.length < 2) {
                throw new Error('CSV file must contain headers and at least one data row');
            }
            
            const headers = parseCSVLine(lines[0]).map(h => h.trim().toLowerCase());
            
            // Validate required headers
            const requiredHeaders = ['date', 'workout_type', 'exercise_name', 'set_number', 'reps', 'weight'];
            const missingHeaders = requiredHeaders.filter(h => !headers.includes(h));
            
            if (missingHeaders.length > 0) {
                throw new Error(`CSV missing required columns: ${missingHeaders.join(', ')}`);
            }
            
            // Parse data rows
            const rows = [];
            for (let i = 1; i < lines.length; i++) {
                try {
                    const values = parseCSVLine(lines[i]);
                    if (values.length === 0 || (values.length === 1 && values[0] === '')) {
                        continue; // Skip empty rows
                    }
                    
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index]?.trim() || '';
                    });
                    
                    // Validate row data
                    const errors = validateCSVRow(row, i + 1);
                    if (errors.length > 0) {
                        throw new Error(errors[0]); // Show first error
                    }
                    
                    rows.push(row);
                } catch (error) {
                    throw new Error(`Row ${i + 1}: ${error.message}`);
                }
            }
            
            if (rows.length === 0) {
                throw new Error('No valid data rows found in CSV');
            }
            
            return reconstructWorkoutSessions(rows);
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    if (inQuotes && line[i + 1] === '"') {
                        current += '"';
                        i++; // Skip next quote
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current);
            return result;
        }

        function validateCSVRow(row, rowIndex) {
            const errors = [];
            
            // Validate date
            if (!row.date || isNaN(Date.parse(row.date))) {
                errors.push(`Invalid or missing date`);
            }
            
            // Validate workout type
            const workoutType = row.workout_type?.toUpperCase();
            if (!workoutType || !['A', 'B', 'CUSTOM'].includes(workoutType)) {
                errors.push(`Workout type must be A, B, or Custom`);
            }
            
            // Validate exercise name
            if (!row.exercise_name) {
                errors.push(`Exercise name is required`);
            }
            
            // Validate set number
            const setNumber = parseInt(row.set_number);
            if (!setNumber || setNumber < 1) {
                errors.push(`Set number must be a positive integer`);
            }
            
            // Validate reps
            const reps = parseInt(row.reps);
            if (!reps || reps < 1 || reps > 100) {
                errors.push(`Reps must be between 1 and 100`);
            }
            
            // Validate weight
            const weight = parseFloat(row.weight);
            if (isNaN(weight) || weight <= 0 || weight > 1000) {
                errors.push(`Weight must be between 0 and 1000 kg`);
            }
            
            return errors;
        }

        function reconstructWorkoutSessions(csvRows) {
            const sessionGroups = {};
            
            // Group by session (date + workout_type)
            csvRows.forEach(row => {
                const sessionDate = new Date(row.date);
                const sessionKey = `${sessionDate.toISOString().split('T')[0]}_${row.workout_type.toUpperCase()}`;
                
                if (!sessionGroups[sessionKey]) {
                    sessionGroups[sessionKey] = {
                        date: new Date(sessionDate.toISOString().split('T')[0] + 'T12:00:00'), // Default to noon
                        workoutType: row.workout_type.toUpperCase(),
                        exercises: [],
                        isComplete: row.session_complete === 'true' || row.session_complete === true,
                        id: Date.now() + Math.random()
                    };
                }
                
                // Add exercise data
                sessionGroups[sessionKey].exercises.push({
                    exercise: row.exercise_name,
                    setNumber: parseInt(row.set_number),
                    reps: parseInt(row.reps),
                    weight: parseFloat(row.weight),
                    targetReps: parseInt(row.target_reps || row.reps),
                    timestamp: new Date(sessionGroups[sessionKey].date.getTime() + (parseInt(row.set_number) * 3 * 60 * 1000)) // Estimate 3 min per set
                });
            });
            
            // Convert to array and add statistics
            return Object.values(sessionGroups).map(session => {
                session.statistics = {
                    totalSets: session.exercises.length,
                    completedTargets: session.exercises.filter(ex => ex.reps >= ex.targetReps).length,
                    duration: Math.max(30, session.exercises.length * 3) // Estimate 3 min per set
                };
                return session;
            });
        }

        function showImportConfirmDialog(validSessions, importedData) {
            console.log('üìù Showing import confirm dialog with', validSessions.length, 'sessions');
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            
            // Store the sessions globally for the confirm functions
            window.pendingImportSessions = validSessions;
            console.log('‚úÖ Stored pending import sessions:', window.pendingImportSessions.length);
            
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-md w-full mx-4 modal-enter-active">
                    <div class="text-center">
                        <div class="text-4xl mb-4 animate-bounce-in">üì§</div>
                        <h3 class="text-lg font-semibold mb-2">Import Workout Data</h3>
                        <div class="text-left mb-4 p-3 bg-gray-100 dark:bg-gray-700 rounded">
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">Import Details:</p>
                            <ul class="text-xs space-y-1">
                                <li>‚Ä¢ ${validSessions.length} workout sessions</li>
                                <li>‚Ä¢ Export date: ${new Date(importedData.exportDate).toLocaleDateString()}</li>
                                <li>‚Ä¢ Data version: ${importedData.version || 'Unknown'}</li>
                            </ul>
                        </div>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Choose how to import:</p>
                        <div class="space-y-3">
                            <button onclick="confirmImport(true); this.closest('.fixed').remove()" class="w-full px-6 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">
                                Replace Current Data
                            </button>
                            <button onclick="confirmImport(false); this.closest('.fixed').remove()" class="w-full px-6 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">
                                Merge with Current Data
                            </button>
                            <button onclick="this.closest('.fixed').remove(); delete window.pendingImportSessions;" class="w-full px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function showCSVImportConfirmDialog(validSessions) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            
            // Calculate summary stats
            const totalExercises = validSessions.reduce((sum, s) => sum + s.exercises.length, 0);
            const dateRange = validSessions.length > 0 ? {
                earliest: new Date(Math.min(...validSessions.map(s => s.date))),
                latest: new Date(Math.max(...validSessions.map(s => s.date)))
            } : null;
            
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-md w-full mx-4 modal-enter-active">
                    <div class="text-center">
                        <div class="text-4xl mb-4 animate-bounce-in">üìä</div>
                        <h3 class="text-lg font-semibold mb-2">Import CSV Data</h3>
                        <div class="text-left mb-4 p-3 bg-gray-100 dark:bg-gray-700 rounded">
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">Import Summary:</p>
                            <ul class="text-xs space-y-1">
                                <li>‚Ä¢ ${validSessions.length} workout sessions</li>
                                <li>‚Ä¢ ${totalExercises} total exercise sets</li>
                                ${dateRange ? `<li>‚Ä¢ Date range: ${dateRange.earliest.toLocaleDateString()} to ${dateRange.latest.toLocaleDateString()}</li>` : ''}
                                <li>‚Ä¢ Complete sessions: ${validSessions.filter(s => s.isComplete).length}</li>
                            </ul>
                        </div>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Choose how to import:</p>
                        <div class="space-y-3">
                            <button onclick="confirmCSVImport(true); this.closest('.fixed').remove()" class="w-full px-6 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">
                                Replace Current Data
                            </button>
                            <button onclick="confirmCSVImport(false); this.closest('.fixed').remove()" class="w-full px-6 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">
                                Merge with Current Data
                            </button>
                            <button onclick="this.closest('.fixed').remove()" class="w-full px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            window.pendingCSVImportSessions = validSessions;
            document.body.appendChild(modal);
        }

        async function confirmImport(replace) {
            const sessionsToImport = window.pendingImportSessions;

            if (!sessionsToImport) {
                console.error('‚ùå No pending import sessions found');
                showToast('Import error: No data available', 'error');
                return;
            }

            console.log('üîÑ Starting import process...');
            console.log('üìä Sessions to import:', sessionsToImport.length);
            console.log('üìä Current sessions before import:', workoutSessions.length);

            try {
                if (replace) {
                    workoutSessions = [...sessionsToImport];
                } else {
                    const existingIds = new Set(workoutSessions.map(s => s.id));
                    const newSessions = sessionsToImport.filter(s => !existingIds.has(s.id));

                    workoutSessions = [...workoutSessions, ...newSessions];
                    workoutSessions.sort((a, b) => new Date(b.date) - new Date(a.date));
                }

                if (workoutSessions.length > 20) {
                    workoutSessions = workoutSessions.slice(0, 20);
                }

                // Auto-save to IndexedDB
                await saveWorkoutSessions();

                console.log('üìä Final sessions after import:', workoutSessions.length);
                
                // Close the modal
                const modal = document.querySelector('.fixed.inset-0.bg-black.bg-opacity-50');
                if (modal) {
                    modal.remove();
                    console.log('‚úÖ Modal closed');
                }
                
                // Force update all UI components
                updateAllDataRelatedUI();
                
                // Explicitly show elements and log their state
                setTimeout(() => {
                    console.log('üîç Checking UI elements after import...');
                    
                    const quickStats = document.getElementById('quickStats');
                    const trainingSummaryButton = document.getElementById('trainingSummaryButton');
                    
                    if (workoutSessions.length > 0) {
                        if (quickStats) {
                            quickStats.classList.remove('hidden');
                            console.log('‚úÖ Showed quick stats');
                        }
                        if (trainingSummaryButton) {
                            trainingSummaryButton.classList.remove('hidden');
                            console.log('‚úÖ Showed training summary button');
                        }
                        
                        // Force update quick stats again
                        updateQuickStats();
                        console.log('‚úÖ Called updateQuickStats');
                    }
                }, 200);
                
                const action = replace ? 'replaced' : 'merged';
                showToast(`Successfully ${action} workout data! ${sessionsToImport.length} sessions imported.`, 'success');
                
            } catch (error) {
                console.error('‚ùå Import failed:', error);
                showToast(`Import failed: ${error.message}`, 'error');
            } finally {
                delete window.pendingImportSessions;
            }
        }

        async function confirmCSVImport(replace) {
            const sessionsToImport = window.pendingCSVImportSessions;

            if (replace) {
                workoutSessions = [...sessionsToImport];
            } else {
                const existingIds = new Set(workoutSessions.map(s => s.id));
                const newSessions = sessionsToImport.filter(s => !existingIds.has(s.id));

                workoutSessions = [...workoutSessions, ...newSessions];
                workoutSessions.sort((a, b) => new Date(b.date) - new Date(a.date));
            }

            if (workoutSessions.length > 20) {
                workoutSessions = workoutSessions.slice(0, 20);
            }

            // Auto-save to IndexedDB
            await saveWorkoutSessions();

            // Force update all UI components
            updateAllDataRelatedUI();
            
            // Ensure training summary button is shown with a slight delay
            setTimeout(() => {
                const trainingSummaryButton = document.getElementById('trainingSummaryButton');
                if (trainingSummaryButton && workoutSessions.length > 0) {
                    trainingSummaryButton.classList.remove('hidden');
                }
                updateQuickStats(); // Force refresh
            }, 100);
            
            const action = replace ? 'replaced' : 'merged';
            showToast(`Successfully ${action} CSV data! ${sessionsToImport.length} sessions imported.`, 'success');
            
            delete window.pendingCSVImportSessions;
        }

        function analyzeWorkoutData() {
            if (workoutSessions.length === 0) {
                showToast('No workout data to analyze. Complete some workouts first!', 'error');
                return;
            }
            
            showProgressChartsModal();
        }

        function showProgressChartsModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-6xl max-h-[90vh] overflow-hidden">
                    <div class="flex items-center justify-between p-6 border-b border-gray-200 dark:border-gray-700">
                        <div class="flex items-center gap-3">
                            <span class="text-3xl">üìä</span>
                            <div>
                                <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-200">Progress Analytics</h2>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Your strength progression over time</p>
                            </div>
                        </div>
                        <button onclick="closeChartsModal()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 text-2xl">√ó</button>
                    </div>
                    
                    <div class="overflow-y-auto max-h-[calc(90vh-120px)] custom-scrollbar">
                        <!-- Chart Container - Now at the top -->
                        <div class="bg-gray-50 dark:bg-gray-900 rounded-xl p-4 mb-4 mx-6">
                            <div id="chartContainer" style="position: relative; height: 350px; width: 100%;">
                                <canvas id="progressChart" style="max-height: 350px;"></canvas>
                            </div>
                        </div>
                        
                        <!-- Compact Chart Controls -->
                        <div class="px-6 mb-4">
                            <div class="flex flex-wrap gap-2 justify-center">
                                <button id="weightProgressBtn" onclick="showWeightProgressChart()" class="px-3 py-1.5 bg-primary text-white rounded-lg hover:bg-primary/80 transition-colors text-sm font-medium">üìà Weight</button>
                                <button id="volumeChartBtn" onclick="showVolumeChart()" class="px-3 py-1.5 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors text-sm font-medium">üìä Volume</button>
                                <button id="frequencyChartBtn" onclick="showFrequencyChart()" class="px-3 py-1.5 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors text-sm font-medium">üî¢ Frequency</button>
                                <button id="strengthChartBtn" onclick="showStrengthChart()" class="px-3 py-1.5 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors text-sm font-medium">üí™ Strength</button>
                            </div>
                        </div>
                        
                        <!-- Stats Summary -->
                        <div class="px-6 pb-6">
                            <div id="chartStats" class="grid grid-cols-2 md:grid-cols-4 gap-3">
                                <!-- Stats will be populated dynamically -->
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Clean up any existing chart
            cleanupChart();
            
            // Initialize with weight progress chart after a short delay
            setTimeout(() => {
                initializeCharts();
                showWeightProgressChart();
            }, 200);
        }

        function closeChartsModal() {
            cleanupChart();
            const modal = document.querySelector('.fixed.inset-0.bg-black.bg-opacity-50');
            if (modal) {
                modal.remove();
            }
        }

        function cleanupChart() {
            if (window.currentChart) {
                try {
                    // Properly destroy chart instance to prevent memory leaks
                    window.currentChart.destroy();
                    console.log('‚úÖ Chart destroyed successfully');
                } catch (e) {
                    console.warn('Chart cleanup error:', e);
                }
                window.currentChart = null;
            }

            // Also clear canvas context if it exists
            const canvas = document.getElementById('progressChart');
            if (canvas) {
                const ctx = canvas.getContext('2d');
                if (ctx) {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                }
            }
        }

        function initializeCharts() {
            // Ensure Chart.js is available
            if (typeof Chart === 'undefined') {
                console.error('Chart.js not loaded');
                return false;
            }
            
            // Register required Chart.js components
            try {
                Chart.register(...Chart.defaults.datasets);
            } catch (e) {
                // Already registered or not needed
            }
            
            return true;
        }

        function showWeightProgressChart() {
            updateChartButtons('weightProgressBtn');
            
            const exerciseData = analyzeExerciseProgress();
            
            // Check if we have data
            if (Object.keys(exerciseData).length === 0) {
                showFallbackChart('No workout data available yet. Complete some workouts to see your progress!');
                return;
            }
            
            // Clean up existing chart
            cleanupChart();
            
            const canvas = document.getElementById('progressChart');
            if (!canvas) {
                showFallbackChart('Chart display error');
                return;
            }
            
            try {
                const ctx = canvas.getContext('2d');
                
                // Check if Chart.js is available
                if (typeof Chart === 'undefined') {
                    showFallbackChart('Chart library not loaded');
                    return;
                }
                
                const datasets = Object.keys(exerciseData).map((exercise, index) => {
                    const colors = ['#5D5CDE', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6'];
                    return {
                        label: exercise,
                        data: exerciseData[exercise],
                        borderColor: colors[index % colors.length],
                        backgroundColor: colors[index % colors.length] + '20',
                        tension: 0.3,
                        fill: false
                    };
                });
                
                window.currentChart = new Chart(ctx, {
                    type: 'line',
                    data: { datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: 'Weight Progress Over Time',
                                font: { size: 16, weight: 'bold' }
                            },
                            legend: {
                                position: 'top'
                            }
                        },
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    unit: 'day',
                                    displayFormats: {
                                        day: 'MMM dd'
                                    }
                                },
                                title: {
                                    display: true,
                                    text: 'Date'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Weight (kg)'
                                },
                                beginAtZero: false
                            }
                        }
                    }
                });
                
                updateChartStats('weight');
            } catch (error) {
                console.error('Error creating weight progress chart:', error);
                showFallbackChart('Unable to create chart. Try refreshing the page.');
            }
        }

        function showVolumeChart() {
            updateChartButtons('volumeChartBtn');
            
            const volumeData = analyzeVolumeProgress();
            const ctx = document.getElementById('progressChart').getContext('2d');
            
            if (window.currentChart) {
                window.currentChart.destroy();
            }
            
            window.currentChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: volumeData.labels,
                    datasets: [{
                        label: 'Total Volume (kg)',
                        data: volumeData.data,
                        backgroundColor: '#5D5CDE60',
                        borderColor: '#5D5CDE',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Training Volume Over Time',
                            font: { size: 16, weight: 'bold' }
                        }
                    },
                    scales: {
                        y: {
                            title: {
                                display: true,
                                text: 'Total Volume (kg)'
                            },
                            beginAtZero: true
                        }
                    }
                }
            });
            
            updateChartStats('volume');
        }

        function showFrequencyChart() {
            updateChartButtons('frequencyChartBtn');
            
            const frequencyData = analyzeWorkoutFrequency();
            const ctx = document.getElementById('progressChart').getContext('2d');
            
            if (window.currentChart) {
                window.currentChart.destroy();
            }
            
            window.currentChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Workout A', 'Workout B'],
                    datasets: [{
                        data: [frequencyData.workoutA, frequencyData.workoutB],
                        backgroundColor: ['#5D5CDE', '#10B981'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Workout Type Distribution',
                            font: { size: 16, weight: 'bold' }
                        }
                    }
                }
            });
            
            updateChartStats('frequency');
        }

        function showStrengthChart() {
            updateChartButtons('strengthChartBtn');
            
            const strengthData = analyzeStrengthRatios();
            const ctx = document.getElementById('progressChart').getContext('2d');
            
            if (window.currentChart) {
                window.currentChart.destroy();
            }
            
            window.currentChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: Object.keys(strengthData),
                    datasets: [{
                        label: 'Current Max (kg)',
                        data: Object.values(strengthData),
                        backgroundColor: '#5D5CDE30',
                        borderColor: '#5D5CDE',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Strength Profile',
                            font: { size: 16, weight: 'bold' }
                        }
                    },
                    scales: {
                        r: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Weight (kg)'
                            },
                            grid: {
                                color: 'rgba(128, 128, 128, 0.5)' // Gray grid lines visible in both modes
                            },
                            angleLines: {
                                color: 'rgba(128, 128, 128, 0.5)' // Gray angle lines visible in both modes
                            },
                            pointLabels: {
                                color: '#666', // Dark gray for light mode
                                font: {
                                    size: 12
                                }
                            },
                            ticks: {
                                color: '#888', // Medium gray for tick labels
                                backdropColor: 'transparent'
                            }
                        }
                    }
                }
            });
            
            updateChartStats('strength');
        }

        function updateChartButtons(activeBtn) {
            ['weightProgressBtn', 'volumeChartBtn', 'frequencyChartBtn', 'strengthChartBtn'].forEach(btnId => {
                const btn = document.getElementById(btnId);
                if (btn) {
                    if (btnId === activeBtn) {
                        btn.className = 'px-3 py-1.5 bg-primary text-white rounded-lg hover:bg-primary/80 transition-colors text-xs font-medium';
                    } else {
                        btn.className = 'px-3 py-1.5 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors text-xs font-medium';
                    }
                }
            });
        }

        function analyzeExerciseProgress() {
            const exerciseData = {};
            
            workoutSessions.forEach(session => {
                session.exercises.forEach(exercise => {
                    if (!exerciseData[exercise.exercise]) {
                        exerciseData[exercise.exercise] = [];
                    }
                    
                    exerciseData[exercise.exercise].push({
                        x: session.date,
                        y: exercise.weight
                    });
                });
            });
            
            // Sort by date and remove duplicates (take max weight per day)
            Object.keys(exerciseData).forEach(exercise => {
                const dailyMax = {};
                exerciseData[exercise].forEach(point => {
                    const dateKey = point.x.toDateString();
                    if (!dailyMax[dateKey] || dailyMax[dateKey].y < point.y) {
                        dailyMax[dateKey] = point;
                    }
                });
                exerciseData[exercise] = Object.values(dailyMax).sort((a, b) => a.x - b.x);
            });
            
            return exerciseData;
        }

        function analyzeVolumeProgress() {
            const dailyVolume = {};
            
            workoutSessions.forEach(session => {
                const dateKey = session.date.toLocaleDateString();
                const sessionVolume = session.exercises.reduce((sum, ex) => sum + (ex.weight * ex.reps), 0);
                
                if (!dailyVolume[dateKey]) {
                    dailyVolume[dateKey] = 0;
                }
                dailyVolume[dateKey] += sessionVolume;
            });
            
            const sortedDates = Object.keys(dailyVolume).sort((a, b) => new Date(a) - new Date(b));
            
            return {
                labels: sortedDates,
                data: sortedDates.map(date => dailyVolume[date])
            };
        }

        function analyzeWorkoutFrequency() {
            let workoutA = 0;
            let workoutB = 0;
            
            workoutSessions.forEach(session => {
                if (session.workoutType === 'A') workoutA++;
                else if (session.workoutType === 'B') workoutB++;
            });
            
            return { workoutA, workoutB };
        }

        function analyzeStrengthRatios() {
            const maxWeights = {};
            
            workoutSessions.forEach(session => {
                session.exercises.forEach(exercise => {
                    if (!maxWeights[exercise.exercise] || maxWeights[exercise.exercise] < exercise.weight) {
                        maxWeights[exercise.exercise] = exercise.weight;
                    }
                });
            });
            
            return maxWeights;
        }

        // Add the missing showFallbackChart function
        function showFallbackChart(message) {
            const chartContainer = document.getElementById('chartContainer');
            if (!chartContainer) return;

            // Check if we're in a modal or in the tab
            const isInModal = document.querySelector('.fixed.inset-0.bg-black.bg-opacity-50') !== null;

            chartContainer.innerHTML = `
                <div class="flex flex-col items-center justify-center h-full text-center py-8">
                    <div class="text-5xl mb-3">üìä</div>
                    <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-300 mb-2">Charts Not Available</h3>
                    <p class="text-sm text-gray-500 dark:text-gray-400 max-w-md px-4">${message}</p>
                    ${isInModal ? `
                        <button onclick="closeChartsModal()" class="mt-4 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/80 transition-colors text-sm">
                            Close
                        </button>
                    ` : ''}
                </div>
            `;

            // Clear stats
            const statsContainer = document.getElementById('chartStats');
            if (statsContainer) {
                statsContainer.innerHTML = `
                    <div class="col-span-full p-3 bg-gray-100 dark:bg-gray-700 rounded-lg text-center">
                        <p class="text-xs text-gray-500 dark:text-gray-400">Complete your first workout to see statistics!</p>
                    </div>
                `;
            }
        }

        function updateChartStats(chartType) {
            const statsContainer = document.getElementById('chartStats');
            if (!statsContainer) return;
            
            let statsHTML = '';
            
            if (chartType === 'weight') {
                const progressData = analyzeExerciseProgress();
                const exercises = Object.keys(progressData);
                
                exercises.forEach(exercise => {
                    const data = progressData[exercise];
                    if (data.length > 1) {
                        const firstWeight = data[0].y;
                        const lastWeight = data[data.length - 1].y;
                        const gain = lastWeight - firstWeight;
                        const gainPercent = Math.round((gain / firstWeight) * 100);
                        
                        statsHTML += `
                            <div class="p-4 bg-white dark:bg-gray-700 rounded-lg">
                                <h4 class="font-semibold text-sm text-gray-700 dark:text-gray-300">${exercise}</h4>
                                <p class="text-lg font-bold text-primary">${formatWeight(lastWeight)}</p>
                                <p class="text-xs ${gain >= 0 ? 'text-green-600' : 'text-red-600'}">
                                    ${gain >= 0 ? '+' : ''}${formatWeight(gain)} (${gainPercent >= 0 ? '+' : ''}${gainPercent}%)
                                </p>
                            </div>
                        `;
                    }
                });
            } else if (chartType === 'volume') {
                const volumeData = analyzeVolumeProgress();
                const totalVolume = volumeData.data.reduce((sum, vol) => sum + vol, 0);
                const avgVolume = totalVolume / volumeData.data.length;
                const maxVolume = Math.max(...volumeData.data);
                const sessions = workoutSessions.length;
                
                statsHTML = `
                    <div class="p-4 bg-white dark:bg-gray-700 rounded-lg">
                        <h4 class="font-semibold text-sm text-gray-700 dark:text-gray-300">Total Volume</h4>
                        <p class="text-lg font-bold text-primary">${Math.round(totalVolume)}kg</p>
                    </div>
                    <div class="p-4 bg-white dark:bg-gray-700 rounded-lg">
                        <h4 class="font-semibold text-sm text-gray-700 dark:text-gray-300">Avg per Session</h4>
                        <p class="text-lg font-bold text-primary">${Math.round(avgVolume)}kg</p>
                    </div>
                    <div class="p-4 bg-white dark:bg-gray-700 rounded-lg">
                        <h4 class="font-semibold text-sm text-gray-700 dark:text-gray-300">Best Session</h4>
                        <p class="text-lg font-bold text-primary">${Math.round(maxVolume)}kg</p>
                    </div>
                    <div class="p-4 bg-white dark:bg-gray-700 rounded-lg">
                        <h4 class="font-semibold text-sm text-gray-700 dark:text-gray-300">Total Sessions</h4>
                        <p class="text-lg font-bold text-primary">${sessions}</p>
                    </div>
                `;
            } else if (chartType === 'frequency') {
                const freqData = analyzeWorkoutFrequency();
                const total = freqData.workoutA + freqData.workoutB;
                const aPercent = Math.round((freqData.workoutA / total) * 100) || 0;
                const bPercent = Math.round((freqData.workoutB / total) * 100) || 0;
                
                statsHTML = `
                    <div class="p-4 bg-white dark:bg-gray-700 rounded-lg">
                        <h4 class="font-semibold text-sm text-gray-700 dark:text-gray-300">Workout A</h4>
                        <p class="text-lg font-bold text-primary">${freqData.workoutA} (${aPercent}%)</p>
                    </div>
                    <div class="p-4 bg-white dark:bg-gray-700 rounded-lg">
                        <h4 class="font-semibold text-sm text-gray-700 dark:text-gray-300">Workout B</h4>
                        <p class="text-lg font-bold text-primary">${freqData.workoutB} (${bPercent}%)</p>
                    </div>
                    <div class="p-4 bg-white dark:bg-gray-700 rounded-lg">
                        <h4 class="font-semibold text-sm text-gray-700 dark:text-gray-300">Total Sessions</h4>
                        <p class="text-lg font-bold text-primary">${total}</p>
                    </div>
                    <div class="p-4 bg-white dark:bg-gray-700 rounded-lg">
                        <h4 class="font-semibold text-sm text-gray-700 dark:text-gray-300">Balance</h4>
                        <p class="text-lg font-bold text-primary">${Math.abs(aPercent - bPercent) <= 10 ? 'Good' : 'Uneven'}</p>
                    </div>
                `;
            } else if (chartType === 'strength') {
                const strengthData = analyzeStrengthRatios();
                const exercises = Object.keys(strengthData);
                
                exercises.forEach(exercise => {
                    statsHTML += `
                        <div class="p-4 bg-white dark:bg-gray-700 rounded-lg">
                            <h4 class="font-semibold text-sm text-gray-700 dark:text-gray-300">${exercise}</h4>
                            <p class="text-lg font-bold text-primary">${formatWeight(strengthData[exercise])}</p>
                        </div>
                    `;
                });
            }
            
            statsContainer.innerHTML = statsHTML;
        }

        function showPersonalBestsModal() {
            if (workoutSessions.length === 0) {
                showToast('No workout data available. Complete some workouts first!', 'error');
                return;
            }
            
            const personalBests = calculatePersonalBests();
            const achievements = calculateAchievements();
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden">
                    <div class="flex items-center justify-between p-6 border-b border-gray-200 dark:border-gray-700">
                        <div class="flex items-center gap-3">
                            <span class="text-3xl">üèÜ</span>
                            <div>
                                <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-200">Personal Records</h2>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Your best performances and achievements</p>
                            </div>
                        </div>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 text-2xl">√ó</button>
                    </div>
                    
                    <div class="p-6 overflow-y-auto max-h-[calc(90vh-120px)] custom-scrollbar">
                        <!-- Personal Records -->
                        <div class="mb-8">
                            <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                                üí™ Personal Records
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                ${Object.keys(personalBests.maxWeight).map(exercise => `
                                    <div class="p-4 bg-gradient-to-br from-yellow-50 to-orange-50 dark:from-yellow-900/20 dark:to-orange-900/20 rounded-xl border-2 border-yellow-200 dark:border-yellow-700">
                                        <div class="flex items-center justify-between mb-2">
                                            <h4 class="font-semibold text-gray-700 dark:text-gray-300">${exercise}</h4>
                                            <span class="text-2xl">ü•á</span>
                                        </div>
                                        <p class="text-2xl font-bold text-yellow-600 dark:text-yellow-400">${formatWeight(personalBests.maxWeight[exercise].weight)}</p>
                                        <p class="text-xs text-gray-600 dark:text-gray-400">${formatDate(personalBests.maxWeight[exercise].date)}</p>
                                        <p class="text-xs text-gray-500 dark:text-gray-500">${personalBests.maxWeight[exercise].reps} reps</p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <!-- Volume Records -->
                        <div class="mb-8">
                            <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                                üìä Volume Records
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="p-4 bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 rounded-xl border-2 border-blue-200 dark:border-blue-700">
                                    <h4 class="font-semibold text-gray-700 dark:text-gray-300 mb-2">Best Single Session</h4>
                                    <p class="text-2xl font-bold text-blue-600 dark:text-blue-400">${Math.round(personalBests.maxSessionVolume.volume)}kg</p>
                                    <p class="text-xs text-gray-600 dark:text-gray-400">${formatDate(personalBests.maxSessionVolume.date)}</p>
                                </div>
                                <div class="p-4 bg-gradient-to-br from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20 rounded-xl border-2 border-green-200 dark:border-green-700">
                                    <h4 class="font-semibold text-gray-700 dark:text-gray-300 mb-2">Most Sets</h4>
                                    <p class="text-2xl font-bold text-green-600 dark:text-green-400">${personalBests.maxSets.sets}</p>
                                    <p class="text-xs text-gray-600 dark:text-gray-400">${formatDate(personalBests.maxSets.date)}</p>
                                </div>
                                <div class="p-4 bg-gradient-to-br from-purple-50 to-pink-50 dark:from-purple-900/20 dark:to-pink-900/20 rounded-xl border-2 border-purple-200 dark:border-purple-700">
                                    <h4 class="font-semibold text-gray-700 dark:text-gray-300 mb-2">Longest Session</h4>
                                    <p class="text-2xl font-bold text-purple-600 dark:text-purple-400">${personalBests.longestSession.duration}min</p>
                                    <p class="text-xs text-gray-600 dark:text-gray-400">${formatDate(personalBests.longestSession.date)}</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Achievements -->
                        <div class="mb-6">
                            <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                                üéñÔ∏è Achievements
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                ${achievements.map(achievement => `
                                    <div class="p-4 bg-gradient-to-br ${achievement.earned ? 'from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20' : 'from-gray-50 to-gray-100 dark:from-gray-800 dark:to-gray-700'} rounded-xl border-2 ${achievement.earned ? 'border-green-200 dark:border-green-700' : 'border-gray-200 dark:border-gray-600'} ${achievement.earned ? '' : 'opacity-60'}">
                                        <div class="flex items-center justify-between mb-2">
                                            <h4 class="font-semibold ${achievement.earned ? 'text-green-700 dark:text-green-300' : 'text-gray-600 dark:text-gray-400'}">${achievement.name}</h4>
                                            <span class="text-2xl">${achievement.earned ? achievement.icon : 'üîí'}</span>
                                        </div>
                                        <p class="text-sm ${achievement.earned ? 'text-green-600 dark:text-green-400' : 'text-gray-500 dark:text-gray-500'}">${achievement.description}</p>
                                        ${achievement.earned ? `<p class="text-xs text-green-500 dark:text-green-400 mt-1">‚úÖ Unlocked</p>` : `<p class="text-xs text-gray-400 mt-1">üîí Locked</p>`}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // Helper function to safely format dates
        function formatDate(date) {
            if (!date) return 'N/A';
            try {
                const d = typeof date === 'string' ? new Date(date) : date;
                if (isNaN(d.getTime())) return 'N/A';
                return d.toLocaleDateString();
            } catch (e) {
                return 'N/A';
            }
        }

        function calculatePersonalBests() {
            const maxWeight = {};
            let maxSessionVolume = { volume: 0, date: null };
            let maxSets = { sets: 0, date: null };
            let longestSession = { duration: 0, date: null };

            workoutSessions.forEach(session => {
                // Calculate session volume and sets
                const sessionVolume = session.exercises.reduce((sum, ex) => sum + (ex.weight * ex.reps), 0);
                const sessionSets = session.exercises.length;

                // Check for max session volume
                if (sessionVolume > maxSessionVolume.volume) {
                    maxSessionVolume = { volume: sessionVolume, date: session.date };
                }

                // Check for max sets
                if (sessionSets > maxSets.sets) {
                    maxSets = { sets: sessionSets, date: session.date };
                }

                // Check for longest session
                if (session.statistics && session.statistics.duration > longestSession.duration) {
                    longestSession = { duration: session.statistics.duration, date: session.date };
                }

                // Check for max weights per exercise
                session.exercises.forEach(exercise => {
                    if (!maxWeight[exercise.exercise] || exercise.weight > maxWeight[exercise.exercise].weight) {
                        maxWeight[exercise.exercise] = {
                            weight: exercise.weight,
                            reps: exercise.reps,
                            date: session.date
                        };
                    }
                });
            });

            return {
                maxWeight,
                maxSessionVolume,
                maxSets,
                longestSession
            };
        }

        function calculateAchievements() {
            const totalSessions = workoutSessions.length;
            const totalVolume = workoutSessions.reduce((sum, session) => 
                sum + session.exercises.reduce((sessionSum, ex) => sessionSum + (ex.weight * ex.reps), 0), 0
            );
            const personalBests = calculatePersonalBests();
            const maxWeights = personalBests.maxWeight;
            
            const achievements = [
                {
                    name: "First Steps",
                    description: "Complete your first workout",
                    icon: "üèÉ",
                    earned: totalSessions >= 1
                },
                {
                    name: "Getting Started",
                    description: "Complete 5 workouts",
                    icon: "üí™",
                    earned: totalSessions >= 5
                },
                {
                    name: "Consistent",
                    description: "Complete 10 workouts",
                    icon: "üî•",
                    earned: totalSessions >= 10
                },
                {
                    name: "Dedicated",
                    description: "Complete 25 workouts",
                    icon: "‚≠ê",
                    earned: totalSessions >= 25
                },
                {
                    name: "Volume King",
                    description: "Lift 10,000kg total volume",
                    icon: "üëë",
                    earned: totalVolume >= 10000
                },
                {
                    name: "Squat Warrior", 
                    description: "Squat 100kg or more",
                    icon: "üèãÔ∏è",
                    earned: maxWeights.Squats && maxWeights.Squats.weight >= 100
                },
                {
                    name: "Bench Beast",
                    description: "Bench Press 80kg or more", 
                    icon: "üí•",
                    earned: maxWeights['Bench Press'] && maxWeights['Bench Press'].weight >= 80
                },
                {
                    name: "Deadlift Destroyer",
                    description: "Deadlift 120kg or more",
                    icon: "‚ö°",
                    earned: maxWeights.Deadlift && maxWeights.Deadlift.weight >= 120
                },
                {
                    name: "Marathon Session",
                    description: "Complete a workout over 60 minutes",
                    icon: "‚è∞",
                    earned: personalBests.longestSession.duration >= 60
                },
                {
                    name: "Volume Beast",
                    description: "Complete a 2000kg+ session",
                    icon: "ü¶æ",
                    earned: personalBests.maxSessionVolume.volume >= 2000
                }
            ];
            
            return achievements;
        }

        function openWorkoutCreator() {
            showWorkoutCreatorModal();
        }

        function showWorkoutCreatorModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden">
                    <div class="flex items-center justify-between p-6 border-b border-gray-200 dark:border-gray-700">
                        <div class="flex items-center gap-3">
                            <span class="text-3xl">üìù</span>
                            <div>
                                <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-200">Create Workout History</h2>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Manually add past workout sessions</p>
                            </div>
                        </div>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 text-2xl">√ó</button>
                    </div>
                    
                    <div class="p-6 overflow-y-auto max-h-[calc(90vh-120px)] custom-scrollbar">
                        <form id="workoutCreatorForm" class="space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Workout Date</label>
                                    <input type="date" id="workoutDate" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base focus:ring-2 focus:ring-primary focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Workout Type</label>
                                    <select id="workoutType" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base focus:ring-2 focus:ring-primary focus:border-transparent">
                                        <option value="">Select workout type</option>
                                        <option value="A">Workout A</option>
                                        <option value="B">Workout B</option>
                                        <option value="CUSTOM">Custom Workout</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Duration (minutes)</label>
                                <input type="number" id="workoutDuration" min="1" max="300" value="60" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base focus:ring-2 focus:ring-primary focus:border-transparent">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Exercises</label>
                                <div id="exerciseList" class="space-y-3">
                                    <div class="exercise-entry grid grid-cols-2 md:grid-cols-5 gap-2 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                        <div>
                                            <label class="block text-xs font-medium mb-1">Exercise</label>
                                            <select class="exercise-name w-full px-2 py-1 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-600 text-sm" required>
                                                <option value="">Select...</option>
                                                <option value="Squats">Squats</option>
                                                <option value="Deadlift">Deadlift</option>
                                                <option value="Bench Press">Bench Press</option>
                                                <option value="Overhead Press">Overhead Press</option>
                                                <option value="Barbell Rows">Barbell Rows</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium mb-1">Weight (kg)</label>
                                            <input type="number" class="exercise-weight w-full px-2 py-1 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-600 text-sm" min="0" step="2.5" required>
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium mb-1">Reps</label>
                                            <input type="number" class="exercise-reps w-full px-2 py-1 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-600 text-sm" min="1" max="50" required>
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium mb-1">Sets</label>
                                            <input type="number" class="exercise-sets w-full px-2 py-1 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-600 text-sm" min="1" max="10" value="1" required>
                                        </div>
                                        <div class="flex items-end">
                                            <button type="button" onclick="removeExerciseEntry(this)" class="w-full px-2 py-1 bg-red-500 text-white rounded text-sm hover:bg-red-600 transition-colors">Remove</button>
                                        </div>
                                    </div>
                                </div>
                                <button type="button" onclick="addExerciseEntry()" class="mt-3 px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors text-sm">
                                    + Add Exercise
                                </button>
                            </div>
                            
                            <div class="flex gap-3 pt-4">
                                <button type="button" onclick="this.closest('.fixed').remove()" class="flex-1 px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                                    Cancel
                                </button>
                                <button type="submit" class="flex-1 px-6 py-3 gradient-primary text-white rounded-lg hover:shadow-lg transition-all duration-300">
                                    Create Workout
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Set default date to today
            document.getElementById('workoutDate').value = new Date().toISOString().split('T')[0];
            
            // Add form submit handler
            document.getElementById('workoutCreatorForm').addEventListener('submit', function(e) {
                e.preventDefault();
                createManualWorkout();
            });
        }

        function addExerciseEntry() {
            const exerciseList = document.getElementById('exerciseList');
            const newEntry = document.createElement('div');
            newEntry.className = 'exercise-entry grid grid-cols-2 md:grid-cols-5 gap-2 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg';
            newEntry.innerHTML = `
                <div>
                    <label class="block text-xs font-medium mb-1">Exercise</label>
                    <select class="exercise-name w-full px-2 py-1 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-600 text-sm" required>
                        <option value="">Select...</option>
                        <option value="Squats">Squats</option>
                        <option value="Deadlift">Deadlift</option>
                        <option value="Bench Press">Bench Press</option>
                        <option value="Overhead Press">Overhead Press</option>
                        <option value="Barbell Rows">Barbell Rows</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-medium mb-1">Weight (kg)</label>
                    <input type="number" class="exercise-weight w-full px-2 py-1 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-600 text-sm" min="0" step="2.5" required>
                </div>
                <div>
                    <label class="block text-xs font-medium mb-1">Reps</label>
                    <input type="number" class="exercise-reps w-full px-2 py-1 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-600 text-sm" min="1" max="50" required>
                </div>
                <div>
                    <label class="block text-xs font-medium mb-1">Sets</label>
                    <input type="number" class="exercise-sets w-full px-2 py-1 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-600 text-sm" min="1" max="10" value="1" required>
                </div>
                <div class="flex items-end">
                    <button type="button" onclick="removeExerciseEntry(this)" class="w-full px-2 py-1 bg-red-500 text-white rounded text-sm hover:bg-red-600 transition-colors">Remove</button>
                </div>
            `;
            exerciseList.appendChild(newEntry);
        }

        function removeExerciseEntry(button) {
            const exerciseList = document.getElementById('exerciseList');
            if (exerciseList.children.length > 1) {
                button.closest('.exercise-entry').remove();
            } else {
                showToast('You must have at least one exercise', 'error');
            }
        }

        function createManualWorkout() {
            const date = new Date(document.getElementById('workoutDate').value + 'T12:00:00');
            const workoutType = document.getElementById('workoutType').value;
            const duration = parseInt(document.getElementById('workoutDuration').value);
            
            const exercises = [];
            const exerciseEntries = document.querySelectorAll('.exercise-entry');
            
            exerciseEntries.forEach((entry, entryIndex) => {
                const exerciseName = entry.querySelector('.exercise-name').value;
                const weight = parseFloat(entry.querySelector('.exercise-weight').value);
                const reps = parseInt(entry.querySelector('.exercise-reps').value);
                const sets = parseInt(entry.querySelector('.exercise-sets').value);
                
                if (exerciseName && weight && reps && sets) {
                    for (let set = 1; set <= sets; set++) {
                        exercises.push({
                            exercise: exerciseName,
                            setNumber: set,
                            reps: reps,
                            weight: weight,
                            targetReps: reps,
                            timestamp: new Date(date.getTime() + (entryIndex * sets + set) * 3 * 60 * 1000)
                        });
                    }
                }
            });
            
            if (exercises.length === 0) {
                showToast('Please add at least one exercise', 'error');
                return;
            }
            
            const workoutSession = {
                id: Date.now() + Math.random(),
                date: date,
                workoutType: workoutType,
                exercises: exercises,
                isComplete: true,
                statistics: {
                    totalSets: exercises.length,
                    completedTargets: exercises.length, // All manual entries are considered completed
                    duration: duration
                }
            };
            
            workoutSessions.unshift(workoutSession);
            
            if (workoutSessions.length > 20) {
                workoutSessions = workoutSessions.slice(0, 20);
            }
            
            updateAllDataRelatedUI();
            
            document.querySelector('.fixed.inset-0').remove();
            showToast(`Manual workout created with ${exercises.length} sets!`, 'success');
        }

        // Storage diagnostic function
        async function checkStorageDiagnostic() {
            console.log('üîç Running comprehensive storage diagnostic...');

            let diagnosticHTML = '<div class="text-left space-y-3 text-sm">';

            // Check IndexedDB
            diagnosticHTML += `<div><strong>IndexedDB Status:</strong> ${isIndexedDBAvailable ? '‚úÖ Available' : '‚ùå Not Available'}</div>`;

            // Check localStorage
            diagnosticHTML += `<div><strong>localStorage Status:</strong> ${isLocalStorageAvailable ? '‚úÖ Available' : '‚ùå Not Available'}</div>`;

            // Check what's in localStorage
            if (isLocalStorageAvailable) {
                try {
                    // eslint-disable-next-line no-restricted-globals
                    const lsData = localStorage.getItem('workoutSessions');
                    if (lsData) {
                        const parsed = JSON.parse(lsData);
                        diagnosticHTML += `<div><strong>localStorage Data:</strong> ‚úÖ ${parsed.length} sessions (${(lsData.length / 1024).toFixed(2)} KB)</div>`;
                    } else {
                        diagnosticHTML += `<div><strong>localStorage Data:</strong> ‚ùå No data found</div>`;
                    }

                    // eslint-disable-next-line no-restricted-globals
                    const allKeys = Object.keys(localStorage);
                    diagnosticHTML += `<div><strong>localStorage Keys:</strong> ${allKeys.join(', ') || 'None'}</div>`;
                } catch (e) {
                    diagnosticHTML += `<div><strong>localStorage Error:</strong> ‚ùå ${e.message}</div>`;
                }
            }

            // Check current memory data
            diagnosticHTML += `<div><strong>Current Session Data:</strong> ${workoutSessions.length} sessions in memory</div>`;

            // Try reading with SafeStorage
            try {
                const data = await SafeStorage.getItem('workoutSessions');
                if (data) {
                    const parsed = JSON.parse(data);
                    diagnosticHTML += `<div><strong>SafeStorage Read:</strong> ‚úÖ ${parsed.length} sessions</div>`;
                } else {
                    diagnosticHTML += `<div><strong>SafeStorage Read:</strong> ‚ùå No data</div>`;
                }
            } catch (e) {
                diagnosticHTML += `<div><strong>SafeStorage Error:</strong> ‚ùå ${e.message}</div>`;
            }

            // Environment info
            diagnosticHTML += `<div class="mt-2 pt-2 border-t border-gray-300 dark:border-gray-600"><strong>Environment:</strong></div>`;
            diagnosticHTML += `<div class="text-xs">Standalone PWA: ${window.matchMedia('(display-mode: standalone)').matches ? 'Yes' : 'No'}</div>`;
            diagnosticHTML += `<div class="text-xs">User Agent: ${navigator.userAgent.substring(0, 50)}...</div>`;

            diagnosticHTML += '</div>';

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-2xl w-full mx-4 modal-enter-active max-h-[80vh] overflow-y-auto">
                    <div class="mb-4">
                        <h3 class="text-xl font-bold text-gray-800 dark:text-gray-200 mb-2">üîç Storage Diagnostic</h3>
                        <p class="text-xs text-gray-600 dark:text-gray-400">Check browser console for detailed logs</p>
                    </div>
                    ${diagnosticHTML}
                    <button onclick="this.closest('.fixed').remove()" class="mt-4 w-full px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                        Close
                    </button>
                </div>
            `;

            document.body.appendChild(modal);

            console.log('‚úÖ Storage diagnostic complete - see modal for summary');
        }

        function clearAllHistory() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4 modal-enter-active">
                    <div class="text-center">
                        <div class="text-4xl mb-4">‚ö†Ô∏è</div>
                        <h3 class="text-lg font-semibold mb-2">Clear All History?</h3>
                        <p class="text-gray-600 dark:text-gray-400 mb-4">This will permanently delete all workout sessions. This action cannot be undone.</p>
                        <div class="flex gap-3 justify-center">
                            <button onclick="this.closest('.fixed').remove()" class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">Cancel</button>
                            <button onclick="confirmClearHistory(); this.closest('.fixed').remove()" class="px-6 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">Clear All</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function confirmClearHistory() {
            workoutSessions = [];

            // Clear from IndexedDB
            await saveWorkoutSessions();

            updateAllDataRelatedUI();
            showToast('All workout history cleared', 'info');
        }

        function updateWorkoutHistoryDisplay() {
            // Placeholder function for workout history display
        }

        function showWorkoutHistoryModal() {
            if (workoutSessions.length === 0) {
                showToast('No workout history available yet. Complete some workouts first!', 'info');
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-6xl max-h-[90vh] overflow-hidden">
                    <div class="flex items-center justify-between p-6 border-b border-gray-200 dark:border-gray-700">
                        <div class="flex items-center gap-3">
                            <span class="text-3xl">üìö</span>
                            <div>
                                <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-200">Workout History</h2>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Your complete training log - ${workoutSessions.length} sessions</p>
                            </div>
                        </div>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 text-2xl">√ó</button>
                    </div>
                    
                    <div class="overflow-y-auto max-h-[calc(90vh-120px)] custom-scrollbar">
                        <!-- Filter Controls -->
                        <div class="p-6 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900">
                            <div class="flex flex-wrap gap-2 justify-center">
                                <button onclick="filterHistoryModal('all')" id="historyFilterAll" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/80 transition-colors text-sm font-medium">All</button>
                                <button onclick="filterHistoryModal('A')" id="historyFilterA" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors text-sm font-medium">Workout A</button>
                                <button onclick="filterHistoryModal('B')" id="historyFilterB" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors text-sm font-medium">Workout B</button>
                                <button onclick="filterHistoryModal('CUSTOM')" id="historyFilterCustom" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors text-sm font-medium">Custom</button>
                                <button onclick="filterHistoryModal('complete')" id="historyFilterComplete" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors text-sm font-medium">Complete Only</button>
                            </div>
                        </div>
                        
                        <!-- History Content -->
                        <div id="historyModalContent" class="p-6">
                            ${generateHistoryContent()}
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Set up global filter state
            window.currentHistoryFilter = 'all';
        }
        
        function generateHistoryContent() {
            let content = '';
            
            const filteredSessions = getFilteredSessions(window.currentHistoryFilter || 'all');
            
            if (filteredSessions.length === 0) {
                return `
                    <div class="text-center py-12">
                        <div class="text-6xl mb-4">üìù</div>
                        <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-300 mb-2">No Sessions Found</h3>
                        <p class="text-gray-500 dark:text-gray-400">Try adjusting your filter or complete some workouts!</p>
                    </div>
                `;
            }
            
            // Group sessions by month for better organization
            const sessionsByMonth = {};
            filteredSessions.forEach(session => {
                const monthKey = session.date.toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
                if (!sessionsByMonth[monthKey]) {
                    sessionsByMonth[monthKey] = [];
                }
                sessionsByMonth[monthKey].push(session);
            });
            
            // Generate content for each month
            Object.keys(sessionsByMonth).sort((a, b) => new Date(sessionsByMonth[b][0].date) - new Date(sessionsByMonth[a][0].date)).forEach(month => {
                const sessions = sessionsByMonth[month];
                
                content += `
                    <div class="mb-8">
                        <h3 class="text-lg font-bold text-gray-700 dark:text-gray-300 mb-4 sticky top-0 bg-white dark:bg-gray-800 py-2 border-b border-gray-200 dark:border-gray-700">
                            üìÖ ${month} (${sessions.length} sessions)
                        </h3>
                        <div class="space-y-4">
                            ${sessions.map(session => generateSessionCard(session)).join('')}
                        </div>
                    </div>
                `;
            });
            
            return content;
        }
        
        function generateSessionCard(session) {
            const workoutName = session.workoutType === 'A' ? 'Workout A' : 
                               session.workoutType === 'B' ? 'Workout B' : 'Custom Workout';
            
            const exerciseGroups = {};
            session.exercises.forEach(entry => {
                if (!exerciseGroups[entry.exercise]) {
                    exerciseGroups[entry.exercise] = [];
                }
                exerciseGroups[entry.exercise].push(entry);
            });
            
            const totalVolume = session.exercises.reduce((sum, ex) => sum + (ex.weight * ex.reps), 0);
            const timeSince = getTimeSince(session.date);
            
            const statusBadge = session.isComplete ? 
                '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300">‚úÖ Complete</span>' : 
                '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-300">‚ö† Incomplete</span>';
                
            const borderColor = session.isComplete ? 'border-green-200 dark:border-green-700' : 'border-red-200 dark:border-red-700';
            
            let exercisesHTML = '';
            Object.keys(exerciseGroups).forEach(exerciseName => {
                const sets = exerciseGroups[exerciseName];
                const maxWeight = Math.max(...sets.map(s => s.weight));
                const avgReps = Math.round(sets.reduce((sum, s) => sum + s.reps, 0) / sets.length);
                const setsCompleted = sets.length;
                
                exercisesHTML += `
                    <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <div class="flex-1 min-w-0">
                            <h5 class="font-semibold text-sm text-gray-800 dark:text-gray-200 truncate">${exerciseName}</h5>
                            <p class="text-xs text-gray-600 dark:text-gray-400">${setsCompleted} sets √ó ${avgReps} reps avg</p>
                        </div>
                        <div class="text-right ml-3 flex-shrink-0">
                            <p class="text-sm font-bold text-primary">${formatWeight(maxWeight)}</p>
                            <p class="text-xs text-gray-600 dark:text-gray-400">max weight</p>
                        </div>
                    </div>
                `;
            });
            
            return `
                <div class="bg-white dark:bg-gray-800 rounded-xl p-4 sm:p-6 border-2 ${borderColor} hover:shadow-lg transition-all duration-300 mb-4">
                    <!-- Header Section -->
                    <div class="flex flex-col sm:flex-row sm:items-start gap-4 mb-6">
                        <!-- Left Side: Workout Info -->
                        <div class="flex items-center gap-3 flex-1 min-w-0">
                            <div class="w-12 h-12 rounded-full ${session.workoutType === 'A' ? 'bg-blue-100 dark:bg-blue-900/30' : session.workoutType === 'B' ? 'bg-green-100 dark:bg-green-900/30' : 'bg-purple-100 dark:bg-purple-900/30'} flex items-center justify-center flex-shrink-0">
                                <span class="text-xl">${session.workoutType === 'A' ? 'üèãÔ∏è' : session.workoutType === 'B' ? 'üî•' : 'üìù'}</span>
                            </div>
                            <div class="min-w-0 flex-1">
                                <div class="flex flex-col sm:flex-row sm:items-center gap-2 mb-2">
                                    <h4 class="text-lg font-bold text-gray-800 dark:text-gray-200">${workoutName}</h4>
                                    ${statusBadge}
                                </div>
                                <p class="text-sm text-gray-600 dark:text-gray-400">${session.date.toLocaleDateString()} at ${session.date.toLocaleTimeString()}</p>
                                <p class="text-xs text-gray-500 dark:text-gray-500">${timeSince}</p>
                            </div>
                        </div>
                        
                        <!-- Right Side: Stats Grid -->
                        <div class="flex-shrink-0">
                            <div class="grid grid-cols-2 gap-3 text-center">
                                <div class="bg-blue-50 dark:bg-blue-900/30 rounded-lg p-2">
                                    <div class="text-lg font-bold text-blue-600 dark:text-blue-400">${session.statistics.totalSets}</div>
                                    <div class="text-xs text-blue-600 dark:text-blue-400">Sets</div>
                                </div>
                                <div class="bg-green-50 dark:bg-green-900/30 rounded-lg p-2">
                                    <div class="text-lg font-bold text-green-600 dark:text-green-400">${session.statistics.completedTargets}</div>
                                    <div class="text-xs text-green-600 dark:text-green-400">Targets</div>
                                </div>
                                <div class="bg-purple-50 dark:bg-purple-900/30 rounded-lg p-2">
                                    <div class="text-sm font-bold text-purple-600 dark:text-purple-400">${session.statistics.duration}min</div>
                                    <div class="text-xs text-purple-600 dark:text-purple-400">Duration</div>
                                </div>
                                <div class="bg-orange-50 dark:bg-orange-900/30 rounded-lg p-2">
                                    <div class="text-sm font-bold text-orange-600 dark:text-orange-400">${Math.round(totalVolume)}kg</div>
                                    <div class="text-xs text-orange-600 dark:text-orange-400">Volume</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Exercises Section -->
                    <div class="space-y-3">
                        ${exercisesHTML}
                    </div>
                </div>
            `;
        }
        
        function filterHistoryModal(filter) {
            // Update button states
            ['historyFilterAll', 'historyFilterA', 'historyFilterB', 'historyFilterCustom', 'historyFilterComplete'].forEach(btnId => {
                const btn = document.getElementById(btnId);
                if (btn) {
                    if ((filter === 'all' && btnId === 'historyFilterAll') ||
                        (filter === 'A' && btnId === 'historyFilterA') ||
                        (filter === 'B' && btnId === 'historyFilterB') ||
                        (filter === 'CUSTOM' && btnId === 'historyFilterCustom') ||
                        (filter === 'complete' && btnId === 'historyFilterComplete')) {
                        btn.className = 'px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/80 transition-colors text-sm font-medium';
                    } else {
                        btn.className = 'px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors text-sm font-medium';
                    }
                }
            });
            
            // Update filter state and content
            window.currentHistoryFilter = filter;
            const content = document.getElementById('historyModalContent');
            if (content) {
                content.innerHTML = generateHistoryContent();
            }
        }
        
        function getFilteredSessions(filter) {
            switch (filter) {
                case 'A':
                    return workoutSessions.filter(s => s.workoutType === 'A');
                case 'B':
                    return workoutSessions.filter(s => s.workoutType === 'B');
                case 'CUSTOM':
                    return workoutSessions.filter(s => s.workoutType === 'CUSTOM');
                case 'complete':
                    return workoutSessions.filter(s => s.isComplete);
                case 'all':
                default:
                    return workoutSessions;
            }
        }

        // Workout completion and history functions
        function completeWorkout() {
            // Stop both timers
            stopWorkoutTimer();
            stopRestTimer();

            // Save the session
            saveWorkoutSession(true);

            // Show completion modal
            showWorkoutCompleteModal();

            // Check if backup reminder should be shown (every 5th workout)
            setTimeout(() => {
                checkBackupReminder();
            }, 2000); // Show after completion modal
        }

        async function saveWorkoutSession(isComplete = true) {
            try {
                if (workoutHistory.length === 0) {
                    console.warn('No workout history to save');
                    return;
                }

                const workoutSession = {
                    id: Date.now() + Math.random(),
                    date: new Date(),
                    workoutType: currentWorkoutType,
                    exercises: [...workoutHistory],
                    isComplete: isComplete,
                    statistics: {
                        totalSets: workoutHistory.length,
                        completedTargets: workoutHistory.filter(ex => ex.reps >= ex.targetReps).length,
                        duration: Math.floor(workoutElapsedSeconds / 60) // in minutes
                    }
                };

                // Add to sessions array
                workoutSessions.unshift(workoutSession);

                // Keep only last 20 sessions to prevent memory issues
                if (workoutSessions.length > 20) {
                    workoutSessions = workoutSessions.slice(0, 20);
                }

                // Auto-save to IndexedDB
                await saveWorkoutSessions();

                console.log('‚úÖ Workout session saved:', workoutSession);
                return workoutSession;
            } catch (error) {
                console.error('Error saving workout session:', error);
                showToast('Failed to save workout session', 'error');
                return null;
            }
        }

        function updateWorkoutHistory() {
            try {
                const workoutHistoryElement = document.getElementById('workoutHistory');
                if (!workoutHistoryElement) {
                    console.warn('workoutHistory element not found, trying workoutHistoryMain');
                    const fallbackElement = document.getElementById('workoutHistoryMain');
                    if (fallbackElement) {
                        updateWorkoutHistoryMain(fallbackElement);
                    }
                    return;
                }
                
                updateWorkoutHistoryMain(workoutHistoryElement);
            } catch (error) {
                console.error('Error in updateWorkoutHistory:', error);
                const workoutHistoryElement = document.getElementById('workoutHistory');
                if (workoutHistoryElement) {
                    workoutHistoryElement.innerHTML = '<p class="text-red-500 text-center">Error displaying workout history</p>';
                }
            }
        }
        
        function updateWorkoutHistoryMain(workoutHistoryElement) {
            // Ensure workoutHistory is always an array
            if (!Array.isArray(workoutHistory)) {
                console.warn('workoutHistory is not an array, reinitializing...');
                workoutHistory = [];
            }

            if (workoutHistory.length === 0) {
                workoutHistoryElement.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center text-sm">No completed sets yet</p>';
                return;
            }

            // Group sets by exercise
            const exerciseGroups = {};
            workoutHistory.forEach(entry => {
                if (!entry || !entry.exercise) return;

                if (!exerciseGroups[entry.exercise]) {
                    exerciseGroups[entry.exercise] = {
                        exercise: entry.exercise,
                        sets: [],
                        totalReps: 0,
                        totalVolume: 0,
                        weight: entry.weight || 0
                    };
                }

                exerciseGroups[entry.exercise].sets.push({
                    reps: entry.reps,
                    targetReps: entry.targetReps
                });
                exerciseGroups[entry.exercise].totalReps += entry.reps || 0;
                exerciseGroups[entry.exercise].totalVolume += (entry.weight || 0) * (entry.reps || 0);
            });

            // Generate compact summary
            let historyHTML = `
                <div class="mb-3 p-3 bg-gradient-to-r from-primary/10 to-purple-500/10 rounded-lg border-2 border-primary/30">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="text-sm font-bold text-primary">Workout ${currentWorkoutType || 'Session'}</div>
                            <div class="text-xs text-gray-600 dark:text-gray-400">In Progress</div>
                        </div>
                        <div class="text-right">
                            <div class="text-lg font-bold text-primary">${workoutHistory.length}</div>
                            <div class="text-xs text-gray-600 dark:text-gray-400">Total Sets</div>
                        </div>
                    </div>
                </div>
            `;

            // Show each exercise summary
            Object.values(exerciseGroups).forEach(group => {
                const completedSets = group.sets.filter(s => s.reps >= s.targetReps).length;
                const totalSets = group.sets.length;
                const completionRate = Math.round((completedSets / totalSets) * 100);

                historyHTML += `
                    <div class="p-3 bg-white dark:bg-gray-700 rounded-lg mb-2">
                        <div class="flex items-center justify-between mb-2">
                            <div class="font-semibold text-sm">${group.exercise}</div>
                            <div class="text-xs text-gray-500 dark:text-gray-400">${formatWeight(group.weight)}</div>
                        </div>
                        <div class="flex items-center justify-between text-xs">
                            <div>
                                <span class="font-medium">${completedSets}/${totalSets} sets</span>
                                <span class="text-gray-500 dark:text-gray-400"> ‚Ä¢ ${group.totalReps} reps</span>
                            </div>
                            <div class="font-medium text-primary">${formatWeight(group.totalVolume)}</div>
                        </div>
                        <div class="mt-2 w-full bg-gray-200 dark:bg-gray-600 rounded-full h-1.5">
                            <div class="bg-primary h-1.5 rounded-full transition-all" style="width: ${completionRate}%"></div>
                        </div>
                    </div>
                `;
            });

            workoutHistoryElement.innerHTML = historyHTML;
        }

        function showWorkoutCompleteModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            
            const totalSets = workoutHistory.length;
            const completedTargets = workoutHistory.filter(ex => ex.reps >= ex.targetReps).length;
            const completionRate = Math.round((completedTargets / totalSets) * 100);
            const duration = Math.floor(workoutElapsedSeconds / 60);
            const totalVolume = workoutHistory.reduce((sum, ex) => sum + (ex.weight * ex.reps), 0);
            
            modal.innerHTML = `
                <div class="bg-gradient-to-br from-white to-gray-50 dark:from-gray-800 dark:to-gray-900 p-4 md:p-6 rounded-2xl shadow-2xl max-w-md w-full mx-4 modal-enter-active border-2 border-primary/20 max-h-screen overflow-y-auto">
                    <div class="text-center">
                        <!-- Celebration Icon -->
                        <div class="relative inline-block mb-3">
                            <div class="text-4xl md:text-5xl animate-bounce-in">üéâ</div>
                            <div class="absolute -top-1 -right-1 text-2xl">‚ú®</div>
                            <div class="absolute -bottom-1 -left-1 text-2xl">üí™</div>
                        </div>

                        <!-- Title -->
                        <h3 class="text-xl md:text-2xl font-bold mb-1 bg-gradient-to-r from-primary to-purple-600 bg-clip-text text-transparent">
                            Workout Complete!
                        </h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Great job! Here's your workout summary:</p>

                        <!-- Stats Grid -->
                        <div class="grid grid-cols-2 gap-2 md:gap-3 mb-6">
                            <div class="p-3 bg-gradient-to-br from-blue-50 to-blue-100 dark:from-blue-900/30 dark:to-blue-800/30 rounded-lg border-2 border-blue-200 dark:border-blue-700">
                                <div class="text-2xl md:text-3xl font-bold text-blue-600 dark:text-blue-400">${totalSets}</div>
                                <div class="text-xs font-medium text-blue-700 dark:text-blue-300 mt-1">Total Sets</div>
                            </div>
                            <div class="p-3 bg-gradient-to-br from-green-50 to-green-100 dark:from-green-900/30 dark:to-green-800/30 rounded-lg border-2 border-green-200 dark:border-green-700">
                                <div class="text-2xl md:text-3xl font-bold text-green-600 dark:text-green-400">${completionRate}%</div>
                                <div class="text-xs font-medium text-green-700 dark:text-green-300 mt-1">Target Hit Rate</div>
                            </div>
                            <div class="p-3 bg-gradient-to-br from-purple-50 to-purple-100 dark:from-purple-900/30 dark:to-purple-800/30 rounded-lg border-2 border-purple-200 dark:border-purple-700">
                                <div class="text-2xl md:text-3xl font-bold text-purple-600 dark:text-purple-400">${duration}min</div>
                                <div class="text-xs font-medium text-purple-700 dark:text-purple-300 mt-1">Duration</div>
                            </div>
                            <div class="p-3 bg-gradient-to-br from-orange-50 to-orange-100 dark:from-orange-900/30 dark:to-orange-800/30 rounded-lg border-2 border-orange-200 dark:border-orange-700">
                                <div class="text-2xl md:text-3xl font-bold text-orange-600 dark:text-orange-400">${Math.round(totalVolume)}kg</div>
                                <div class="text-xs font-medium text-orange-700 dark:text-orange-300 mt-1">Total Volume</div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="space-y-2">
                            <button onclick="goBackToHome(); this.closest('.fixed').remove()"
                                    class="w-full px-4 py-3 gradient-primary text-white rounded-lg hover:shadow-xl transition-all duration-300 font-semibold text-sm md:text-base">
                                üè† Back to Home
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function showExerciseCompleteModal() {
            const modal = document.getElementById('exerciseCompleteModal');
            const message = document.getElementById('exerciseCompleteMessage');
            const continueBtn = document.getElementById('continueBtn');
            
            if (!modal || !message || !continueBtn) return;
            
            const completedExercise = workoutPlan[currentExerciseIndex - 1];
            message.textContent = `${completedExercise.name} complete! Moving to next exercise.`;
            
            continueBtn.onclick = () => {
                modal.classList.add('hidden');
                loadCurrentExercise();
            };
            
            modal.classList.remove('hidden');
        }

        function exitWorkout() {
            if (workoutHistory.length > 0) {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4 modal-enter-active">
                        <div class="text-center">
                            <div class="text-4xl mb-4">‚ö†Ô∏è</div>
                            <h3 class="text-lg font-semibold mb-2 text-gray-800 dark:text-gray-200">Exit Workout?</h3>
                            <p class="text-gray-600 dark:text-gray-400 mb-4">You have completed ${workoutHistory.length} sets. Your progress will be saved as an incomplete workout.</p>
                            <div class="space-y-3">
                                <button onclick="stopRestTimer(); saveWorkoutSession(false); resetWorkoutState(); goBackToHome(); this.closest('.fixed').remove()"
                                        class="w-full px-6 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition-colors">
                                    Save & Exit
                                </button>
                                <button onclick="stopRestTimer(); resetWorkoutState(); goBackToHome(); this.closest('.fixed').remove()"
                                        class="w-full px-6 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">
                                    Exit Without Saving
                                </button>
                                <button onclick="this.closest('.fixed').remove()"
                                        class="w-full px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                                    Continue Workout
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            } else {
                // No workout in progress, just go back to home
                stopRestTimer(); // Stop any lingering rest timer
                resetWorkoutState();
                goBackToHome();
            }
        }

        // Progressive Overload and Deload Functions
        function checkForDeload() {
            if (workoutSessions.length < 6) return null; // Need at least 6 sessions to check
            
            const recentSessions = workoutSessions.slice(0, 6);
            const exerciseFailures = {};
            
            recentSessions.forEach(session => {
                session.exercises.forEach(exercise => {
                    if (!exerciseFailures[exercise.exercise]) {
                        exerciseFailures[exercise.exercise] = 0;
                    }
                    
                    // Count as failure if couldn't complete target reps
                    if (exercise.reps < exercise.targetReps) {
                        exerciseFailures[exercise.exercise]++;
                    }
                });
            });
            
            // Suggest deload if any exercise failed 3+ times in last 6 sessions
            const deloadSuggestions = {};
            let needsDeload = false;
            
            Object.keys(exerciseFailures).forEach(exercise => {
                if (exerciseFailures[exercise] >= 3) {
                    deloadSuggestions[exercise] = {
                        failures: exerciseFailures[exercise],
                        recommendedReduction: 10 // 10% reduction
                    };
                    needsDeload = true;
                }
            });
            
            return needsDeload ? deloadSuggestions : null;
        }

        let currentSetupTab = 0;

        function setupWorkoutConfiguration() {
            const exercises = workouts[currentWorkoutType].exercises;
            const exerciseTabs = document.getElementById('exerciseTabs');
            const exerciseConfigPanels = document.getElementById('exerciseConfigPanels');

            if (!exerciseTabs || !exerciseConfigPanels) return;

            exerciseTabs.innerHTML = '';
            exerciseConfigPanels.innerHTML = '';
            workoutPlan = [];
            currentSetupTab = 0;

            // Create tabs and panels
            exercises.forEach((exercise, index) => {
                const lastWeight = getLastWeightForExercise(exercise);
                const suggestedWeight = calculateSuggestedWeight(exercise, lastWeight);

                // Deadlift should always default to 1 set
                const defaultSets = exercise.toLowerCase().includes('deadlift') ? 1 : parseInt(document.getElementById('globalSets')?.value || 5);

                const exerciseConfig = {
                    name: exercise,
                    weight: suggestedWeight,
                    sets: defaultSets,
                    targetReps: getTargetRepsForExercise(exercise),
                    restTime: parseInt(document.getElementById('globalRestTime')?.value || 180)
                };

                workoutPlan.push(exerciseConfig);

                // Create tab button with compact styling
                const isActive = index === 0;
                const tabHTML = `
                    <button onclick="switchSetupTab(${index})"
                            id="setupTab_${index}"
                            class="flex-shrink-0 px-3 py-2 rounded-lg font-semibold text-xs md:text-sm transition-all duration-200 whitespace-nowrap ${
                                isActive
                                    ? 'bg-primary text-white shadow-lg'
                                    : 'bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600'
                            }">
                        ${exercise}
                    </button>
                `;
                exerciseTabs.innerHTML += tabHTML;

                // Create panel
                const panelHTML = `
                    <div id="setupPanel_${index}" class="exercise-setup-panel ${isActive ? '' : 'hidden'}">
                        <div class="bg-white dark:bg-gray-700 rounded-xl p-4 md:p-6 border-2 border-primary">
                            <div class="flex items-center justify-between mb-4">
                                <h4 class="text-xl md:text-2xl font-bold text-primary">${exercise}</h4>
                                <span class="text-xs md:text-sm text-gray-500 dark:text-gray-400">Exercise ${index + 1} of ${exercises.length}</span>
                            </div>

                            <div class="grid grid-cols-2 gap-3 md:gap-4 mb-4">
                                <div>
                                    <label class="block text-xs md:text-sm font-medium mb-1">Weight (${getWeightUnit()})</label>
                                    <input id="weight_${index}" type="number" value="${suggestedWeight}" min="0" max="500" step="2.5"
                                           class="w-full px-3 py-2 border-2 border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base focus:ring-2 focus:ring-primary focus:border-primary"
                                           onchange="updateWorkoutPlan(${index}, 'weight', this.value)">
                                </div>
                                <div>
                                    <label class="block text-xs md:text-sm font-medium mb-1">Target Reps</label>
                                    <input id="reps_${index}" type="number" value="${exerciseConfig.targetReps}" min="1" max="20"
                                           class="w-full px-3 py-2 border-2 border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base focus:ring-2 focus:ring-primary focus:border-primary"
                                           onchange="updateWorkoutPlan(${index}, 'targetReps', this.value)">
                                </div>
                                <div>
                                    <label class="block text-xs md:text-sm font-medium mb-1">Sets</label>
                                    <input id="sets_${index}" type="number" value="${exerciseConfig.sets}" min="1" max="10"
                                           class="w-full px-3 py-2 border-2 border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base focus:ring-2 focus:ring-primary focus:border-primary"
                                           onchange="updateWorkoutPlan(${index}, 'sets', this.value)">
                                </div>
                                <div>
                                    <label class="block text-xs md:text-sm font-medium mb-1">Rest Time</label>
                                    <select id="rest_${index}" onchange="updateWorkoutPlan(${index}, 'restTime', this.value)"
                                            class="w-full px-2 py-2 border-2 border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-sm md:text-base focus:ring-2 focus:ring-primary focus:border-primary">
                                        <option value="120" ${exerciseConfig.restTime === 120 ? 'selected' : ''}>2 minutes</option>
                                        <option value="180" ${exerciseConfig.restTime === 180 ? 'selected' : ''}>3 minutes</option>
                                        <option value="240" ${exerciseConfig.restTime === 240 ? 'selected' : ''}>4 minutes</option>
                                        <option value="300" ${exerciseConfig.restTime === 300 ? 'selected' : ''}>5 minutes</option>
                                    </select>
                                </div>
                            </div>

                            ${lastWeight > 0 ? `
                                <div class="p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg border-2 border-blue-200 dark:border-blue-700 mb-4">
                                    <p class="text-xs md:text-sm text-blue-700 dark:text-blue-300 break-words">
                                        üí° Last: ${formatWeight(lastWeight)} | Suggested: ${formatWeight(suggestedWeight)}${suggestedWeight > lastWeight ? ` (+${formatWeight(suggestedWeight - lastWeight)})` : ''}
                                    </p>
                                </div>
                            ` : ''}

                            <!-- Navigation buttons -->
                            <div class="flex gap-2 md:gap-3">
                                ${index > 0 ? `
                                    <button onclick="switchSetupTab(${index - 1})"
                                            class="flex-1 px-4 py-2.5 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors font-semibold text-sm md:text-base">
                                        ‚Üê Previous
                                    </button>
                                ` : '<div class="flex-1"></div>'}
                                ${index < exercises.length - 1 ? `
                                    <button onclick="switchSetupTab(${index + 1})"
                                            class="flex-1 px-4 py-2.5 gradient-primary text-white rounded-lg hover:shadow-lg transition-all duration-300 font-semibold text-sm md:text-base">
                                        Next ‚Üí
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
                exerciseConfigPanels.innerHTML += panelHTML;
            });

            // Show progressive overload setting if user has history
            if (workoutSessions.length > 0) {
                const globalIncrementSetting = document.getElementById('globalIncrementSetting');
                if (globalIncrementSetting) globalIncrementSetting.classList.remove('hidden');
            }
        }

        function switchSetupTab(tabIndex) {
            currentSetupTab = tabIndex;

            // Update tab buttons with compact styling
            document.querySelectorAll('[id^="setupTab_"]').forEach((tab, index) => {
                if (index === tabIndex) {
                    tab.className = 'flex-shrink-0 px-3 py-2 rounded-lg font-semibold text-xs md:text-sm transition-all duration-200 whitespace-nowrap bg-primary text-white shadow-lg';
                } else {
                    tab.className = 'flex-shrink-0 px-3 py-2 rounded-lg font-semibold text-xs md:text-sm transition-all duration-200 whitespace-nowrap bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600';
                }
            });

            // Update panels
            document.querySelectorAll('[id^="setupPanel_"]').forEach((panel, index) => {
                if (index === tabIndex) {
                    panel.classList.remove('hidden');
                } else {
                    panel.classList.add('hidden');
                }
            });

            // Scroll to top of panel
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function getLastWeightForExercise(exerciseName) {
            for (let session of workoutSessions) {
                for (let exercise of session.exercises) {
                    if (exercise.exercise === exerciseName) {
                        return exercise.weight;
                    }
                }
            }
            return 20; // Default starting weight
        }

        function calculateSuggestedWeight(exerciseName, lastWeight) {
            if (lastWeight === 20) return 20; // First time, start with bar
            
            const globalIncrement = parseFloat(document.getElementById('globalIncrement')?.value || 0);
            const recentPerformance = analyzeRecentPerformance(exerciseName);
            
            if (recentPerformance.shouldIncrease) {
                return lastWeight + (globalIncrement || 2.5);
            } else if (recentPerformance.shouldDecrease) {
                return Math.max(20, lastWeight - 5); // Never go below bar weight
            }
            
            return lastWeight; // Maintain current weight
        }

        function analyzeRecentPerformance(exerciseName) {
            const recentSets = [];
            let sessionCount = 0;
            
            // Get last 3 sessions for this exercise
            for (let session of workoutSessions) {
                if (sessionCount >= 3) break;
                
                const exerciseSets = session.exercises.filter(ex => ex.exercise === exerciseName);
                if (exerciseSets.length > 0) {
                    recentSets.push(...exerciseSets);
                    sessionCount++;
                }
            }
            
            if (recentSets.length === 0) {
                return { shouldIncrease: false, shouldDecrease: false };
            }
            
            // Calculate success rate (completed target reps)
            const successfulSets = recentSets.filter(set => set.reps >= set.targetReps);
            const successRate = successfulSets.length / recentSets.length;
            
            return {
                shouldIncrease: successRate >= 0.8, // 80%+ success rate
                shouldDecrease: successRate < 0.5,  // <50% success rate
                successRate
            };
        }

        function getTargetRepsForExercise(exerciseName) {
            // Different rep ranges for different exercises
            const repRanges = {
                'Deadlift': 5,
                'Squats': 5,
                'Overhead Press': 5,
                'Bench Press': 5,
                'Barbell Rows': 5
            };
            
            return repRanges[exerciseName] || 5;
        }

        function updateWorkoutPlan(exerciseIndex, property, value) {
            if (workoutPlan[exerciseIndex]) {
                workoutPlan[exerciseIndex][property] = property === 'weight' ? parseFloat(value) : parseInt(value);
                
                // Update plate calculator if weight changed
                if (property === 'weight') {
                    updatePlateCalculation(parseFloat(value));
                }
            }
        }

        function updatePlateCalculation(weight) {
            const plateWeight = Math.max(0, weight - 20); // Subtract bar weight
            const plateBreakdown = calculatePlateBreakdown(plateWeight);
            
            const plateWeightEl = document.getElementById('plateWeight');
            const totalCalculatedWeightEl = document.getElementById('totalCalculatedWeight');
            const plateBreakdownEl = document.getElementById('plateBreakdown');
            
            if (plateWeightEl) plateWeightEl.textContent = formatWeight(plateWeight, false);
            if (totalCalculatedWeightEl) totalCalculatedWeightEl.textContent = formatWeight(weight);
            
            if (plateBreakdownEl) {
                plateBreakdownEl.innerHTML = plateBreakdown.map(plate => 
                    `<span class="px-2 py-1 bg-blue-100 dark:bg-blue-800 text-blue-800 dark:text-blue-200 rounded text-xs">${plate}kg</span>`
                ).join('');
            }
        }

        function calculatePlateBreakdown(totalPlateWeight) {
            const plateWeights = [25, 20, 15, 10, 5, 2.5, 1.25]; // Available plates
            const breakdown = [];
            let remaining = totalPlateWeight / 2; // Weight per side
            
            plateWeights.forEach(plateWeight => {
                const count = Math.floor(remaining / plateWeight);
                if (count > 0) {
                    for (let i = 0; i < count; i++) {
                        breakdown.push(plateWeight);
                    }
                    remaining -= count * plateWeight;
                }
            });
            
            return breakdown;
        }

        function showDeloadModal(deloadInfo) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            
            const exerciseList = Object.keys(deloadInfo).map(exercise => {
                const info = deloadInfo[exercise];
                return `
                    <div class="flex justify-between items-center p-3 bg-red-50 dark:bg-red-900/20 rounded-lg mb-2">
                        <div>
                            <span class="font-semibold">${exercise}</span>
                            <p class="text-xs text-red-600 dark:text-red-400">${info.failures} failures in last 6 sessions</p>
                        </div>
                        <span class="text-sm font-bold text-red-700 dark:text-red-300">-${info.recommendedReduction}%</span>
                    </div>
                `;
            }).join('');
            
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-md w-full mx-4 modal-enter-active">
                    <div class="text-center mb-4">
                        <div class="text-4xl mb-4">‚ö†Ô∏è</div>
                        <h3 class="text-lg font-semibold mb-2 text-red-600 dark:text-red-400">Deload Week Recommended</h3>
                        <p class="text-gray-600 dark:text-gray-400 text-sm mb-4">
                            Your recent performance suggests you might benefit from reducing weights to focus on form and recovery.
                        </p>
                    </div>
                    
                    <div class="mb-4">
                        <h4 class="font-semibold mb-2">Exercises needing attention:</h4>
                        ${exerciseList}
                    </div>
                    
                    <div class="space-y-3">
                        <button onclick="applyDeload(); this.closest('.fixed').remove()" 
                                class="w-full px-6 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition-colors">
                            Apply Deload (-10%)
                        </button>
                        <button onclick="this.closest('.fixed').remove()" 
                                class="w-full px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                            Continue as Planned
                        </button>
                    </div>
                    
                    <div class="mt-4 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                        <p class="text-xs text-blue-700 dark:text-blue-300">
                            üí° <strong>Tip:</strong> Deload weeks help prevent injury and can lead to better long-term progress.
                        </p>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function applyDeload() {
            workoutPlan.forEach((exercise, index) => {
                const currentWeight = exercise.weight;
                const deloadWeight = Math.max(20, currentWeight * 0.9); // 10% reduction, minimum bar weight
                
                exercise.weight = deloadWeight;
                
                // Update the input field
                const weightInput = document.getElementById(`weight_${index}`);
                if (weightInput) {
                    weightInput.value = deloadWeight;
                }
            });
            
            showToast('Deload applied! Weights reduced by 10% for recovery week.', 'info');
        }

        // Workout execution functions
        // Track all exercise set data in one object
        let allExercisesSetData = {};

        function startEntireWorkout() {
            if (workoutPlan.length === 0) {
                showToast('Please configure your exercises first.', 'error');
                return;
            }

            // Hide setup, show execution
            document.getElementById('workoutSetupPhase').classList.add('hidden');
            document.getElementById('workoutExecutionPhase').classList.remove('hidden');

            // Initialize workout
            workoutHistory = [];
            allExercisesSetData = {};

            // Initialize set data for all exercises
            workoutPlan.forEach((exercise, index) => {
                allExercisesSetData[index] = new Array(exercise.sets).fill(0);
            });

            // Start workout timer
            startWorkoutTimer();

            // Create all exercise sections
            createAllExerciseSections();

            showToast('Workout started! Good luck! üí™', 'success');
        }

        function createAllExerciseSections() {
            const container = document.getElementById('allExercisesContainer');
            if (!container) return;

            container.innerHTML = '';

            workoutPlan.forEach((exercise, exerciseIndex) => {
                const section = document.createElement('div');
                section.className = 'p-4 bg-white dark:bg-gray-700 rounded-lg border-2 border-gray-200 dark:border-gray-600';

                // Create set buttons - just show reps number
                let setButtonsHTML = '';
                for (let setIndex = 0; setIndex < exercise.sets; setIndex++) {
                    setButtonsHTML += `
                        <button id="setBtn_${exerciseIndex}_${setIndex}"
                                onclick="toggleExerciseSetReps(${exerciseIndex}, ${setIndex})"
                                class="w-14 h-14 mobile-set-button rounded-full bg-gray-200 dark:bg-gray-600 text-gray-600 dark:text-gray-400 border-2 border-gray-300 dark:border-gray-500 font-bold text-xl hover:scale-110 transition-transform flex items-center justify-center">
                            <div id="reps_${exerciseIndex}_${setIndex}">0</div>
                        </button>
                    `;
                }

                section.innerHTML = `
                    <div class="flex items-center justify-between mb-3">
                        <div>
                            <h5 class="font-bold text-base">${exercise.name}</h5>
                            <p class="text-xs text-gray-600 dark:text-gray-400">${formatWeight(exercise.weight)} ‚Ä¢ ${exercise.targetReps} reps ‚Ä¢ ${Math.floor(exercise.restTime / 60)}min rest</p>
                        </div>
                    </div>
                    <div class="flex flex-wrap gap-2 justify-center">
                        ${setButtonsHTML}
                    </div>
                `;

                container.appendChild(section);
            });

            updateCompleteWorkoutButton();
            createAllExercisesDetails();
        }

        function createAllExercisesDetails() {
            const container = document.getElementById('allExercisesDetailsContainer');
            if (!container) return;

            container.innerHTML = '';

            workoutPlan.forEach((exercise, exerciseIndex) => {
                // Calculate plate loading
                const weight = exercise.weight;
                const barWeight = 20;
                const plateWeight = weight - barWeight;
                const perSide = plateWeight / 2;

                // Generate plate breakdown
                let platesHTML = '';
                if (perSide > 0) {
                    const plates = [25, 20, 15, 10, 5, 2.5, 1.25];
                    let remaining = perSide;
                    const plateColors = {
                        25: 'bg-red-500',
                        20: 'bg-blue-500',
                        15: 'bg-yellow-500',
                        10: 'bg-green-500',
                        5: 'bg-white border-2 border-gray-400 text-gray-900',
                        2.5: 'bg-red-300',
                        1.25: 'bg-gray-400'
                    };

                    plates.forEach(plate => {
                        const count = Math.floor(remaining / plate);
                        if (count > 0) {
                            const colorClass = plateColors[plate] || 'bg-gray-300';
                            for (let i = 0; i < count; i++) {
                                platesHTML += `<div class="${colorClass} text-white px-2 py-1 rounded text-xs font-bold">${plate}kg</div>`;
                            }
                            remaining -= count * plate;
                        }
                    });
                } else {
                    platesHTML = '<span class="text-xs text-gray-500">Empty bar (20kg)</span>';
                }

                const section = document.createElement('div');
                section.className = 'p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-800';
                section.innerHTML = `
                    <h5 class="font-bold text-base text-blue-700 dark:text-blue-300 mb-3">${exercise.name}</h5>

                    <div class="grid grid-cols-2 gap-3 text-sm mb-4">
                        <div>
                            <span class="text-gray-600 dark:text-gray-400">Weight:</span>
                            <span class="font-semibold ml-2">${formatWeight(exercise.weight)}</span>
                        </div>
                        <div>
                            <span class="text-gray-600 dark:text-gray-400">Target Reps:</span>
                            <span class="font-semibold ml-2">${exercise.targetReps}</span>
                        </div>
                        <div>
                            <span class="text-gray-600 dark:text-gray-400">Total Sets:</span>
                            <span class="font-semibold ml-2">${exercise.sets}</span>
                        </div>
                        <div>
                            <span class="text-gray-600 dark:text-gray-400">Rest Time:</span>
                            <span class="font-semibold ml-2">${Math.floor(exercise.restTime / 60)}min</span>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-gray-800 p-3 rounded-lg">
                        <h6 class="text-xs font-semibold text-blue-600 dark:text-blue-400 mb-2">üèãÔ∏è Plate Loading Guide</h6>
                        <p class="text-xs text-gray-600 dark:text-gray-400 mb-2">
                            <span class="font-semibold">20kg</span> barbell +
                            <span class="font-semibold">${formatWeight(plateWeight)}</span> plates =
                            <span class="font-semibold">${formatWeight(weight)}</span> total
                        </p>
                        <p class="text-xs text-gray-600 dark:text-gray-400 mb-2">Load on each side:</p>
                        <div class="flex flex-wrap gap-1 justify-center">
                            ${platesHTML}
                        </div>
                    </div>
                `;

                container.appendChild(section);
            });
        }

        function toggleExerciseSetReps(exerciseIndex, setIndex) {
            const exercise = workoutPlan[exerciseIndex];
            if (!exercise) return;

            const currentReps = allExercisesSetData[exerciseIndex][setIndex];
            const previousReps = currentReps;

            if (currentReps === 0) {
                // First tap: set to target reps
                allExercisesSetData[exerciseIndex][setIndex] = exercise.targetReps;
            } else if (currentReps > 0) {
                // Subsequent taps: decrease by 1
                allExercisesSetData[exerciseIndex][setIndex] = Math.max(0, currentReps - 1);
            }

            const newReps = allExercisesSetData[exerciseIndex][setIndex];

            updateExerciseSetButton(exerciseIndex, setIndex);
            recordSetInHistory(exerciseIndex, setIndex);
            updateCompleteWorkoutButton();

            // Start rest timer when completing a set (went from 0 to target reps)
            if (previousReps === 0 && newReps > 0) {
                console.log('üèãÔ∏è Set completed, starting rest timer');
                startRestTimer(exercise.restTime);
            }
        }

        function updateExerciseSetButton(exerciseIndex, setIndex) {
            const button = document.getElementById(`setBtn_${exerciseIndex}_${setIndex}`);
            const repsDisplay = document.getElementById(`reps_${exerciseIndex}_${setIndex}`);
            const exercise = workoutPlan[exerciseIndex];

            if (!button || !repsDisplay || !exercise) return;

            const reps = allExercisesSetData[exerciseIndex][setIndex];
            const targetReps = exercise.targetReps;

            repsDisplay.textContent = reps > 0 ? `${reps}` : '0';

            if (reps === 0) {
                button.className = 'w-14 h-14 mobile-set-button rounded-full bg-gray-200 dark:bg-gray-600 text-gray-600 dark:text-gray-400 border-2 border-gray-300 dark:border-gray-500 font-bold hover:scale-110 transition-transform flex flex-col items-center justify-center';
            } else if (reps >= targetReps) {
                button.className = 'w-14 h-14 mobile-set-button rounded-full bg-green-500 text-white border-2 border-green-600 font-bold hover:scale-110 transition-transform flex flex-col items-center justify-center';
            } else {
                button.className = 'w-14 h-14 mobile-set-button rounded-full bg-yellow-500 text-white border-2 border-yellow-600 font-bold hover:scale-110 transition-transform flex flex-col items-center justify-center';
            }
        }

        function recordSetInHistory(exerciseIndex, setIndex) {
            const exercise = workoutPlan[exerciseIndex];
            const reps = allExercisesSetData[exerciseIndex][setIndex];

            if (reps === 0) {
                // Remove from history if set back to 0
                const historyIndex = workoutHistory.findIndex(entry =>
                    entry.exercise === exercise.name && entry.setNumber === setIndex + 1
                );
                if (historyIndex >= 0) {
                    workoutHistory.splice(historyIndex, 1);
                }
            } else {
                // Update or add to history
                const existingIndex = workoutHistory.findIndex(entry =>
                    entry.exercise === exercise.name && entry.setNumber === setIndex + 1
                );

                const historyEntry = {
                    exercise: exercise.name,
                    setNumber: setIndex + 1,
                    reps: reps,
                    weight: exercise.weight,
                    targetReps: exercise.targetReps,
                    timestamp: new Date()
                };

                if (existingIndex >= 0) {
                    workoutHistory[existingIndex] = historyEntry;
                } else {
                    workoutHistory.push(historyEntry);
                }
            }

            updateWorkoutHistory();
        }

        function updateCompleteWorkoutButton() {
            const completeSection = document.getElementById('completeWorkoutSection');
            if (!completeSection) return;

            // Check if at least some sets are completed
            let hasCompletedSets = false;
            for (let exerciseIndex in allExercisesSetData) {
                if (allExercisesSetData[exerciseIndex].some(reps => reps > 0)) {
                    hasCompletedSets = true;
                    break;
                }
            }

            if (hasCompletedSets) {
                completeSection.classList.remove('hidden');
            } else {
                completeSection.classList.add('hidden');
            }
        }

        function loadCurrentExercise() {
            try {
                if (currentExerciseIndex >= workoutPlan.length) {
                    completeWorkout();
                    return;
                }

                const exercise = workoutPlan[currentExerciseIndex];
                if (!exercise) {
                    throw new Error('Invalid exercise data');
                }
                currentExercise = exercise;

                console.log('üèãÔ∏è Loading exercise:', exercise.name);

                // Safely update UI elements with null checks
                const exerciseNameEl = document.getElementById('exerciseName');
                if (exerciseNameEl) {
                    exerciseNameEl.textContent = exercise.name;
                    console.log('‚úÖ Updated exercise name');
                } else {
                    console.warn('‚ùå exerciseName element not found');
                }

                const exerciseProgressEl = document.getElementById('exerciseProgress');
                if (exerciseProgressEl) {
                    exerciseProgressEl.textContent = `Exercise ${currentExerciseIndex + 1} of ${workoutPlan.length}`;
                    console.log('‚úÖ Updated exercise progress');
                } else {
                    console.warn('‚ùå exerciseProgress element not found');
                }

                // Update exercise progress dots
                updateExerciseProgressDots();
                console.log('‚úÖ Updated exercise progress dots');

                // Safely update exercise details (these might not exist in tabbed layout)
                const exerciseDetails = {
                    'currentExerciseWeight': formatWeight(exercise.weight),
                    'currentExerciseReps': exercise.targetReps,
                    'currentExerciseSets': exercise.sets,
                    'currentExerciseRestTime': `${Math.floor(exercise.restTime / 60)}min`
                };

                Object.keys(exerciseDetails).forEach(elementId => {
                    const element = document.getElementById(elementId);
                    if (element) {
                        element.textContent = exerciseDetails[elementId];
                        console.log(`‚úÖ Updated ${elementId}`);
                    } else {
                        console.log(`‚ö†Ô∏è ${elementId} element not found (might be in different tab)`);
                    }
                });

                // Update plate calculator (safely)
                try {
                    updatePlateCalculation(exercise.weight);
                    console.log('‚úÖ Updated plate calculator');
                } catch (error) {
                    console.warn('‚ö†Ô∏è Plate calculator update failed:', error);
                }

                // Reset set tracking
                exercise.currentSet = 1;
                exercise.completedSets = 0;

                // Initialize new set tracking system
                console.log('üéØ Initializing set tracking...');
                initializeSetTracking();

                // Update progress list (safely)
                try {
                    updateWorkoutProgressList();
                    console.log('‚úÖ Updated progress list');
                } catch (error) {
                    console.warn('‚ö†Ô∏è Progress list update failed:', error);
                }

                showToast(`Starting ${exercise.name}! üí™`, 'info', 2000);
                console.log('üéâ Exercise loaded successfully!');
            } catch (error) {
                console.error('Error loading exercise:', error);
                showToast('Error loading exercise. Please try again.', 'error');
                // Fallback: try to continue to next exercise or go back
                if (currentExerciseIndex > 0) {
                    currentExerciseIndex--;
                }
            }
        }

        function updateExerciseProgressDots() {
            const dotsContainer = document.getElementById('exerciseProgressDots');
            if (!dotsContainer) return;

            let html = '';
            workoutPlan.forEach((exercise, index) => {
                const isActive = index === currentExerciseIndex;
                const isComplete = index < currentExerciseIndex;
                const isPending = index > currentExerciseIndex;

                let dotClass = '';
                let icon = '';

                if (isComplete) {
                    dotClass = 'bg-green-500 text-white border-green-600';
                    icon = '‚úì';
                } else if (isActive) {
                    dotClass = 'bg-primary text-white border-primary shadow-lg scale-110';
                    icon = '‚óè';
                } else {
                    dotClass = 'bg-gray-300 dark:bg-gray-600 text-gray-600 dark:text-gray-400 border-gray-400 dark:border-gray-500';
                    icon = '‚óã';
                }

                html += `
                    <div class="flex flex-col items-center gap-1">
                        <div class="w-10 h-10 rounded-full border-2 flex items-center justify-center font-bold transition-all ${dotClass}" title="${exercise.name}">
                            ${icon}
                        </div>
                        <div class="text-xs font-medium text-gray-700 dark:text-gray-300 text-center max-w-[60px] truncate" title="${exercise.name}">
                            ${exercise.name.split(' ')[0]}
                        </div>
                    </div>
                `;
            });

            dotsContainer.innerHTML = html;
        }

        function updateWorkoutProgressList() {
            const progressList = document.getElementById('workoutProgressList');
            if (!progressList) return;

            let html = '';

            workoutPlan.forEach((exercise, index) => {
                const isActive = index === currentExerciseIndex;
                const isComplete = index < currentExerciseIndex;

                let status = '';
                let statusClass = '';

                if (isComplete) {
                    status = '‚úÖ Complete';
                    statusClass = 'text-green-600 dark:text-green-400';
                } else if (isActive) {
                    status = `üîÑ Set ${exercise.currentSet || 1}/${exercise.sets}`;
                    statusClass = 'text-blue-600 dark:text-blue-400';
                } else {
                    status = '‚è≥ Waiting';
                    statusClass = 'text-gray-500 dark:text-gray-400';
                }

                html += `
                    <div class="flex justify-between items-center ${isActive ? 'font-bold' : ''}">
                        <span class="${isActive ? 'text-primary' : ''}">${exercise.name}</span>
                        <span class="${statusClass}">${status}</span>
                    </div>
                `;
            });

            progressList.innerHTML = html;
        }

        function completeSet() {
            const repsInput = document.getElementById('actualRepsInput');
            const actualReps = parseInt(repsInput.value);
            
            if (!actualReps || actualReps < 0 || actualReps > 50) {
                showToast('Please enter a valid number of reps (1-50)', 'error');
                return;
            }
            
            const exercise = currentExercise;
            const setNumber = exercise.currentSet;
            
            // Record the set
            workoutHistory.push({
                exercise: exercise.name,
                setNumber: setNumber,
                reps: actualReps,
                weight: exercise.weight,
                targetReps: exercise.targetReps,
                timestamp: new Date()
            });
            
            // Update exercise progress
            exercise.completedSets++;
            exercise.currentSet++;
            
            // Update UI
            updateWorkoutHistory();
            updateWorkoutProgressList();
            
            // Check if exercise is complete
            if (exercise.currentSet > exercise.sets) {
                // Exercise complete
                currentExerciseIndex++;
                
                if (currentExerciseIndex >= workoutPlan.length) {
                    completeWorkout();
                } else {
                    showExerciseCompleteModal();
                }
            } else {
                // More sets to go, start rest timer
                startRestTimer(exercise.restTime);

                // Update set counter
                const currentSetEl = document.getElementById('currentSet');
                if (currentSetEl) currentSetEl.textContent = exercise.currentSet;
            }
        }

        let restTimerInitialDuration = 0; // Store initial duration for circular progress

        function startRestTimer(duration) {
            try {
                // Proper cleanup of any existing timer to prevent race conditions
                if (timer) {
                    clearInterval(timer);
                    timer = null;
                    console.log('üîÑ Cleared existing timer');
                }

                // Reset timer state
                isTimerRunning = false;
                timeRemaining = 0;

                // Validate duration
                if (!duration || duration <= 0) {
                    console.warn('Invalid timer duration:', duration);
                    return;
                }

                // Set new timer state
                timeRemaining = duration;
                restTimerInitialDuration = duration;
                isTimerRunning = true;

                // Timer section is always visible, no need to show/hide

                // Start countdown
                timer = setInterval(updateRestTimer, 1000);
                updateRestTimer(); // Initial update

                console.log(`‚è∞ Started rest timer for ${duration} seconds`);
                showToast(`Rest timer started: ${Math.floor(duration / 60)}:${(duration % 60).toString().padStart(2, '0')}`, 'info', 2000);
            } catch (error) {
                console.error('Error starting rest timer:', error);
                // Clean up on error
                if (timer) {
                    clearInterval(timer);
                    timer = null;
                }
                isTimerRunning = false;
            }
        }
        
        function updateRestTimer() {
            // Check if timer is done
            if (timeRemaining <= 0) {
                finishRestTimer();
                return;
            }

            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            const timeText = `${minutes}:${seconds.toString().padStart(2, '0')}`;

            // Update the rest countdown display
            const restCountdown = document.getElementById('restCountdown');
            if (restCountdown) {
                restCountdown.textContent = timeText;
            }

            // Update circular progress (r=35 for timer with text inside)
            const restTimerCircle = document.getElementById('restTimerCircle');
            if (restTimerCircle && restTimerInitialDuration > 0) {
                const circumference = 2 * Math.PI * 35; // 2œÄr where r=35
                const progress = timeRemaining / restTimerInitialDuration;
                const offset = circumference * (1 - progress);
                restTimerCircle.style.strokeDashoffset = offset;
            }

            timeRemaining--;
        }
        
        function hideRestTimer() {
            // Timer is always visible, just stop the countdown and reset display
            if (timer) {
                clearInterval(timer);
                isTimerRunning = false;
                timer = null;
            }

            // Reset display to inactive state
            const restCountdown = document.getElementById('restCountdown');
            if (restCountdown) {
                restCountdown.textContent = '--:--';
            }

            // Reset circular progress
            const restTimerCircle = document.getElementById('restTimerCircle');
            if (restTimerCircle) {
                restTimerCircle.style.strokeDashoffset = 0;
            }
        }

        function updateTimer() {
            // Safety check - stop timer if no active exercise
            if (!currentExercise) {
                clearInterval(timer);
                isTimerRunning = false;
                return;
            }
            
            if (timeRemaining <= 0) {
                finishRestTimer();
                return;
            }
            
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            const timeText = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            const timerTextEl = document.getElementById('timerText');
            if (timerTextEl) {
                timerTextEl.textContent = timeText;
            }
            
            // Update progress circle
            const totalTime = currentExercise.restTime || 180;
            const progress = (totalTime - timeRemaining) / totalTime;
            const circumference = 2 * Math.PI * 56; // radius = 56
            const offset = circumference * (1 - progress);
            
            const progressCircle = document.getElementById('timerProgress');
            if (progressCircle) {
                progressCircle.style.strokeDashoffset = offset;
            }
            
            timeRemaining--;
        }

        function finishRestTimer() {
            // Safety check - stop timer if no active exercise
            if (!currentExercise) {
                clearInterval(timer);
                isTimerRunning = false;
                hideRestTimer();
                return;
            }

            clearInterval(timer);
            isTimerRunning = false;

            // Hide the rest timer section
            hideRestTimer();

            // Play notification sound if enabled
            playRestTimerSound();

            // Show notification
            showToast('Rest time complete! Ready for your next set üí™', 'success');
        }

        // Sound notification function using Web Audio API
        async function playRestTimerSound() {
            try {
                console.log('üîî playRestTimerSound() called');

                // Check if sound is enabled
                const soundEnabled = await SafeStorage.getItem('restTimerSoundEnabled');
                console.log('üîî Sound enabled setting:', soundEnabled);

                if (soundEnabled === 'false') {
                    console.log('üîá Rest timer sound is disabled');
                    return;
                }

                console.log('üîî Creating audio context...');

                // Create audio context
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();

                console.log('üîî Audio context state:', audioContext.state);

                // Resume audio context if it's suspended (browser autoplay policy)
                if (audioContext.state === 'suspended') {
                    await audioContext.resume();
                    console.log('üîî Audio context resumed');
                }

                // Create a pleasant notification sound with three tones
                const playTone = (frequency, startTime, duration, volume = 0.3) => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();

                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);

                    oscillator.frequency.value = frequency;
                    oscillator.type = 'sine';

                    // Envelope for smooth sound
                    gainNode.gain.setValueAtTime(0, startTime);
                    gainNode.gain.linearRampToValueAtTime(volume, startTime + 0.01);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + duration);

                    oscillator.start(startTime);
                    oscillator.stop(startTime + duration);
                };

                // Play triple-tone notification (ding-ding-dong style)
                const now = audioContext.currentTime;
                playTone(880, now, 0.12, 0.25);              // First ding (high)
                playTone(880, now + 0.15, 0.12, 0.25);       // Second ding (high)
                playTone(660, now + 0.30, 0.20, 0.30);       // Final dong (lower)

                console.log('‚úÖ Rest timer sound played successfully');
            } catch (e) {
                console.error('‚ùå Failed to play rest timer sound:', e);
                console.error('Error details:', e.message, e.stack);
            }
        }

        // Timer control functions
        function pauseTimer() {
            const pauseTimerBtn = document.getElementById('pauseTimerBtn');
            if (isTimerRunning) {
                clearInterval(timer);
                isTimerRunning = false;
                if (pauseTimerBtn) pauseTimerBtn.textContent = 'Resume';
            } else {
                timer = setInterval(updateTimer, 1000);
                isTimerRunning = true;
                if (pauseTimerBtn) pauseTimerBtn.textContent = 'Pause';
            }
        }

        function resetTimer() {
            clearInterval(timer);
            isTimerRunning = false;
            timeRemaining = currentExercise ? currentExercise.restTime : 180;
            updateTimer();
            const pauseTimerBtn = document.getElementById('pauseTimerBtn');
            if (pauseTimerBtn) pauseTimerBtn.textContent = 'Pause';
        }

        // Workout timer functions
        function startWorkoutTimer() {
            workoutStartTime = new Date();
            workoutElapsedSeconds = 0;
            isWorkoutTimerRunning = true;
            isWorkoutTimerPaused = false;
            
            workoutTimer = setInterval(updateWorkoutTimer, 1000);
            const workoutTimerToggle = document.getElementById('workoutTimerToggle');
            if (workoutTimerToggle) workoutTimerToggle.textContent = 'Pause';
        }

        function updateWorkoutTimer() {
            if (isWorkoutTimerRunning && !isWorkoutTimerPaused) {
                workoutElapsedSeconds++;
            }

            const hours = Math.floor(workoutElapsedSeconds / 3600);
            const minutes = Math.floor((workoutElapsedSeconds % 3600) / 60);
            const seconds = workoutElapsedSeconds % 60;

            const timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            const workoutDurationDisplay = document.getElementById('workoutDurationDisplay');
            if (workoutDurationDisplay) workoutDurationDisplay.textContent = timeString;
        }

        function toggleWorkoutTimer() {
            const workoutTimerToggle = document.getElementById('workoutTimerToggle');
            if (!workoutTimerToggle) return;

            if (isWorkoutTimerPaused) {
                isWorkoutTimerPaused = false;
                workoutTimerToggle.textContent = 'Pause';
                showToast('Workout timer resumed', 'info');
            } else {
                isWorkoutTimerPaused = true;
                workoutTimerToggle.textContent = 'Resume';
                showToast('Workout timer paused', 'info');
            }
        }

        function stopWorkoutTimer() {
            clearInterval(workoutTimer);
            isWorkoutTimerRunning = false;
            isWorkoutTimerPaused = false;
        }

        function stopRestTimer() {
            // Clear the rest timer interval
            if (timer) {
                clearInterval(timer);
                timer = null;
            }
            isTimerRunning = false;
            timeRemaining = 0;

            // Reset the rest timer display
            const restCountdown = document.getElementById('restCountdown');
            if (restCountdown) {
                restCountdown.textContent = '--:--';
            }

            const restTimerCircle = document.getElementById('restTimerCircle');
            if (restTimerCircle) {
                restTimerCircle.style.strokeDashoffset = 0;
            }

            console.log('‚èπÔ∏è Rest timer stopped');
        }

        // Edit Workout Modal Implementation
        function showEditWorkoutModal() {
            if (!currentExercise || !workoutPlan || workoutPlan.length === 0) {
                showToast('No active workout to edit', 'error');
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden">
                    <div class="flex items-center justify-between p-6 border-b border-gray-200 dark:border-gray-700">
                        <div class="flex items-center gap-3">
                            <span class="text-3xl">‚úèÔ∏è</span>
                            <div>
                                <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-200">Edit Workout</h2>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Modify your workout settings. Changes will take effect immediately.</p>
                            </div>
                        </div>
                        <button onclick="closeEditWorkoutModal()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 text-2xl">√ó</button>
                    </div>
                    
                    <div class="overflow-y-auto max-h-[calc(90vh-120px)] custom-scrollbar">
                        ${generateEditWorkoutContent()}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function generateEditWorkoutContent() {
            let content = '';
            
            // Impact Warning Section
            const currentExerciseData = getCurrentExerciseData();
            if (currentExerciseData.hasImpact) {
                content += `
                    <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                        <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-700 rounded-lg p-4">
                            <div class="flex items-start gap-3">
                                <span class="text-yellow-600 dark:text-yellow-400 text-lg">‚ö†Ô∏è</span>
                                <div>
                                    <h3 class="font-semibold text-yellow-800 dark:text-yellow-200 mb-2">Impact on Current Progress</h3>
                                    <p class="text-sm text-yellow-700 dark:text-yellow-300">${currentExerciseData.impactMessage}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Exercise Configuration Section
            content += '<div class="p-6 space-y-6">';
            
            workoutPlan.forEach((exercise, index) => {
                const isCurrentExercise = index === currentExerciseIndex;
                const isCompleted = index < currentExerciseIndex;
                const completedSets = getCompletedSetsForExercise(exercise.name);
                const setsCompleted = completedSets.length;
                
                content += `
                    <div class="bg-gray-50 dark:bg-gray-700 rounded-xl p-6 ${isCurrentExercise ? 'ring-2 ring-primary' : ''}">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-3">
                                <span class="text-2xl">${getExerciseEmoji(exercise.name)}</span>
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200">${exercise.name}</h3>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">Exercise ${index + 1}</p>
                                </div>
                            </div>
                            ${setsCompleted > 0 ? `
                                <span class="px-3 py-1 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 rounded-full text-sm font-medium">
                                    ${setsCompleted} sets completed
                                </span>
                            ` : ''}
                        </div>
                        
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">Weight (kg)</label>
                                <input id="editWeight_${index}" type="number" value="${exercise.weight}" min="0" max="500" step="2.5" 
                                       class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base focus:ring-2 focus:ring-primary focus:border-transparent"
                                       onchange="updateEditedExercise(${index}, 'weight', this.value)"
                                       ${isCompleted ? 'disabled' : ''}>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">Target Reps</label>
                                <input id="editReps_${index}" type="number" value="${exercise.targetReps}" min="1" max="20" 
                                       class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base focus:ring-2 focus:ring-primary focus:border-transparent"
                                       onchange="updateEditedExercise(${index}, 'targetReps', this.value)"
                                       ${isCompleted ? 'disabled' : ''}>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">Sets</label>
                                <input id="editSets_${index}" type="number" value="${exercise.sets}" min="1" max="10" 
                                       class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base focus:ring-2 focus:ring-primary focus:border-transparent"
                                       onchange="updateEditedExercise(${index}, 'sets', this.value)"
                                       ${setsCompleted > 0 ? `min="${setsCompleted}"` : ''}>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">Rest Time</label>
                                <select id="editRest_${index}" onchange="updateEditedExercise(${index}, 'restTime', this.value)"
                                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base focus:ring-2 focus:ring-primary focus:border-transparent"
                                        ${isCompleted ? 'disabled' : ''}>
                                    <option value="120" ${exercise.restTime === 120 ? 'selected' : ''}>2 minutes</option>
                                    <option value="180" ${exercise.restTime === 180 ? 'selected' : ''}>3 minutes</option>
                                    <option value="240" ${exercise.restTime === 240 ? 'selected' : ''}>4 minutes</option>
                                    <option value="300" ${exercise.restTime === 300 ? 'selected' : ''}>5 minutes</option>
                                </select>
                            </div>
                        </div>
                        
                        ${setsCompleted > 0 ? `
                            <div class="bg-white dark:bg-gray-600 rounded-lg p-4 border border-gray-200 dark:border-gray-500">
                                <h4 class="font-medium text-gray-700 dark:text-gray-300 mb-3">Completed Sets Progress:</h4>
                                <div class="space-y-1 text-sm">
                                    ${completedSets.map(set => `
                                        <div class="flex justify-between items-center text-gray-600 dark:text-gray-400">
                                            <span>Set ${set.setNumber}: ${set.reps} reps @ ${formatWeight(set.weight)}</span>
                                            <span class="text-xs">${set.timestamp.toLocaleTimeString()}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        ${isCompleted ? `
                            <div class="mt-3 text-sm text-gray-500 dark:text-gray-400">
                                ‚úÖ This exercise is completed and cannot be modified
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            content += `
                    <div class="flex gap-3 pt-4">
                        <button onclick="closeEditWorkoutModal()" class="flex-1 px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                            Close
                        </button>
                        <button onclick="applyWorkoutChanges()" class="flex-1 px-6 py-3 gradient-primary text-white rounded-lg hover:shadow-lg transition-all duration-300">
                            Apply Changes
                        </button>
                    </div>
                </div>
            `;
            
            return content;
        }
        
        function getCurrentExerciseData() {
            if (!currentExercise || currentExerciseIndex >= workoutPlan.length) {
                return { hasImpact: false, impactMessage: '' };
            }
            
            const exercise = workoutPlan[currentExerciseIndex];
            const completedSets = getCompletedSetsForExercise(exercise.name).length;
            const currentSet = exercise.currentSet || 1;
            
            if (completedSets > 0) {
                return {
                    hasImpact: true,
                    impactMessage: `You are currently on set ${currentSet} of ${exercise.name}. If you reduce the number of sets below ${completedSets}, the current exercise will be marked as complete.`
                };
            }
            
            return { hasImpact: false, impactMessage: '' };
        }
        
        function getCompletedSetsForExercise(exerciseName) {
            return workoutHistory.filter(entry => entry.exercise === exerciseName);
        }
        
        function getExerciseEmoji(exerciseName) {
            const emojiMap = {
                'Squats': 'üèãÔ∏è',
                'Bench Press': 'üî•',
                'Deadlift': '‚ö°',
                'Overhead Press': 'üí™',
                'Barbell Rows': 'üö£'
            };
            return emojiMap[exerciseName] || 'üí™';
        }
        
        function updateEditedExercise(exerciseIndex, property, value) {
            if (!workoutPlan[exerciseIndex]) return;
            
            const numValue = property === 'weight' ? parseFloat(value) : 
                           property === 'restTime' ? parseInt(value) : parseInt(value);
            
            // Validate the change
            if (property === 'sets') {
                const completedSets = getCompletedSetsForExercise(workoutPlan[exerciseIndex].name).length;
                if (numValue < completedSets) {
                    showToast(`Cannot reduce sets below ${completedSets} (already completed)`, 'error');
                    document.getElementById(`editSets_${exerciseIndex}`).value = workoutPlan[exerciseIndex].sets;
                    return;
                }
            }
            
            // Update the workout plan
            workoutPlan[exerciseIndex][property] = numValue;
            
            // Update current exercise if it's the active one
            if (exerciseIndex === currentExerciseIndex) {
                currentExercise[property] = numValue;
                
                // Update the main UI elements
                updateCurrentExerciseDisplay();
                
                // Update plate calculator if weight changed
                if (property === 'weight') {
                    updatePlateCalculation(numValue);
                }
            }
            
            // Show feedback
            showToast(`${property} updated for ${workoutPlan[exerciseIndex].name}`, 'success', 2000);
        }
        
        function updateCurrentExerciseDisplay() {
            if (!currentExercise) return;
            
            // Safely update elements that might not exist
            const updates = {
                'currentExerciseWeight': formatWeight(currentExercise.weight),
                'currentExerciseReps': currentExercise.targetReps,
                'currentExerciseSets': currentExercise.sets,
                'currentExerciseRestTime': `${Math.floor(currentExercise.restTime / 60)}min`,
                'totalSets': currentExercise.sets,
                // Also update the duplicate elements in details tab
                'currentExerciseWeight2': formatWeight(currentExercise.weight),
                'currentExerciseReps2': currentExercise.targetReps,
                'currentExerciseSets2': currentExercise.sets,
                'currentExerciseRestTime2': `${Math.floor(currentExercise.restTime / 60)}min`
            };
            
            Object.keys(updates).forEach(elementId => {
                const element = document.getElementById(elementId);
                if (element) {
                    element.textContent = updates[elementId];
                } else {
                    console.log(`Element ${elementId} not found, skipping update`);
                }
            });
        }
        
        function applyWorkoutChanges() {
            // Update progress list
            updateWorkoutProgressList();
            
            // Close modal
            closeEditWorkoutModal();
            
            showToast('Workout changes applied successfully! üí™', 'success');
        }
        
        function closeEditWorkoutModal() {
            const modal = document.querySelector('.fixed.inset-0.bg-black.bg-opacity-50');
            if (modal) {
                modal.remove();
            }
        }

        // Simple Dark Mode System
        function initializeDarkMode() {
            console.log('üöÄ Initializing dark mode system...');
            
            const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
            mediaQuery.addEventListener('change', handleSystemThemeChange);
            
            applySystemTheme();
        }
        
        function applySystemTheme() {
            const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (systemPrefersDark) {
                document.documentElement.classList.add('dark');
                console.log('üîÑ Applied dark theme (system preference)');
            } else {
                document.documentElement.classList.remove('dark');
                console.log('üîÑ Applied light theme (system preference)');
            }
        }
        
        function handleSystemThemeChange(event) {
            console.log('üì± System theme changed:', event.matches ? 'dark' : 'light');
            applySystemTheme();
        }

        // ============================================
        // PWA INDEXEDDB STORAGE SYSTEM
        // ============================================

        // Storage system variables
        let isIndexedDBAvailable = false;
        let isLocalStorageAvailable = false;
        let db = null;
        const DB_NAME = 'LiftTrackerDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'workoutData';

        // Check if localStorage is available
        function checkLocalStorageAvailability() {
            try {
                const testKey = '__localStorage_test__';
                // eslint-disable-next-line no-restricted-globals
                localStorage.setItem(testKey, 'test');
                // eslint-disable-next-line no-restricted-globals
                localStorage.removeItem(testKey);
                return true;
            } catch (e) {
                return false;
            }
        }

        // Initialize IndexedDB
        async function initIndexedDB() {
            return new Promise((resolve, reject) => {
                try {
                    // Check if IndexedDB is available in this context
                    if (!window.indexedDB) {
                        console.log('üíæ IndexedDB not available - checking localStorage...');
                        isIndexedDBAvailable = false;
                        isLocalStorageAvailable = checkLocalStorageAvailability();
                        if (isLocalStorageAvailable) {
                            console.log('‚úÖ Using localStorage as fallback');
                        } else {
                            console.warn('‚ö†Ô∏è Neither IndexedDB nor localStorage available - data will not persist!');
                        }
                        resolve(false);
                        return;
                    }

                    const request = indexedDB.open(DB_NAME, DB_VERSION);

                    request.onerror = () => {
                        console.log('üíæ IndexedDB not available - checking localStorage...');
                        isIndexedDBAvailable = false;
                        isLocalStorageAvailable = checkLocalStorageAvailability();
                        if (isLocalStorageAvailable) {
                            console.log('‚úÖ Using localStorage as fallback');
                        } else {
                            console.warn('‚ö†Ô∏è Neither IndexedDB nor localStorage available - data will not persist!');
                        }
                        resolve(false);
                    };

                    request.onsuccess = (event) => {
                        db = event.target.result;
                        isIndexedDBAvailable = true;
                        isLocalStorageAvailable = checkLocalStorageAvailability();
                        console.log('‚úÖ IndexedDB initialized successfully');
                        resolve(true);
                    };

                    request.onupgradeneeded = (event) => {
                        db = event.target.result;
                        if (!db.objectStoreNames.contains(STORE_NAME)) {
                            db.createObjectStore(STORE_NAME);
                            console.log('üì¶ Created IndexedDB object store');
                        }
                    };
                } catch (e) {
                    // Silently fall back to localStorage in sandboxed environments
                    console.log('üíæ IndexedDB error - checking localStorage...');
                    isIndexedDBAvailable = false;
                    isLocalStorageAvailable = checkLocalStorageAvailability();
                    if (isLocalStorageAvailable) {
                        console.log('‚úÖ Using localStorage as fallback');
                    } else {
                        console.warn('‚ö†Ô∏è Neither IndexedDB nor localStorage available - data will not persist!');
                    }
                    resolve(false);
                }
            });
        }

        // Safe Storage wrapper with IndexedDB and localStorage fallback
        const SafeStorage = {
            getItem: async function(key) {
                console.log(`üîç SafeStorage.getItem('${key}') - IndexedDB: ${isIndexedDBAvailable}, localStorage: ${isLocalStorageAvailable}`);

                // Try IndexedDB first
                if (isIndexedDBAvailable && db) {
                    return new Promise((resolve) => {
                        try {
                            const transaction = db.transaction([STORE_NAME], 'readonly');
                            const store = transaction.objectStore(STORE_NAME);
                            const request = store.get(key);

                            request.onsuccess = () => {
                                const value = request.result !== undefined ? request.result : null;
                                if (value) {
                                    console.log(`‚úÖ Retrieved '${key}' from IndexedDB (${(value.length / 1024).toFixed(2)} KB)`);
                                    resolve(value);
                                } else {
                                    console.log(`‚ö†Ô∏è '${key}' not found in IndexedDB, trying localStorage...`);
                                    // Fall back to localStorage if not found in IndexedDB
                                    if (isLocalStorageAvailable) {
                                        try {
                                            // eslint-disable-next-line no-restricted-globals
                                            const lsValue = localStorage.getItem(key);
                                            if (lsValue) {
                                                console.log(`‚úÖ Retrieved '${key}' from localStorage fallback (${(lsValue.length / 1024).toFixed(2)} KB)`);
                                            } else {
                                                console.log(`‚ùå '${key}' not found in localStorage either`);
                                            }
                                            resolve(lsValue);
                                        } catch (e) {
                                            console.error(`‚ùå localStorage.getItem error:`, e);
                                            resolve(null);
                                        }
                                    } else {
                                        resolve(null);
                                    }
                                }
                            };

                            request.onerror = () => {
                                console.warn(`‚ö†Ô∏è IndexedDB read error for '${key}', falling back to localStorage`);
                                // Fall back to localStorage on error
                                if (isLocalStorageAvailable) {
                                    try {
                                        // eslint-disable-next-line no-restricted-globals
                                        const value = localStorage.getItem(key);
                                        if (value) {
                                            console.log(`‚úÖ Retrieved '${key}' from localStorage after IndexedDB error`);
                                        }
                                        resolve(value);
                                    } catch (e) {
                                        console.error(`‚ùå localStorage.getItem error:`, e);
                                        resolve(null);
                                    }
                                } else {
                                    resolve(null);
                                }
                            };
                        } catch (e) {
                            console.error(`‚ùå IndexedDB exception for '${key}':`, e);
                            // Fall back to localStorage on error
                            if (isLocalStorageAvailable) {
                                try {
                                    // eslint-disable-next-line no-restricted-globals
                                    const value = localStorage.getItem(key);
                                    if (value) {
                                        console.log(`‚úÖ Retrieved '${key}' from localStorage after IndexedDB exception`);
                                    }
                                    resolve(value);
                                } catch (e) {
                                    console.error(`‚ùå localStorage.getItem error:`, e);
                                    resolve(null);
                                }
                            } else {
                                resolve(null);
                            }
                        }
                    });
                } else if (isLocalStorageAvailable) {
                    // Use localStorage if IndexedDB is not available
                    console.log(`üì¶ Using localStorage directly for '${key}' (IndexedDB not available)`);
                    try {
                        // eslint-disable-next-line no-restricted-globals
                        const value = localStorage.getItem(key);
                        if (value) {
                            console.log(`‚úÖ Retrieved '${key}' from localStorage (${(value.length / 1024).toFixed(2)} KB)`);
                        } else {
                            console.log(`‚ùå '${key}' not found in localStorage`);
                        }
                        return Promise.resolve(value);
                    } catch (e) {
                        console.error(`‚ùå localStorage read error for '${key}':`, e);
                        return Promise.resolve(null);
                    }
                } else {
                    // No storage available
                    console.error(`‚ùå No storage available for key: '${key}'`);
                    return Promise.resolve(null);
                }
            },

            setItem: async function(key, value) {
                console.log(`üíæ SafeStorage.setItem('${key}', ${(value.length / 1024).toFixed(2)} KB)`);
                console.log(`üìä Storage status - IndexedDB: ${isIndexedDBAvailable}, localStorage: ${isLocalStorageAvailable}`);

                let indexedDBSuccess = false;
                let localStorageSuccess = false;

                // Try IndexedDB first
                if (isIndexedDBAvailable && db) {
                    console.log(`üîÑ Attempting to write to IndexedDB...`);
                    await new Promise((resolve) => {
                        try {
                            const transaction = db.transaction([STORE_NAME], 'readwrite');
                            const store = transaction.objectStore(STORE_NAME);
                            const request = store.put(value, key);

                            request.onsuccess = () => {
                                indexedDBSuccess = true;
                                console.log(`‚úÖ IndexedDB write request succeeded for '${key}'`);
                                resolve(true);
                            };

                            request.onerror = () => {
                                console.error(`‚ùå IndexedDB write error for '${key}':`, request.error);
                                resolve(false);
                            };

                            transaction.oncomplete = () => {
                                console.log(`‚úÖ IndexedDB transaction completed for '${key}'`);
                            };

                            transaction.onerror = () => {
                                console.error(`‚ùå IndexedDB transaction error for '${key}':`, transaction.error);
                            };
                        } catch (e) {
                            console.error(`‚ùå IndexedDB write failed for '${key}':`, e);
                            resolve(false);
                        }
                    });
                } else {
                    console.log(`‚ö†Ô∏è Skipping IndexedDB write (not available)`);
                }

                // Always also save to localStorage as backup
                if (isLocalStorageAvailable) {
                    console.log(`üîÑ Attempting to write to localStorage...`);
                    try {
                        // eslint-disable-next-line no-restricted-globals
                        localStorage.setItem(key, value);
                        localStorageSuccess = true;
                        console.log(`‚úÖ Successfully saved to localStorage: '${key}' (${(value.length / 1024).toFixed(2)} KB)`);
                    } catch (e) {
                        console.error(`‚ùå localStorage write error for '${key}':`, e);
                        // Check if it's a quota exceeded error
                        if (e.name === 'QuotaExceededError') {
                            console.error(`‚ùå localStorage quota exceeded! Data size: ${(value.length / 1024).toFixed(2)} KB`);
                        }
                    }
                } else {
                    console.error(`‚ùå localStorage not available - cannot save '${key}'`);
                }

                const result = indexedDBSuccess || localStorageSuccess;
                console.log(`${result ? '‚úÖ' : '‚ùå'} SafeStorage.setItem result: ${result} (IndexedDB: ${indexedDBSuccess}, localStorage: ${localStorageSuccess})`);
                return Promise.resolve(result);
            },

            removeItem: async function(key) {
                // Remove from both IndexedDB and localStorage
                let success = false;

                if (isIndexedDBAvailable && db) {
                    await new Promise((resolve) => {
                        try {
                            const transaction = db.transaction([STORE_NAME], 'readwrite');
                            const store = transaction.objectStore(STORE_NAME);
                            const request = store.delete(key);

                            request.onsuccess = () => {
                                success = true;
                                resolve(true);
                            };

                            request.onerror = () => {
                                resolve(false);
                            };
                        } catch (e) {
                            resolve(false);
                        }
                    });
                }

                if (isLocalStorageAvailable) {
                    try {
                        // eslint-disable-next-line no-restricted-globals
                        localStorage.removeItem(key);
                        success = true;
                    } catch (e) {
                        console.error('localStorage remove error:', e);
                    }
                }

                return Promise.resolve(success);
            },

            clear: async function() {
                let success = false;

                // Clear IndexedDB
                if (isIndexedDBAvailable && db) {
                    await new Promise((resolve) => {
                        try {
                            const transaction = db.transaction([STORE_NAME], 'readwrite');
                            const store = transaction.objectStore(STORE_NAME);
                            const request = store.clear();

                            request.onsuccess = () => {
                                console.log('üóëÔ∏è Cleared IndexedDB');
                                success = true;
                                resolve(true);
                            };

                            request.onerror = () => {
                                resolve(false);
                            };
                        } catch (e) {
                            resolve(false);
                        }
                    });
                }

                // Clear localStorage
                if (isLocalStorageAvailable) {
                    try {
                        // Only clear our app's keys, not all localStorage
                        const keysToRemove = ['workoutSessions', 'workoutSettings', 'preferredWeightUnit', 'hasSeenWelcome', 'restTimerSoundEnabled'];
                        keysToRemove.forEach(key => {
                            try {
                                // eslint-disable-next-line no-restricted-globals
                                localStorage.removeItem(key);
                            } catch (e) {
                                console.error(`Error removing ${key} from localStorage:`, e);
                            }
                        });
                        console.log('üóëÔ∏è Cleared localStorage');
                        success = true;
                    } catch (e) {
                        console.error('localStorage clear error:', e);
                    }
                }

                return Promise.resolve(success);
            }
        };

        // Auto-save workout sessions to IndexedDB
        async function saveWorkoutSessions() {
            try {
                const dataToSave = JSON.stringify(workoutSessions);
                console.log(`üíæ Attempting to save ${workoutSessions.length} workout sessions...`);
                console.log(`üìè Data size: ${(dataToSave.length / 1024).toFixed(2)} KB`);
                console.log(`üìä Storage status - IndexedDB: ${isIndexedDBAvailable}, localStorage: ${isLocalStorageAvailable}`);

                const result = await SafeStorage.setItem('workoutSessions', dataToSave);

                if (result) {
                    console.log(`‚úÖ Successfully saved ${workoutSessions.length} workout sessions`);

                    // Verify the save by immediately reading it back
                    const verifyData = await SafeStorage.getItem('workoutSessions');
                    if (verifyData) {
                        const verifiedSessions = JSON.parse(verifyData);
                        console.log(`‚úÖ Verification: ${verifiedSessions.length} sessions confirmed in storage`);
                    } else {
                        console.error('‚ùå Verification FAILED: Could not read back saved data!');
                    }
                } else {
                    console.error('‚ùå Save returned false - data may not have been saved!');
                }
            } catch (e) {
                console.error('‚ùå Failed to save workout sessions:', e);
            }
        }

        // Backup Reminder Feature - Show every 5th workout
        function checkBackupReminder() {
            const completedWorkouts = workoutSessions.filter(s => s.isComplete).length;

            // Show reminder every 5th workout (5, 10, 15, 20, etc.)
            if (completedWorkouts > 0 && completedWorkouts % 5 === 0) {
                showBackupReminderModal(completedWorkouts);
            }
        }

        function showBackupReminderModal(workoutCount) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-md w-full animate-bounce-in">
                    <!-- Header -->
                    <div class="bg-gradient-to-r from-amber-500 to-orange-500 p-6 rounded-t-xl text-center">
                        <div class="text-5xl mb-2">üíæ</div>
                        <h2 class="text-2xl font-bold text-white">Backup Reminder</h2>
                        <p class="text-amber-100 text-sm mt-1">${workoutCount} Workouts Completed!</p>
                    </div>

                    <!-- Content -->
                    <div class="p-6">
                        <p class="text-gray-700 dark:text-gray-300 mb-4 text-center">
                            Great progress! üéâ While your data is <strong>auto-saved with IndexedDB</strong>,
                            it's always smart to keep an extra backup just in case.
                        </p>

                        <div class="bg-blue-50 dark:bg-blue-900/20 border-2 border-blue-200 dark:border-blue-800 rounded-lg p-4 mb-4">
                            <div class="flex items-start gap-3">
                                <div class="text-2xl">üí°</div>
                                <div class="text-sm text-blue-800 dark:text-blue-200">
                                    <strong>Pro Tip:</strong> Export your data now to have a backup file you can import on any device or browser.
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="space-y-2">
                            <button onclick="exportWorkoutData(); this.closest('.fixed').remove();"
                                    class="w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white py-3 px-4 rounded-lg font-semibold hover:from-green-600 hover:to-emerald-700 transition-all duration-300 flex items-center justify-center gap-2 shadow-lg">
                                <span>üì•</span>
                                <span>Export Backup Now</span>
                            </button>

                            <button onclick="this.closest('.fixed').remove();"
                                    class="w-full bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 py-3 px-4 rounded-lg font-semibold hover:bg-gray-300 dark:hover:bg-gray-600 transition-all duration-300">
                                Maybe Later
                            </button>
                        </div>

                        <p class="text-xs text-gray-500 dark:text-gray-400 text-center mt-4">
                            This reminder appears every 5 workouts
                        </p>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Log for debugging
            console.log(`üìä Backup reminder shown at ${workoutCount} workouts`);
        }

        // Load workout sessions from IndexedDB
        async function loadWorkoutSessions() {
            try {
                console.log(`üîç Attempting to load workout sessions...`);
                console.log(`üìä Storage status - IndexedDB: ${isIndexedDBAvailable}, localStorage: ${isLocalStorageAvailable}`);

                const data = await SafeStorage.getItem('workoutSessions');

                if (data) {
                    console.log(`üì¶ Raw data retrieved, size: ${(data.length / 1024).toFixed(2)} KB`);

                    workoutSessions = JSON.parse(data);
                    console.log(`‚úÖ Loaded ${workoutSessions.length} workout sessions from storage`);

                    // CRITICAL FIX: Convert date strings back to Date objects
                    // When data is saved to localStorage as JSON, Date objects become strings
                    workoutSessions.forEach(session => {
                        session.date = new Date(session.date);
                        if (session.exercises && Array.isArray(session.exercises)) {
                            session.exercises.forEach(exercise => {
                                exercise.timestamp = new Date(exercise.timestamp);
                            });
                        }
                    });
                    console.log('üîÑ Converted date strings back to Date objects');

                    if (workoutSessions.length > 0) {
                        console.log('üìä First session:', {
                            id: workoutSessions[0].id,
                            date: workoutSessions[0].date,
                            type: workoutSessions[0].workoutType,
                            exercises: workoutSessions[0].exercises?.length || 0
                        });
                        console.log('üìä Last session:', {
                            id: workoutSessions[workoutSessions.length - 1].id,
                            date: workoutSessions[workoutSessions.length - 1].date,
                            type: workoutSessions[workoutSessions.length - 1].workoutType,
                            exercises: workoutSessions[workoutSessions.length - 1].exercises?.length || 0
                        });
                    }

                    // Update the UI to display the latest workout
                    updateLatestWorkoutDisplay();
                    updateExportStatus();

                    return true;
                } else {
                    console.log('üìÇ No workout sessions found in storage (data is null or undefined)');
                    return false;
                }
            } catch (e) {
                console.error('‚ùå Failed to load workout sessions:', e);
                console.error('‚ùå Error stack:', e.stack);
                return false;
            }
        }

        // PWA Install Banner
        let pwaPromptShown = false;
        function showPWAInstallBanner() {
            // Check if already shown
            if (pwaPromptShown) return;
            pwaPromptShown = true;

            const banner = document.createElement('div');
            banner.className = 'fixed top-4 left-4 right-4 bg-gradient-to-r from-primary to-purple-600 text-white p-4 rounded-lg shadow-2xl z-50 animate-slide-down';
            banner.innerHTML = `
                <div class="flex items-start justify-between gap-3">
                    <div class="flex items-start gap-3">
                        <div class="text-2xl">üì±</div>
                        <div>
                            <h3 class="font-bold text-sm mb-1">Install Lift Tracker PWA</h3>
                            <p class="text-xs opacity-90">Your data is now saved automatically! No more JSON uploads/downloads.</p>
                        </div>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="text-white/80 hover:text-white text-xl leading-none">√ó</button>
                </div>
            `;

            document.body.appendChild(banner);

            // Auto-dismiss after 10 seconds
            setTimeout(() => {
                if (banner && banner.parentElement) {
                    banner.style.animation = 'slideUp 0.4s ease-out';
                    setTimeout(() => banner.remove(), 400);
                }
            }, 10000);
        }

        // Startup Import Prompt Functions
        async function showStartupImportPrompt() {
            console.log('üîç Checking startup prompt conditions...');
            console.log('üìä Current workout sessions:', workoutSessions.length);

            const hasSeenWelcome = await SafeStorage.getItem('hasSeenWelcome');
            console.log('üëÅÔ∏è Has seen welcome before:', hasSeenWelcome);

            // Show if no existing data and user hasn't seen this before
            if (workoutSessions.length > 0) {
                console.log('‚ùå Not showing welcome: User has existing workout data');
                return;
            }

            if (hasSeenWelcome === 'true') {
                console.log('‚ùå Not showing welcome: User has seen welcome before');
                return;
            }

            console.log('‚úÖ Showing startup welcome prompt!');
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-8 rounded-xl shadow-2xl max-w-lg w-full mx-4 modal-enter-active">
                    <div class="text-center">
                        <div class="text-6xl mb-6 animate-bounce-in">üì¶</div>
                        <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-200 mb-4">Welcome Back!</h2>
                        <p class="text-gray-600 dark:text-gray-400 mb-6">Do you have existing workout data to import?</p>
                        
                        <div class="space-y-4">
                            <button onclick="importFromStartup(); this.closest('.fixed').remove()" class="w-full px-6 py-4 bg-blue-500 text-white rounded-xl font-semibold hover:bg-blue-600 transition-colors flex items-center justify-center gap-3">
                                üìÅ Import Previous Data
                            </button>
                            
                            <button onclick="startFresh(); this.closest('.fixed').remove()" class="w-full px-6 py-4 bg-gray-500 text-white rounded-xl font-semibold hover:bg-gray-600 transition-colors">
                                Start Fresh
                            </button>
                        </div>
                        
                        <div class="mt-6 pt-4 border-t border-gray-200 dark:border-gray-600">
                            <p class="text-xs text-gray-500 dark:text-gray-400">
                                üí° You can always import data later from the Data Management section
                            </p>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // Force show welcome prompt (for testing/debugging)
        function forceShowWelcome() {
            console.log('üîß Force showing welcome prompt...');
            SafeStorage.setItem('hasSeenWelcome', 'false');
            workoutSessions = []; // Clear any existing data
            showStartupImportPrompt();
        }
        
        async function importFromStartup() {
            // Mark as seen
            await SafeStorage.setItem('hasSeenWelcome', 'true');

            // Show import modal
            showImportFormatSelectionModal();

            showToast('Choose your file format to import existing workout data', 'info');
        }

        async function startFresh() {
            // Mark as seen
            await SafeStorage.setItem('hasSeenWelcome', 'true');

            showToast('Welcome! Start by selecting a workout to begin tracking your progress üí™', 'success', 4000);
        }
        
        function setupDragDropImport() {
            // Add drag and drop functionality to the main screen
            const dropZone = document.getElementById('dataScreen');
            if (!dropZone) return;
            
            let dragCounter = 0;
            
            dropZone.addEventListener('dragenter', function(e) {
                e.preventDefault();
                dragCounter++;
                showDragOverlay();
            });
            
            dropZone.addEventListener('dragleave', function(e) {
                e.preventDefault();
                dragCounter--;
                if (dragCounter === 0) {
                    hideDragOverlay();
                }
            });
            
            dropZone.addEventListener('dragover', function(e) {
                e.preventDefault();
            });
            
            dropZone.addEventListener('drop', function(e) {
                e.preventDefault();
                dragCounter = 0;
                hideDragOverlay();
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleDroppedFile(files[0]);
                }
            });
        }
        
        function showDragOverlay() {
            let overlay = document.getElementById('dragOverlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.id = 'dragOverlay';
                overlay.className = 'fixed inset-0 bg-primary bg-opacity-90 flex items-center justify-center z-40 pointer-events-none';
                overlay.innerHTML = `
                    <div class="text-center text-white animate-bounce-in">
                        <div class="text-8xl mb-4">üìÅ</div>
                        <h2 class="text-3xl font-bold mb-2">Drop your file here</h2>
                        <p class="text-xl opacity-80">Import JSON or CSV workout data</p>
                    </div>
                `;
                document.body.appendChild(overlay);
            }
            overlay.classList.remove('hidden');
        }
        
        function hideDragOverlay() {
            const overlay = document.getElementById('dragOverlay');
            if (overlay) {
                overlay.classList.add('hidden');
            }
        }
        
        function handleDroppedFile(file) {
            const fileName = file.name.toLowerCase();
            
            if (fileName.endsWith('.json')) {
                // Handle JSON file
                const reader = new FileReader();
                reader.onload = function(e) {
                    const event = { target: { files: [file], value: '' } };
                    // Simulate file input change
                    handleFileImport({ target: { files: [file], value: '' } });
                };
                reader.readAsText(file);
                
                showToast(`Importing JSON file: ${file.name}`, 'info');
            } else if (fileName.endsWith('.csv')) {
                // Handle CSV file
                const reader = new FileReader();
                reader.onload = function(e) {
                    handleCSVImport({ target: { files: [file], value: '' } });
                };
                reader.readAsText(file);
                
                showToast(`Importing CSV file: ${file.name}`, 'info');
            } else {
                showToast('Unsupported file type. Please drop a JSON or CSV file.', 'error');
            }
        }
        
        // Reset welcome prompt (for testing)
        function resetWelcomePrompt() {
            SafeStorage.setItem('hasSeenWelcome', 'false');
            showToast('Welcome prompt reset. Reload the page to see it again.', 'info');
        }

        // NEW SET TRACKING SYSTEM
        let currentSetData = []; // Track reps for each set: [0, 0, 0, 0, 0]
        let lastCompletedSetIndex = -1; // Track which set was last completed

        function initializeSetTracking() {
            if (!currentExercise) return;
            
            // Reset set tracking data
            currentSetData = new Array(currentExercise.sets).fill(0);
            lastCompletedSetIndex = -1;
            
            // Create set buttons
            createSetButtons();
            updateSetProgress();
            updateActionButtons();
        }

        function createSetButtons() {
            console.log('üîß Creating set buttons...');
            const container = document.getElementById('setButtonsContainer');
            console.log('üì¶ Container found:', !!container);
            console.log('üí™ Current exercise:', currentExercise?.name);
            console.log('üéØ Exercise sets:', currentExercise?.sets);
            
            if (!container) {
                console.error('‚ùå setButtonsContainer not found!');
                return;
            }
            
            if (!currentExercise) {
                console.error('‚ùå currentExercise is null!');
                return;
            }
            
            container.innerHTML = '';
            console.log('üßπ Container cleared');
            
            for (let i = 0; i < currentExercise.sets; i++) {
                const button = document.createElement('button');
                button.id = `setBtn${i}`;
                button.className = getSetButtonClass(i);
                button.onclick = () => toggleSetReps(i);
                
                button.innerHTML = `
                    <div class="font-bold text-lg">${i + 1}</div>
                    <div class="text-xs mt-1" id="setReps${i}">${currentSetData[i]} reps</div>
                `;
                
                container.appendChild(button);
                console.log(`‚úÖ Created button ${i + 1}`);
            }
            
            console.log(`üéâ Created ${currentExercise.sets} set buttons successfully!`);
            
            // Update the total sets display
            const totalSetsCount = document.getElementById('totalSetsCount');
            if (totalSetsCount) {
                totalSetsCount.textContent = currentExercise.sets;
                console.log('üìä Updated total sets count');
            }
        }

        function getSetButtonClass(setIndex) {
            if (!currentExercise) return 'w-16 h-16 mobile-set-button rounded-full bg-gray-200 dark:bg-gray-600';

            const reps = currentSetData[setIndex];
            const targetReps = currentExercise.targetReps;

            // Base classes for mobile-responsive buttons
            const baseClass = 'w-16 h-16 mobile-set-button rounded-full transition-all duration-300 text-center flex flex-col items-center justify-center text-sm font-medium';

            if (reps === 0) {
                return `${baseClass} bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-500`;
            } else if (reps >= targetReps) {
                return `${baseClass} bg-green-500 text-white hover:bg-green-600 shadow-lg transform hover:scale-110`;
            } else {
                return `${baseClass} bg-yellow-500 text-white hover:bg-yellow-600 shadow-lg transform hover:scale-110`;
            }
        }

        function toggleSetReps(setIndex) {
            if (!currentExercise) {
                console.warn('‚ö†Ô∏è toggleSetReps called but currentExercise is null');
                return;
            }

            const targetReps = currentExercise.targetReps;
            const wasEmpty = currentSetData[setIndex] === 0;
            
            if (currentSetData[setIndex] === 0) {
                // First tap - set to target reps
                currentSetData[setIndex] = targetReps;
            } else {
                // Subsequent taps - decrease by 1 (minimum 0)
                currentSetData[setIndex] = Math.max(0, currentSetData[setIndex] - 1);
            }
            
            // Update the button
            updateSetButton(setIndex);
            updateSetProgress();
            updateActionButtons();
            
            // If this set was completed (has reps > 0), record it in workout history
            if (currentSetData[setIndex] > 0 && lastCompletedSetIndex < setIndex) {
                recordCompletedSet(setIndex);
                
                // ALWAYS restart rest timer for each new set completion
                if (wasEmpty && currentSetData[setIndex] > 0) {
                    console.log(`üéØ Restarting rest timer for new set ${setIndex + 1} completion`);
                    // Clear any existing timer and start fresh with full duration
                    hideRestTimer(); // This clears the existing timer
                    startRestTimer(currentExercise.restTime);
                }
            }
            
            // Show feedback
            if (currentSetData[setIndex] === 0) {
                showToast(`Set ${setIndex + 1} reset`, 'info', 1500);
                // Hide rest timer if set was reset
                hideRestTimer();
            } else {
                const status = currentSetData[setIndex] >= targetReps ? 'completed' : 'partial';
                showToast(`Set ${setIndex + 1}: ${currentSetData[setIndex]} reps (${status})`, 'success', 1500);
            }
        }

        function updateSetButton(setIndex) {
            const button = document.getElementById(`setBtn${setIndex}`);
            const repsDisplay = document.getElementById(`setReps${setIndex}`);
            
            if (button && repsDisplay) {
                button.className = getSetButtonClass(setIndex);
                repsDisplay.textContent = `${currentSetData[setIndex]} reps`;
            }
        }

        function updateSetProgress() {
            // Progress is now shown visually via the set circles, no need for progress bar
            // This function is kept for compatibility but does nothing
        }

        function updateActionButtons() {
            // Show Next Exercise button only when ALL sets are complete
            const nextExerciseSection = document.getElementById('nextExerciseSection');

            if (nextExerciseSection && currentExercise) {
                const completedSets = currentSetData.filter(reps => reps > 0).length;
                const totalSets = currentExercise.sets;
                const allSetsComplete = completedSets === totalSets;

                if (allSetsComplete) {
                    nextExerciseSection.classList.remove('hidden');
                } else {
                    nextExerciseSection.classList.add('hidden');
                }
            }
        }

        function recordCompletedSet(setIndex) {
            if (!currentExercise) {
                console.warn('‚ö†Ô∏è recordCompletedSet called but currentExercise is null');
                return;
            }

            const reps = currentSetData[setIndex];
            if (reps <= 0) return;

            // Record in workout history
            workoutHistory.push({
                exercise: currentExercise.name,
                setNumber: setIndex + 1,
                reps: reps,
                weight: currentExercise.weight,
                targetReps: currentExercise.targetReps,
                timestamp: new Date()
            });

            lastCompletedSetIndex = setIndex;
            updateWorkoutHistory();
        }

        function undoLastSet() {
            if (!currentExercise) {
                console.warn('‚ö†Ô∏è undoLastSet called but currentExercise is null');
                return;
            }

            // Find the last set with reps > 0
            let lastSetIndex = -1;
            for (let i = currentSetData.length - 1; i >= 0; i--) {
                if (currentSetData[i] > 0) {
                    lastSetIndex = i;
                    break;
                }
            }

            if (lastSetIndex >= 0) {
                // Reset the set
                currentSetData[lastSetIndex] = 0;
                updateSetButton(lastSetIndex);

                // Remove from workout history
                const historyIndex = workoutHistory.findIndex(entry =>
                    entry.exercise === currentExercise.name &&
                    entry.setNumber === lastSetIndex + 1
                );
                
                if (historyIndex >= 0) {
                    workoutHistory.splice(historyIndex, 1);
                    updateWorkoutHistory();
                }
                
                if (lastSetIndex === lastCompletedSetIndex) {
                    lastCompletedSetIndex--;
                }
                
                updateSetProgress();
                updateActionButtons();
                
                showToast(`Undid Set ${lastSetIndex + 1}`, 'info');
            }
        }

        function proceedToNextExercise() {
            const completedSets = currentSetData.filter(reps => reps > 0).length;
            
            if (completedSets === 0) {
                showToast('Complete at least one set before proceeding', 'error');
                return;
            }
            
            // Move to next exercise
            currentExerciseIndex++;
            
            if (currentExerciseIndex >= workoutPlan.length) {
                completeWorkout();
            } else {
                loadCurrentExercise();
                showToast('Moving to next exercise! üí™', 'success');
            }
        }

        function toggleManualEntry() {
            const manualEntrySection = document.getElementById('manualEntrySection');
            if (manualEntrySection) {
                if (manualEntrySection.classList.contains('hidden')) {
                    manualEntrySection.classList.remove('hidden');
                } else {
                    manualEntrySection.classList.add('hidden');
                }
            }
        }

        function applyManualEntry() {
            if (!currentExercise) {
                console.warn('‚ö†Ô∏è applyManualEntry called but currentExercise is null');
                showToast('No active exercise', 'error');
                return;
            }

            const setNumber = parseInt(document.getElementById('manualSetNumber').value);
            const reps = parseInt(document.getElementById('manualRepsInput').value);

            if (!setNumber || reps < 0 || reps > 50) {
                showToast('Please enter valid set number and reps (0-50)', 'error');
                return;
            }

            const setIndex = setNumber - 1;
            if (setIndex >= 0 && setIndex < currentSetData.length) {
                // Remove old entry from workout history if it exists
                const existingIndex = workoutHistory.findIndex(entry =>
                    entry.exercise === currentExercise.name &&
                    entry.setNumber === setNumber
                );
                
                if (existingIndex >= 0) {
                    workoutHistory.splice(existingIndex, 1);
                }
                
                // Update set data
                currentSetData[setIndex] = reps;
                
                // Record in workout history if reps > 0
                if (reps > 0) {
                    recordCompletedSet(setIndex);
                }
                
                // Update UI
                updateSetButton(setIndex);
                updateSetProgress();
                updateActionButtons();
                
                // Clear manual entry form
                document.getElementById('manualRepsInput').value = '';
                
                showToast(`Set ${setNumber} updated to ${reps} reps`, 'success');
            }
        }

        // TAB SYSTEM FOR WORKOUT EXECUTION
        let currentActiveTab = 'execution'; // Track current tab

        function switchTab(tabName) {
            // Hide all tab panels
            document.querySelectorAll('.tab-panel').forEach(panel => {
                panel.classList.add('hidden');
            });
            
            // Show selected tab panel
            const selectedPanel = document.getElementById(`${tabName}TabContent`);
            if (selectedPanel) {
                selectedPanel.classList.remove('hidden');
            }
            
            // Update tab button states
            ['execTab', 'detailsTab', 'progressTab'].forEach(tabId => {
                const tab = document.getElementById(tabId);
                if (tab) {
                    if (tabId === `${tabName.substr(0, 4)}Tab` || 
                        (tabName === 'execution' && tabId === 'execTab') ||
                        (tabName === 'details' && tabId === 'detailsTab') ||
                        (tabName === 'progress' && tabId === 'progressTab')) {
                        tab.className = 'flex-1 px-3 py-2 text-sm font-medium rounded-md transition-colors bg-primary text-white';
                    } else {
                        tab.className = 'flex-1 px-3 py-2 text-sm font-medium rounded-md transition-colors text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200';
                    }
                }
            });
            
            currentActiveTab = tabName;
            
            // Update content for specific tabs
            if (tabName === 'details') {
                updateDetailsTabContent();
            } else if (tabName === 'progress') {
                updateProgressTabContent();
            }
        }

        function updateDetailsTabContent() {
            if (!currentExercise) return;
            
            // Update duplicate elements in details tab
            const elements = {
                'currentExerciseWeight2': formatWeight(currentExercise.weight),
                'currentExerciseReps2': currentExercise.targetReps,
                'currentExerciseSets2': currentExercise.sets,
                'currentExerciseRestTime2': `${Math.floor(currentExercise.restTime / 60)}min`
            };
            
            Object.keys(elements).forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = elements[id];
                }
            });
            
            // Update plate calculator for details tab
            updatePlateCalculationDetails(currentExercise.weight);
            
            // Update workout progress list for details tab
            updateWorkoutProgressListDetails();
        }

        function updatePlateCalculationDetails(weight) {
            const plateWeight = Math.max(0, weight - 20); // Subtract bar weight
            const plateBreakdown = calculatePlateBreakdown(plateWeight);
            
            const plateWeightEl = document.getElementById('plateWeight2');
            const totalCalculatedWeightEl = document.getElementById('totalCalculatedWeight2');
            const plateBreakdownEl = document.getElementById('plateBreakdown2');
            
            if (plateWeightEl) plateWeightEl.textContent = formatWeight(plateWeight, false);
            if (totalCalculatedWeightEl) totalCalculatedWeightEl.textContent = formatWeight(weight);
            
            if (plateBreakdownEl) {
                plateBreakdownEl.innerHTML = plateBreakdown.map(plate => 
                    `<span class="px-2 py-1 bg-blue-100 dark:bg-blue-800 text-blue-800 dark:text-blue-200 rounded text-xs">${plate}kg</span>`
                ).join('');
            }
        }

        function updateWorkoutProgressListDetails() {
            const progressList = document.getElementById('workoutProgressList2');
            if (!progressList) return;
            
            let html = '';
            
            workoutPlan.forEach((exercise, index) => {
                const isActive = index === currentExerciseIndex;
                const isComplete = index < currentExerciseIndex;
                
                let status = '';
                let statusClass = '';
                
                if (isComplete) {
                    status = '‚úÖ Complete';
                    statusClass = 'text-green-600 dark:text-green-400';
                } else if (isActive) {
                    const completedSets = currentSetData ? currentSetData.filter(reps => reps > 0).length : 0;
                    status = `üîÑ ${completedSets}/${exercise.sets} sets`;
                    statusClass = 'text-blue-600 dark:text-blue-400';
                } else {
                    status = '‚è≥ Waiting';
                    statusClass = 'text-gray-500 dark:text-gray-400';
                }
                
                html += `
                    <div class="flex justify-between items-center ${isActive ? 'font-bold' : ''}">
                        <span class="${isActive ? 'text-primary' : ''}">${exercise.name}</span>
                        <span class="${statusClass}">${status}</span>
                    </div>
                `;
            });
            
            progressList.innerHTML = html;
        }

        function updateProgressTabContent() {
            // Check if canvas element exists
            const canvas = document.getElementById('workoutTabProgressChart');
            if (!canvas) {
                console.warn('Workout tab progress chart canvas not found');
                return;
            }

            // Initialize charts when Progress tab is opened
            if (typeof Chart !== 'undefined' && workoutSessions.length > 0) {
                // Clean up any existing workout tab chart
                if (window.workoutTabChart) {
                    try {
                        window.workoutTabChart.destroy();
                    } catch (e) {
                        console.warn('Workout tab chart cleanup error:', e);
                    }
                    window.workoutTabChart = null;
                }

                // Initialize with weight progress chart after a short delay
                setTimeout(() => {
                    const canvasCheck = document.getElementById('workoutTabProgressChart');
                    if (canvasCheck) {
                        showWorkoutTabWeightChart();
                    }
                }, 100);
            } else if (workoutSessions.length === 0) {
                // Show message if no data
                const chartStats = document.getElementById('workoutTabChartStats');
                if (chartStats) {
                    chartStats.innerHTML = '<div class="col-span-2 text-center text-sm text-gray-500 dark:text-gray-400 p-4">Complete some workouts to see your progress charts!</div>';
                }
            }
        }

        // Workout Tab Chart Functions (separate from modal charts)
        function showWorkoutTabWeightChart() {
            showWorkoutTabChart('weight', 'workoutTabWeightBtn');
        }

        function showWorkoutTabVolumeChart() {
            showWorkoutTabChart('volume', 'workoutTabVolumeBtn');
        }

        function showWorkoutTabFrequencyChart() {
            showWorkoutTabChart('frequency', 'workoutTabFrequencyBtn');
        }

        function showWorkoutTabStrengthChart() {
            showWorkoutTabChart('strength', 'workoutTabStrengthBtn');
        }

        function showWorkoutTabChart(chartType, activeButtonId) {
            // Update button states
            ['workoutTabWeightBtn', 'workoutTabVolumeBtn', 'workoutTabFrequencyBtn', 'workoutTabStrengthBtn'].forEach(btnId => {
                const btn = document.getElementById(btnId);
                if (btn) {
                    if (btnId === activeButtonId) {
                        btn.className = 'px-3 py-1.5 bg-primary text-white rounded-lg hover:bg-primary/80 transition-colors text-xs font-medium';
                    } else {
                        btn.className = 'px-3 py-1.5 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors text-xs font-medium';
                    }
                }
            });

            const canvas = document.getElementById('workoutTabProgressChart');
            if (!canvas) {
                console.warn('Workout tab canvas not found');
                return;
            }

            // Clean up existing chart
            if (window.workoutTabChart) {
                try {
                    window.workoutTabChart.destroy();
                } catch (e) {
                    console.warn('Workout tab chart cleanup error:', e);
                }
                window.workoutTabChart = null;
            }

            if (typeof Chart === 'undefined') {
                showWorkoutTabFallback('Chart library not loaded');
                return;
            }

            if (workoutSessions.length === 0) {
                showWorkoutTabFallback('No workout data available yet. Complete some workouts to see your progress!');
                return;
            }

            const ctx = canvas.getContext('2d');

            try {
                let chartData, chartOptions;

                if (chartType === 'weight') {
                    const exerciseData = analyzeExerciseProgress();
                    if (Object.keys(exerciseData).length === 0) {
                        showWorkoutTabFallback('No workout data available yet.');
                        return;
                    }

                    const datasets = Object.keys(exerciseData).map((exercise, index) => {
                        const colors = ['#5D5CDE', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6'];
                        return {
                            label: exercise,
                            data: exerciseData[exercise],
                            borderColor: colors[index % colors.length],
                            backgroundColor: colors[index % colors.length] + '20',
                            tension: 0.3,
                            fill: false
                        };
                    });

                    chartData = { datasets };
                    chartOptions = {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { intersect: false, mode: 'index' },
                        plugins: {
                            legend: { position: 'top', labels: { boxWidth: 12, font: { size: 10 } } },
                            title: { display: true, text: 'Weight Progress Over Time', font: { size: 14 } },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.dataset.label + ': ' + context.parsed.y + ' kg';
                                    }
                                }
                            }
                        },
                        scales: {
                            x: { type: 'time', time: { unit: 'day', displayFormats: { day: 'MMM d' } }, title: { display: true, text: 'Date' } },
                            y: { beginAtZero: false, title: { display: true, text: 'Weight (kg)' } }
                        }
                    };
                } else if (chartType === 'volume') {
                    const volumeData = calculateVolumeData();
                    chartData = {
                        labels: volumeData.labels,
                        datasets: [{
                            label: 'Total Volume',
                            data: volumeData.data,
                            backgroundColor: '#10B981',
                            borderColor: '#059669',
                            borderWidth: 2
                        }]
                    };
                    chartOptions = {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            title: { display: true, text: 'Training Volume Over Time', font: { size: 14 } }
                        },
                        scales: {
                            y: { beginAtZero: true, title: { display: true, text: 'Volume (kg)' } }
                        }
                    };
                } else if (chartType === 'frequency') {
                    const frequencyData = calculateFrequencyData();
                    chartData = {
                        labels: frequencyData.labels,
                        datasets: [{
                            label: 'Workouts',
                            data: frequencyData.data,
                            backgroundColor: '#F59E0B',
                            borderColor: '#D97706',
                            borderWidth: 2
                        }]
                    };
                    chartOptions = {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            title: { display: true, text: 'Workout Frequency', font: { size: 14 } }
                        },
                        scales: {
                            y: { beginAtZero: true, ticks: { stepSize: 1 }, title: { display: true, text: 'Number of Workouts' } }
                        }
                    };
                } else if (chartType === 'strength') {
                    const strengthData = calculateStrengthScore();
                    chartData = {
                        labels: strengthData.labels,
                        datasets: [{
                            label: 'Strength Score',
                            data: strengthData.data,
                            borderColor: '#8B5CF6',
                            backgroundColor: '#8B5CF620',
                            fill: true,
                            tension: 0.3
                        }]
                    };
                    chartOptions = {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            title: { display: true, text: 'Overall Strength Progression', font: { size: 14 } }
                        },
                        scales: {
                            y: { beginAtZero: true, title: { display: true, text: 'Strength Score' } }
                        }
                    };
                }

                window.workoutTabChart = new Chart(ctx, {
                    type: chartType === 'weight' ? 'line' : (chartType === 'strength' ? 'line' : 'bar'),
                    data: chartData,
                    options: chartOptions
                });

                // Update stats
                updateWorkoutTabStats(chartType);

            } catch (error) {
                console.error('Error creating workout tab chart:', error);
                showWorkoutTabFallback('Error displaying chart: ' + error.message);
            }
        }

        function showWorkoutTabFallback(message) {
            const chartContainer = document.getElementById('workoutTabChartContainer');
            if (!chartContainer) return;

            chartContainer.innerHTML = `
                <div class="flex flex-col items-center justify-center h-full text-center py-8">
                    <div class="text-4xl mb-2">üìä</div>
                    <p class="text-sm text-gray-500 dark:text-gray-400 max-w-md px-4">${message}</p>
                </div>
            `;
        }

        function updateWorkoutTabStats(chartType) {
            const statsContainer = document.getElementById('workoutTabChartStats');
            if (!statsContainer) return;

            let statsHTML = '';

            if (chartType === 'weight') {
                const exerciseData = analyzeExerciseProgress();
                Object.keys(exerciseData).forEach(exercise => {
                    const weights = exerciseData[exercise].map(d => d.y);
                    const latestWeight = weights[weights.length - 1];
                    const firstWeight = weights[0];
                    const improvement = latestWeight - firstWeight;

                    statsHTML += `
                        <div class="bg-white dark:bg-gray-700 p-2 rounded-lg">
                            <div class="text-xs text-gray-500 dark:text-gray-400">${exercise}</div>
                            <div class="text-sm font-bold text-primary">${latestWeight} kg</div>
                            <div class="text-xs ${improvement >= 0 ? 'text-green-500' : 'text-red-500'}">
                                ${improvement >= 0 ? '+' : ''}${improvement} kg
                            </div>
                        </div>
                    `;
                });
            } else if (chartType === 'volume') {
                const volumeData = calculateVolumeData();
                const totalVolume = volumeData.data.reduce((a, b) => a + b, 0);
                const avgVolume = Math.round(totalVolume / volumeData.data.length);

                statsHTML = `
                    <div class="bg-white dark:bg-gray-700 p-2 rounded-lg">
                        <div class="text-xs text-gray-500 dark:text-gray-400">Total Volume</div>
                        <div class="text-sm font-bold text-green-600">${totalVolume} kg</div>
                    </div>
                    <div class="bg-white dark:bg-gray-700 p-2 rounded-lg">
                        <div class="text-xs text-gray-500 dark:text-gray-400">Avg per Workout</div>
                        <div class="text-sm font-bold text-green-600">${avgVolume} kg</div>
                    </div>
                `;
            } else if (chartType === 'frequency') {
                const frequencyData = calculateFrequencyData();
                const totalWorkouts = frequencyData.data.reduce((a, b) => a + b, 0);
                const weeksTracked = frequencyData.labels.length;

                statsHTML = `
                    <div class="bg-white dark:bg-gray-700 p-2 rounded-lg">
                        <div class="text-xs text-gray-500 dark:text-gray-400">Total Workouts</div>
                        <div class="text-sm font-bold text-orange-600">${totalWorkouts}</div>
                    </div>
                    <div class="bg-white dark:bg-gray-700 p-2 rounded-lg">
                        <div class="text-xs text-gray-500 dark:text-gray-400">Weeks Tracked</div>
                        <div class="text-sm font-bold text-orange-600">${weeksTracked}</div>
                    </div>
                `;
            } else if (chartType === 'strength') {
                const strengthData = calculateStrengthScore();
                const currentScore = strengthData.data[strengthData.data.length - 1];
                const firstScore = strengthData.data[0];
                const improvement = Math.round(((currentScore - firstScore) / firstScore) * 100);

                statsHTML = `
                    <div class="bg-white dark:bg-gray-700 p-2 rounded-lg">
                        <div class="text-xs text-gray-500 dark:text-gray-400">Current Strength</div>
                        <div class="text-sm font-bold text-purple-600">${Math.round(currentScore)}</div>
                    </div>
                    <div class="bg-white dark:bg-gray-700 p-2 rounded-lg">
                        <div class="text-xs text-gray-500 dark:text-gray-400">Improvement</div>
                        <div class="text-sm font-bold text-purple-600">${improvement}%</div>
                    </div>
                `;
            }

            statsContainer.innerHTML = statsHTML;
        }

        // Enhanced initialization with PWA support
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ DOM loaded - initializing PWA Lift Tracker...');
            console.log('üåê User Agent:', navigator.userAgent);
            console.log('üì± Standalone mode:', window.matchMedia('(display-mode: standalone)').matches);

            // Initialize IndexedDB first
            const dbInitialized = await initIndexedDB();
            if (dbInitialized) {
                console.log('üíæ IndexedDB initialized - will use for primary storage');
            } else {
                console.log('üíæ IndexedDB not available - using localStorage fallback');
            }

            // DIAGNOSTIC: Check what's actually in storage RIGHT NOW
            console.log('üîç DIAGNOSTIC: Checking storage contents...');
            if (isLocalStorageAvailable) {
                try {
                    // eslint-disable-next-line no-restricted-globals
                    const lsData = localStorage.getItem('workoutSessions');
                    if (lsData) {
                        console.log(`üì¶ FOUND data in localStorage: ${(lsData.length / 1024).toFixed(2)} KB`);
                        try {
                            const parsed = JSON.parse(lsData);
                            console.log(`üìä localStorage contains ${parsed.length} sessions`);
                        } catch (e) {
                            console.error('‚ùå Failed to parse localStorage data:', e);
                        }
                    } else {
                        console.log('üì¶ localStorage is empty (no workoutSessions key)');
                    }

                    // Check all localStorage keys
                    // eslint-disable-next-line no-restricted-globals
                    const allKeys = Object.keys(localStorage);
                    console.log(`üìã All localStorage keys (${allKeys.length}):`, allKeys);
                } catch (e) {
                    console.error('‚ùå Error checking localStorage:', e);
                }
            } else {
                console.error('‚ùå localStorage is NOT available');
            }

            // ALWAYS load saved workout sessions regardless of IndexedDB status
            // SafeStorage will automatically fall back to localStorage if IndexedDB failed
            const dataLoaded = await loadWorkoutSessions();
            if (dataLoaded) {
                console.log('‚úÖ Data loaded successfully from storage');
            } else {
                console.log('üìÇ No previous workout data found');
            }

            // Display motivational quote
            displayMotivationalQuote();

            // Initialize dark mode and settings first
            initializeDarkMode();
            await initializeWeightUnits();
            await initializeRestTimerSound();
            await loadWorkoutSettings();

            // Small delay to ensure DOM is ready, then update all UI with loaded data
            setTimeout(() => {
                console.log(`üîÑ Updating UI with ${workoutSessions.length} workout sessions...`);
                updateAllDataRelatedUI();

                // Log UI state after update
                console.log('‚úÖ UI update complete');

                // Verify elements are visible
                const quickStats = document.getElementById('quickStats');
                const exportBtn = document.getElementById('exportDataBtn');
                console.log('üìä Quick Stats visible:', quickStats && !quickStats.classList.contains('hidden'));
                console.log('üì• Export button visible:', exportBtn && !exportBtn.classList.contains('hidden'));
            }, 100);

            // Ensure we start at the top
            window.scrollTo(0, 0);

            // Setup startup features
            setTimeout(async () => {
                // Only show import prompt if no data was loaded from storage
                if (workoutSessions.length === 0) {
                    const hasSeenWelcome = await SafeStorage.getItem('hasSeenWelcome');
                    if (!hasSeenWelcome) {
                        await showStartupImportPrompt();
                    }
                }
                setupDragDropImport();
            }, 1500);

            // Add subtle loading animations
            setTimeout(() => {
                document.querySelectorAll('.workout-card').forEach((card, index) => {
                    if (card) {
                        card.style.animationDelay = `${index * 0.1}s`;
                    }
                });
            }, 100);

            // Show PWA install prompt banner if applicable
            if (isIndexedDBAvailable) {
                setTimeout(() => {
                    showPWAInstallBanner();
                }, 3000);
            }
        });

    </script>
</body>
</html>
